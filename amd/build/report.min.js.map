{"version":3,"file":"report.min.js","sources":["../src/report.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * Handle report page\n *\n * @module     mod_interactivevideo/report\n * @copyright  2024 Sokunthearith Makara <sokunthearithmakara@gmail.com>\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\nimport $ from 'jquery';\nimport Notification from 'core/notification';\nimport {add as addToast} from 'core/toast';\nimport JSZip from './libraries/jszip';\nimport './libraries/jquery.dataTables';\nimport './libraries/dataTables.bootstrap4';\nimport './libraries/dataTables.buttons';\nimport './libraries/buttons.bootstrap4';\nimport './libraries/buttons.html5';\nimport './libraries/buttons.colVis';\nimport './libraries/dataTables.select';\nimport './libraries/select.bootstrap4';\nimport './libraries/select2';\nimport quickform from './quickform';\n\n/**\n * Initializes the report functionality for the interactive video module.\n *\n * @param {number} cmid - The course module ID.\n * @param {number} groupid - The group ID.\n * @param {number} grademax - The maximum grade.\n * @param {Array} itemids - The annotation IDs.\n * @param {number} completionpercentage - The completion percentage.\n * @param {string} videourl - The video URL.\n * @param {string} videotype - The video type.\n * @param {Object} cm - The course module object.\n * @param {number} courseid - The course ID.\n * @param {number} start - The start time.\n * @param {number} end - The end time.\n * @param {Object} access - The access object.\n */\nconst init = (cmid, groupid, grademax, itemids, completionpercentage, videourl, videotype, cm, courseid, start, end, access) => {\n    window.JSZip = JSZip;\n    let DataTable = $.fn.dataTable;\n    let player;\n\n    quickform();\n\n    const getContentTypes = $.ajax({\n        url: M.cfg.wwwroot + '/mod/interactivevideo/ajax.php',\n        method: \"POST\",\n        dataType: \"text\",\n        data: {\n            action: 'get_all_contenttypes',\n            sesskey: M.cfg.sesskey,\n            contextid: M.cfg.contextid,\n        }\n    });\n\n    const getReportData = $.ajax({\n        url: M.cfg.wwwroot + '/mod/interactivevideo/ajax.php',\n        method: 'POST',\n        data: {\n            action: 'get_report_data_by_group',\n            cmid: cmid,\n            sesskey: M.cfg.sesskey,\n            contextid: M.cfg.contextid,\n            ctxid: M.cfg.courseContextId,\n            courseid: courseid,\n            groupid: groupid,\n        }\n    });\n\n    let itemsdata = $('#itemsdata').text();\n    itemsdata = JSON.parse(itemsdata);\n    // Init the contenttypes that has initonreport.\n    let initonreport = itemsdata.filter(x => JSON.parse(x.prop).initonreport);\n    initonreport = [...new Set(initonreport.map(x => x.type))];\n\n    let contentTypes;\n    let tabledata;\n\n    $.when(getContentTypes, getReportData).done(async(ct, data) => {\n        contentTypes = JSON.parse(ct[0]);\n        data = data[0];\n        const renderFilterBox = (element) => {\n            let input = '';\n            switch (element.type) {\n                case 'text':\n                case 'textarea':\n                case 'url':\n                case 'email':\n                    input = `<input type=\"text\" class=\"form-control form-control-sm\" id=\"filter-${element.index}\"\n                         data-index=\"${element.index}\"/>`;\n                    break;\n                case 'menu':\n                    var options = data.map(x => x[element.name]);\n                    options = [...new Set(options)];\n                    // Don't include empty options.\n                    options = options.filter(x => x !== '');\n                    if (options.length > 1) {\n                    options.sort();\n                    input = `<select class=\"custom-select custom-select-sm w-100\" multiple id=\"filter-${element.index}\"\n                         data-index=\"${element.index}\">\n                            ${options.map(x => `<option value=\"${x}\">${x}</option>`).join('')}\n                        </select>`;\n                    } else {\n                    input = `<input type=\"text\" class=\"form-control form-control-sm\" id=\"filter-${element.index}\"\n                         data-index=\"${element.index}\"/>`;\n                    }\n                    break;\n                case 'checkbox':\n                    var optionsc = data.map(x => x[element.name]);\n                    optionsc = [...new Set(optionsc)];\n                    // Don't include empty options.\n                    optionsc = optionsc.filter(x => x !== '');\n                    if (optionsc.length > 1) {\n                    optionsc.sort();\n                    input = `<select class=\"custom-select custom-select-sm w-100\" multiple id=\"filter-${element.index}\"\n                         data-index=\"${element.index}\">\n                            ${optionsc.map(x => `<option value=\"${x}\">${x}</option>`).join('')}\n                        </select>`;\n                    } else {\n                        input = `<input type=\"text\" class=\"form-control form-control-sm\" id=\"filter-${element.index}\"\n                         data-index=\"${element.index}\"/>`;\n                    }\n                    break;\n                case 'datetime':\n                    // Date range.\n                    input = `<div class=\"input-group input-group-sm\">\n                            <input type=\"date\" class=\"form-control custom-field\" data-index=\"${element.index}\"\n                             id=\"filter-${element.index}-start\"/>\n                            <input type=\"date\" class=\"form-control custom-field\" data-index=\"${element.index}\"\n                             id=\"filter-${element.index}-end\"/>\n                        </div>`;\n                    break;\n                default:\n                    input = `<input type=\"text\" class=\"form-control form-control-sm\" id=\"filter-${element.index}\"\n                         data-index=\"${element.index}\"/>`;\n                    break;\n            }\n            return `<div class=\"col-sm-6 col-md-4 col-lg-3 col-xl-${element.type == 'datetime' ? '4' : '2'} pl-0 pr-2 mb-2\">\n                                    <div class=\"form-group mb-1\">\n                                    <label for=\"filter-${element.index}\">${element.text}</label>\n                                        ${input}\n                                    </div>\n                                </div>`;\n        };\n        const hasCompletion = data.some(x => x.timecreated > 0);\n        let profileFields = [];\n        let customProfileFields = data.map(x => x.customfields);\n        // Combine all custom profile fields and remove duplicates.\n        customProfileFields = customProfileFields.reduce((acc, val) => {\n            return acc.concat(val);\n        }, []);\n        customProfileFields = [...new Set(customProfileFields)];\n        // Remove the undefined values.\n        customProfileFields = customProfileFields.filter(x => x !== undefined);\n        $(\"#completiontable th.profilefield\").each(function() {\n            const pr = {\n                index: $(\"th\").index($(this)),\n                text: $(this).text(),\n                name: $(this).attr('id'),\n                type: 'text'\n            };\n            if (customProfileFields && customProfileFields.length > 0) {\n                const customField = customProfileFields.find(x => x.shortname === pr.name.replace('profile_field_', ''));\n                if (customField) {\n                    pr.type = customField.type;\n                }\n            }\n            profileFields.push(pr);\n        });\n\n        let exportOptions = {\n            columns: ['.exportable'],\n            format: {\n                body: function(data) {\n                    // Strip HTML tags to get text only\n                    const div = document.createElement(\"div\");\n                    div.innerHTML = data;\n                    return (div.textContent || div.innerText || \"\").trim();\n                },\n                header: function(data) {\n                    const div = document.createElement(\"div\");\n                    div.innerHTML = data;\n                    // Remove .controls from the header.\n                    if (div.querySelector('.controls')) {\n                        div.querySelector('.controls').remove();\n                    }\n                    return (div.textContent || div.innerText || \"\").trim();\n                }\n            }\n        };\n\n        let columns = [\n            {\n                data: \"id\",\n                visible: false\n            },\n            {\n                data: \"picture\",\n                render: function(data, type, row) {\n                    if (type === 'sort') {\n                        return row.fullname;\n                    }\n                    let deletebutton = '';\n                    if (access.canedit == 1) {\n                        deletebutton = `<button title=\"${M.util.get_string('reset', 'mod_interactivevideo')}\"\n                 class=\"btn border-0 btn-sm text-danger reset m-1\" data-record=\"${row.completionid}\"\n                  data-userid=\"${row.id}\">\n                 <i class=\"bi bi-trash3\"></i></button>`;\n                    }\n                    // Put _target=blank to open the user profile in a new tab (use regex)\n                    data = data.replace(/<a /g, '<a target=\"_blank\" ');\n                    return `<div class=\"d-flex align-items-center\">\n                    ${access.canedit == 1 ? `<input class=\"mr-3\" type=\"checkbox\"\n                         data-record=\"${row.completionid}\" ${row.timecreated > 0 ? '' : 'disabled'}\n                         data-userid=\"${row.id}\"/>` : ''}\n                    <div class=\"text-truncate d-flex align-items-center justify-content-between flex-grow-1\">${data}\n                ${row.timecreated > 0 ? deletebutton : ''}</div></div>`;\n                },\n                className: \"bg-white sticky-left-0\",\n            },\n        ];\n\n        let $identitycolumn = $('#reporttable th.profilefield');\n        if ($identitycolumn.length > 0) {\n            $identitycolumn.each(function() {\n                let $this = $(this);\n                columns.push({\n                    data: $(this).attr('id'),\n                    render: function(data, type, row) {\n                        if (!row.customfields) {\n                            return data;\n                        }\n                        let fieldtype = row.customfields.find(x => x.shortname === $this.attr('id')\n                            .replace('profile_field_', ''));\n                        if (!fieldtype) {\n                            return data;\n                        }\n                        if (fieldtype.type === 'datetime' && (type == 'sort' || type == 'filter')) {\n                            return fieldtype.value;\n                        }\n                        return data;\n                    },\n                });\n            });\n        }\n\n        columns = columns.concat([\n            {\n                data: \"timecreated\",\n                \"render\": function(data, type) {\n                    if (!data || data == 0) {\n                        if (type === 'display') {\n                            return '';\n                        } else {\n                            return 0;\n                        }\n                    } else {\n                        const date = new Date(data * 1000);\n                        if (type === 'display') {\n                            return date.toLocaleString();\n                        } else if (type === 'filter' || type === 'sort') {\n                            return date.getTime();\n                        }\n                        return data;\n                    }\n                },\n                className: \"exportable timecreated\"\n            },\n            {\n                data: \"timecompleted\",\n                render: function(data, type, row) {\n                    if (!data || data == 0) {\n                        if (!row.timecreated) {\n                            if (type === 'display') {\n                                return '';\n                            } else {\n                                return 0;\n                            }\n                        } else {\n                            if (type === 'display') {\n                                return M.util.get_string('inprogress', 'mod_interactivevideo');\n                            } else {\n                                return 0;\n                            }\n                        }\n                    } else {\n                        const date = new Date(data * 1000);\n                        if (type === 'display') {\n                            return date.toLocaleString();\n                        } else if (type === 'filter' || type === 'sort') {\n                            return date.getTime();\n                        }\n                        return data;\n                    }\n                },\n                className: \"exportable\"\n            },\n            {\n                data: \"completionpercentage\",\n                render: function(data, type) {\n                    if (data) {\n                        return data + \"%\";\n                    } else {\n                        if (type === 'display') {\n                        return \"\";\n                        }\n                        return 0;\n                    }\n                },\n                className: \"exportable\"\n            },\n            {\n                data: \"xp\",\n                render: function(data) {\n                    if (data) {\n                        return data;\n                    } else {\n                        return \"\";\n                    }\n                },\n                className: \"exportable\"\n            }\n        ]);\n\n        let datatableOptions = {\n            \"data\": data,\n            \"deferRender\": true,\n            \"rowId\": \"id\",\n            \"pageLength\": 25,\n            // Sort by timecreated in descending order by default and then by fullname in ascending order.\n            \"order\": [[columns.findIndex(c => c.data == 'timecreated'), 'desc'], [1, 'asc']],\n            \"columns\": columns,\n            \"columnDefs\": [\n                {\n                    \"targets\": 'not-sortable',\n                    \"sortable\": false,\n                },\n                {\n                    \"targets\": 'inv',\n                    \"visible\": false,\n                },\n                {\n                    \"targets\": 'colvis',\n                    \"visible\": false,\n                }\n            ],\n            \"pagingType\": \"full\",\n            \"language\": {\n                \"lengthMenu\": \"_MENU_\",\n                \"zeroRecords\": M.util.get_string('nofound', \"mod_interactivevideo\"),\n                \"search\": `<span class=\"d-none d-md-inline\">${M.util.get_string('search', \"mod_interactivevideo\")}</span>`,\n                \"info\": M.util.get_string('datatableinfo', \"mod_interactivevideo\"),\n                \"infoEmpty\": M.util.get_string('datatableinfoempty', \"mod_interactivevideo\"),\n                \"infoFiltered\": M.util.get_string('datatableinfofiltered', \"mod_interactivevideo\"),\n                \"paginate\": {\n                    \"first\": '<i class=\"bi bi-chevron-double-left fs-unset\"></i>',\n                    \"last\": '<i class=\"bi bi-chevron-double-right fs-unset\"></i>',\n                    \"next\": '<i class=\"bi bi-chevron-right fs-unset\"></i>',\n                    \"previous\": '<i class=\"bi bi-chevron-left fs-unset\"></i>'\n                },\n                \"select\": {\n                    rows: {\n                        _: M.util.get_string('rowsselected', 'mod_interactivevideo'),\n                    }\n                }\n            },\n            select: {\n                style: 'multi',\n                selector: 'td:first-child input[type=\"checkbox\"]',\n            },\n            stateSaveParams: function(settings, data) {\n                // We only want to save the state of the colvis and length menu\n                data.search.search = \"\";\n                data.start = 0;\n                data.columns.forEach(function(column) {\n                    column.search.search = \"\";\n                });\n                return data;\n            },\n            stateSave: true,\n            \"dom\": `<'d-flex w-100 justify-content-between`\n                + `'<'d-flex align-items-center'Bl>'<''f>>`\n                + `<'#filterregion.w-100 row mx-0 my-2 p-3 bg-light rounded border'>t<'row mt-2'<'col-sm-6'i><'col-sm-6'p>>`,\n            \"buttons\": [\n                {\n                    extend: \"copyHtml5\",\n                    text: '<i class=\"bi bi-copy fa-fw fs-unset\"></i>',\n                    className: \"btn btn-sm border-0\",\n                    messageTop: null,\n                    title: null,\n                    exportOptions: exportOptions\n                },\n                {\n                    extend: \"csvHtml5\",\n                    text: '<i class=\"bi bi-filetype-csv fa-fw fs-unset\"></i>',\n                    className: \"btn btn-sm border-0\",\n                    exportOptions: exportOptions\n                },\n                {\n                    extend: \"excelHtml5\",\n                    text: '<i class=\"bi bi-file-earmark-excel fa-fw fs-unset\"></i>',\n                    className: \"btn btn-sm border-0\",\n                    exportOptions: exportOptions\n                },\n                {\n                    extend: \"colvis\",\n                    text: '<i class=\"bi bi-layout-three-columns fa-fw fs-unset\"></i>',\n                    titleAttr: \"\",\n                    className: \"btn btn-sm border-0\",\n                    columns: '.colvis'\n                },\n            ],\n            // New footerCallback to update footer with summary info\n            footerCallback: function() {\n                var api = this.api();\n                var rowCount = api.rows({filter: 'applied'}).count();\n                // Helper: find index of a column by its data property in our original columns array\n                /**\n                 * Find the index of the column in the original columns array.\n                 * @param {string} prop - The data property of the column.\n                 * @returns {number} - The index of the column in the original columns array.\n                 */\n                function findColIndex(prop) {\n                    return columns.findIndex(function(col) {\n                        return col.data === prop;\n                    });\n                }\n                var timecreatedIdx = findColIndex('timecreated');\n                var timecompletedIdx = findColIndex('timecompleted');\n                var completionpercentageIdx = findColIndex('completionpercentage');\n                var xpIdx = findColIndex('xp');\n\n                // Calculate percentage for timecreated > 0\n                var timecreatedData = api.column(timecreatedIdx, {filter: 'applied'}).data();\n                var countTimecreated = timecreatedData.reduce(function(acc, val) {\n                    return acc + ((val && val > 0) ? 1 : 0);\n                }, 0);\n                var timecreatedPerc = ((countTimecreated / rowCount) * 100).toFixed(1) + '%';\n                if (rowCount === 0) {\n                    timecreatedPerc = '0%';\n                }\n\n                // Calculate percentage for timecompleted > 0\n                var timecompletedData = api.column(timecompletedIdx, {filter: 'applied'}).data();\n                var countTimecompleted = timecompletedData.reduce(function(acc, val) {\n                    return acc + ((val && val > 0) ? 1 : 0);\n                }, 0);\n                var timecompletedPerc = ((countTimecompleted / rowCount) * 100).toFixed(1) + '%';\n                if (rowCount === 0) {\n                    timecompletedPerc = '0%';\n                }\n\n                // Average xp\n                var xpData = api.column(xpIdx, {filter: 'applied'}).data().toArray();\n                xpData = xpData.map(x => parseFloat(x) || 0);\n                var minXP = Math.min(...xpData);\n                var maxXP = Math.max(...xpData);\n                var sumXp = xpData.reduce(function(acc, val) {\n                    return acc + val;\n                }, 0);\n                var avgXp = (sumXp / rowCount).toFixed(1);\n                if (rowCount === 0) {\n                    avgXp = '0';\n                    minXP = '0';\n                    maxXP = '0';\n                }\n\n                // Average completion percentage\n                var cpData = api.column(completionpercentageIdx, {filter: 'applied'}).data().toArray();\n                cpData = cpData.map(x => parseFloat(x) || 0);\n                var minCp = Math.min(...cpData);\n                var maxCp = Math.max(...cpData);\n                var sumCp = cpData.reduce(function(acc, val) {\n                    return acc + val;\n                }, 0);\n                var avgCp = (sumCp / rowCount).toFixed(1) + '%';\n                if (rowCount === 0) {\n                    avgCp = '0%';\n                    minCp = '0';\n                    maxCp = '0';\n                }\n\n                // Update footer for these specific columns\n                if (api.column(timecreatedIdx).footer()) {\n                    api.column(timecreatedIdx).footer().innerHTML = '<small>' + M.util.get_string('started', 'mod_interactivevideo')\n                        + '</small>' + '<br>' + timecreatedPerc + ' (' + countTimecreated + '/' + rowCount + ')';\n                }\n                if (api.column(timecompletedIdx).footer()) {\n                    api.column(timecompletedIdx).footer().innerHTML = '<small>'\n                        + M.util.get_string('completed', 'mod_interactivevideo')\n                        + '</small>' + '<br>' + timecompletedPerc + ' (' + countTimecompleted + '/' + rowCount + ')';\n                }\n                if (api.column(xpIdx).footer()) {\n                    api.column(xpIdx).footer().innerHTML = '<small>' + M.util.get_string('avg', 'mod_interactivevideo')\n                        + ' (' + M.util.get_string('min', 'mod_interactivevideo') + '/' +\n                        M.util.get_string('max', 'mod_interactivevideo')\n                        + ')</small>' + '<br>' + avgXp + ' (' + minXP + '/' + maxXP + ')';\n                }\n                if (api.column(completionpercentageIdx).footer()) {\n                    api.column(completionpercentageIdx).footer().innerHTML\n                        = '<small>' + M.util.get_string('avg', 'mod_interactivevideo')\n                        + ' (' + M.util.get_string('min', 'mod_interactivevideo') + '/' +\n                        M.util.get_string('max', 'mod_interactivevideo')\n                        + ')</small>' + '<br>' + avgCp + ' (' + minCp + '/' + maxCp + ')';\n                }\n\n                // For dynamic interaction item columns: check header attribute 'data-item'.\n                columns.forEach(function(column) {\n                    if (column.itemid) {\n                        var itemid = column.itemid;\n                        var itemIdx = columns.findIndex(col => col.itemid === itemid);\n                        var itemData = api.column(itemIdx, {filter: 'applied'}).data();\n                        var countItem = itemData.reduce(function(acc, val) {\n                            let completiondetails;\n                            try {\n                                completiondetails = JSON.parse(val.completiondetails).map(x => JSON.parse(x));\n                            } catch (e) {\n                                return acc;\n                            }\n                            let details = completiondetails.find(x => Number(x.id) == Number(itemid));\n                            if (details) {\n                                if (details.deleted) {\n                                    return acc;\n                                }\n                                return acc + 1;\n                            }\n                            return acc;\n                        }, 0);\n                        var itemPerc = ((countItem / rowCount) * 100).toFixed(1) + '%';\n                        if (rowCount === 0) {\n                            itemPerc = '0%';\n                        }\n                        if (api.column(itemIdx).footer()) {\n                            api.column(itemIdx).footer().innerHTML = itemPerc;\n                        }\n                    }\n                });\n            },\n            // Modified initComplete to add a tfoot if missing\n            \"initComplete\": function() {\n                if (hasCompletion) {\n                    $(\"#completiontable th .controls\").removeClass(\"d-none\");\n                }\n                $(\"table#completiontable\")\n                    .wrap(\"<div style='overflow:auto;position:relative' class='completiontablewrapper my-2'></div>\");\n                $(\"#reporttable .dataTables_length \").addClass(\"d-inline ml-1\");\n                $(\"#reporttable .dataTables_filter\").addClass(\"d-inline float-right\");\n                $(\"#reporttable .table-responsive\").addClass(\"p-1\");\n                $(\"#reporttable .spinner-grow\").remove();\n                $(\"table#completiontable\").removeClass(\"d-none\");\n                $(\"#background-loading\").fadeOut(300);\n\n                $(`<a class=\"btn btn-sm btn-secondary font-weight-bold ml-1 d-inline-block\"\n                    href=\"javascript:void(0)\" id=\"filters\"\n                    title=\"Filter\"><i class=\"bi bi-funnel left fa-fw fs-unset\"></i></a>`).insertAfter(\".dataTables_filter label\");\n                $(document).off('click', '#filters').on('click', '#filters', function() {\n                    $('#filterregion').slideToggle('fast', 'swing');\n                    $(this).find('i').toggleClass('bi-funnel bi-funnel-fill');\n                });\n                $('#filterregion').css('display', 'none');\n\n                profileFields.forEach((element) => {\n                    $(renderFilterBox(element)).appendTo(\"#filterregion\");\n                });\n\n                // Init select2\n                $('#filterregion .custom-select[multiple]').select2({\n                    dropdownParent: $('body'), // Little hack to prevent page overflow when select2 is open\n                    width: '100%',\n                    placeholder: M.util.get_string('select', 'mod_interactivevideo'),\n                    allowClear: true,\n                });\n                $('.custom-select').on('select2:open', function(e) { // Little hack to prevent page overflow when select2 is open\n                    const evt = \"scroll.select2\";\n                    $(e.target).parents().off(evt);\n                    $(window).off(evt);\n                });\n\n                // Date range for timecreated.\n                $(\"#filterregion\").append(`<div class=\"col-sm-6 col-md-4 col-lg-3 col-xl-4 pl-0 pr-2 mb-2\">\n                    <div class=\"form-group mb-1\" id=\"timecreatedrange\">\n                    <label for=\"timecreatedrange\">${M.util.get_string('timecreatedrange', 'mod_interactivevideo')}</label>\n                    <div class=\"input-group input-group-sm\">\n                        <input type=\"date\" class=\"form-control\" id=\"timecreatedstart\"/>\n                        <input type=\"date\" class=\"form-control\" id=\"timecreatedend\"/>\n                    </div>\n                    </div>\n                </div>\n                <div class=\"col-sm-6 col-md-4 col-lg-3 col-xl-4 pl-0 pr-2 mb-2\">\n                    <div class=\"form-group mb-1\" id=\"timecompletedrange\">\n                    <label for=\"timecompletedrange\">${M.util.get_string('timecompletedrange', 'mod_interactivevideo')}</label>\n                    <div class=\"input-group input-group-sm\">\n                        <input type=\"date\" class=\"form-control\" id=\"timecompletedstart\"/>\n                        <input type=\"date\" class=\"form-control\" id=\"timecompletedend\"/>\n                    </div>\n                    </div>\n                </div>\n                `);\n\n                $(\"#filterregion\").append(`<div class=\"col-12 p-0 mx-0\">\n                    <span class=\"text-muted small\">${M.util.get_string('separatesearchtermsbyslash', 'mod_interactivevideo')}</span>\n                    </div>`);\n            }\n            // ...existing datatableOptions properties if any\n        };\n\n        $(\"#reporttable th.rotate\").each(function() {\n            const itemid = $(this).data(\"item\").toString();\n            const ctype = $(this).data(\"type\");\n            datatableOptions.columns.push({\n                data: null,\n                itemid: itemid,\n                sortable: false,\n                className: \"text-center exportable data-cell\",\n                render: function(data, rtype, row) {\n                    let completiondetails;\n                    try {\n                        completiondetails = JSON.parse(data.completiondetails).map(x => JSON.parse(x));\n                    } catch (e) {\n                        completiondetails = [];\n                    }\n                    let details = completiondetails.find(x => Number(x.id) == Number(itemid));\n                    if (details) {\n                        if (details.deleted) {\n                            if (rtype === 'display') {\n                                return `<i class=\"bi bi-trash3 text-muted\"\n                             title=\"${M.util.get_string('deletedbyinstructor', 'mod_interactivevideo')}\"></i>`;\n                            } else {\n                                return '-';\n                            }\n                        }\n                        let res = `<span class=\"completion-detail ${details.hasDetails ? 'cursor-pointer' : ''}\"\n                                 data-id=\"${itemid}\" data-userid=\"${row.id}\" data-type=\"${ctype}\">${details.reportView}</span>`;\n                        if (access.canedit == 1) {\n                            res += `<i class=\"bi bi-trash3 fs-unset text-danger cursor-pointer position-absolute delete-cell\"\n                                  title=\"${M.util.get_string('delete', 'mod_interactivevideo')}\"></i>`;\n                        }\n                        return res;\n                    } else {\n                        return '-';\n                    }\n                },\n                \"createdCell\": function(td) {\n                    $(td).attr(\"data-item\", itemid);\n                    $(td).attr(\"data-type\", ctype);\n                },\n            });\n        });\n\n        // Create the footer for the table.\n        let $tfoot = $('<tfoot></tfoot>');\n        let $tr = $('<tr></tr>');\n        columns.forEach(function(column) {\n            let $td = $('<td></td>');\n            if (column.data) {\n                $td.attr('id', column.data);\n            }\n            if (column.itemid) {\n                $td.attr('data-item', column.itemid);\n            }\n            $tr.append($td);\n        });\n        $tfoot.append($tr);\n        $('#completiontable').append($tfoot);\n\n        tabledata = $('#completiontable').DataTable(datatableOptions);\n\n        // Handle select.\n        tabledata.on(\"draw\", function() {\n            $('tr.selected td.checkbox input').prop(\"checked\", true);\n            $('tr:not(.selected) td.checkbox input').prop(\"checked\", false);\n        });\n\n        tabledata.on(\"search\", function() {\n            // De-select all rows\n            tabledata.rows().deselect();\n        });\n\n        tabledata.on(\"select deselect\", function(e) {\n            e.stopImmediatePropagation();\n            // Change the checkbox state\n            var selectedRows = tabledata.rows({selected: true});\n            // For each selected row, find the checkbox with class \"checked\" in the first column and check it\n            selectedRows.every(function() {\n                var row = this.node();\n                $(row).find(\"td:first-child input\").prop(\"checked\", true);\n            });\n\n            var deselectedRows = tabledata.rows({selected: false});\n            // For each deselected row, find the checkbox with class \"checked\" in the first column and uncheck it\n            deselectedRows.every(function() {\n                var row = this.node();\n                $(row).find(\"td:first-child input\").prop(\"checked\", false);\n            });\n\n            // Allow 20 rows to be selected at once.\n            $('#bulkactions').remove();\n\n            if (selectedRows.count() > 0 && selectedRows.count() <= 20) {\n                // Insert the bulk actions\n                $('#completiontable_length').after(`<div class=\"d-flex align-items-center\" id=\"bulkactions\">\n                    <button class=\"btn btn-sm btn-danger ml-1\" id=\"bulkdelete\">\n                        <i class=\"bi bi-trash3 mr-1 fs-unset\"></i>${M.util.get_string('delete', 'mod_interactivevideo')}\n                         (${selectedRows.count()})\n                    </button>\n                    </div>`);\n            }\n        });\n\n        $('#filterregion :input:not([type=date])').on('keyup change', function() {\n            let index = $(this).data('index');\n            let value = $(this).val();\n            if (typeof value !== 'string') {\n                value = value.join('|');\n            }\n            // Split the input by '|' and remove any empty terms.\n            let regex = value.split('|').map(term => term.trim()).filter(term => term.length > 0).join('|');\n            // Use regex mode (true) and disable smart searching (false).\n            tabledata.column(index).search(regex, true, false).draw();\n        });\n\n        $('#filterregion :input[type=date].custom-field').on('change', function() {\n            let index = $(this).data('index');\n            $.fn.dataTable.ext.search.push(function(settings, data) {\n                if (settings.nTable.id !== 'completiontable') {\n                    return true;\n                }\n                let start = $(`#filter-${index}-start`).val();\n                if (start !== '') {\n                    // Append the start of the day to the date.\n                    start = new Date(start);\n                    start.setHours(0, 0, 0);\n                }\n                let end = $(`#filter-${index}-end`).val();\n                if (end !== '') {\n                    // Append the end of the day to the date.\n                    end = new Date(end);\n                    end.setHours(23, 59, 59);\n                }\n                let value = data[index];\n                if (isNaN(value) || value == '') {\n                    value = 0;\n                }\n                value = value * 1000;\n                if ((start !== '' || end !== '') && value == 0) {\n                    return false;\n                }\n                if ((start === '' && end === '')\n                    || (start === '' && value <= new Date(end).getTime())\n                    || (end === '' && value >= new Date(start).getTime())\n                    || (value >= new Date(start).getTime() && value <= new Date(end).getTime())) {\n                    return true;\n                }\n                return false;\n            });\n            tabledata.draw();\n        });\n\n        $('#reporttable th#timecreated input').on('click', function(e) {\n            e.stopPropagation();\n            let index = columns.findIndex(x => x.data === 'timecreated');\n            let started = $('th#timecreated input[data-start=true]').is(':checked');\n            let notstarted = $('th#timecreated input[data-start=false]').is(':checked');\n            if (started && notstarted) {\n                tabledata.column(index).search('', true, false).draw();\n            } else if (started) {\n                // Filter by timecreated that is not 0.\n                tabledata.column(index).search('^(?!0$)', true, false).draw();\n            } else if (notstarted) {\n                // Filter by timecreated that is 0.\n                tabledata.column(index).search('^0$', true, false).draw();\n            } else {\n                tabledata.column(index).search('-', true, false).draw();\n            }\n        });\n\n        $('#reporttable th#timecompleted input').on('click', function(e) {\n            e.stopPropagation();\n            let index = columns.findIndex(x => x.data === 'timecompleted');\n            let inprogress = $('th#timecompleted input[data-completed=false]').is(':checked');\n            let completed = $('th#timecompleted input[data-completed=true]').is(':checked');\n            if (inprogress && completed) {\n                tabledata.column(index).search('', true, false).draw();\n            } else if (inprogress) {\n                // Filter by timecompleted that is 0.\n                tabledata.column(index).search('^0$', true, false).draw();\n            } else if (completed) {\n                // Filter by timecompleted that is not 0.\n                tabledata.column(index).search('^(?!0$)', true, false).draw();\n            } else {\n                tabledata.column(index).search('-', true, false).draw();\n            }\n        });\n\n        $('#reporttable th[data-type] input').on('click', function(e) {\n            e.stopPropagation();\n            let index = columns.findIndex(x => x.itemid == $(this).data('item'));\n            if ($(this).is(':checked')) {\n                // Filter this column by not equal to -.\n                tabledata.column(index).search('^(?!-$)', true, false).draw();\n            } else {\n                tabledata.column(index).search('', true, false).draw();\n            }\n        });\n\n        $('#reporttable th#completionpercentage input').on('click', function(e) {\n            e.stopPropagation();\n            let $this = $(this);\n            $.fn.dataTable.ext.search.push(function(settings, data) {\n                if (settings.nTable.id !== 'completiontable') {\n                    return true;\n                }\n                let index = columns.findIndex(x => x.data === 'completionpercentage');\n                let percent = $this.data('percentage');\n                let showless = $('th#completionpercentage input.less').is(':checked');\n                let showmore = $('th#completionpercentage input.more').is(':checked');\n                let value = data[index];\n                value = parseInt(value.replace('%', ''));\n                if (showless && showmore) {\n                    return true;\n                } else if (showless) {\n                    return value < percent;\n                } else if (showmore) {\n                    return value >= percent;\n                } else {\n                    return false;\n                }\n            });\n            tabledata.draw();\n        });\n\n        // Filter by timecreated range.\n        $('#filterregion #timecreatedrange input').on('change', function() {\n            $.fn.dataTable.ext.search.push(function(settings, data) {\n                if (settings.nTable.id !== 'completiontable') {\n                    return true;\n                }\n                let start = $('#timecreatedstart').val();\n                if (start !== '') {\n                    // Append the start of the day to the date.\n                    start = new Date(start);\n                    start.setHours(0, 0, 0);\n                }\n                let end = $('#timecreatedend').val();\n                if (end !== '') {\n                    // Append the end of the day to the date.\n                    end = new Date(end);\n                    end.setHours(23, 59, 59);\n                }\n                let index = columns.findIndex(x => x.data === 'timecreated');\n                let value = data[index];\n                if ((start !== '' || end !== '') && value == 0) {\n                    return false;\n                }\n                if ((start === '' && end === '')\n                    || (start === '' && value <= new Date(end).getTime())\n                    || (end === '' && value >= new Date(start).getTime())\n                    || (value >= new Date(start).getTime() && value <= new Date(end).getTime())) {\n                    return true;\n                }\n                return false;\n            }\n            );\n            tabledata.draw();\n        });\n\n        // Filter by timecompleted range.\n        $('#filterregion #timecompletedrange input').on('change', function() {\n            $.fn.dataTable.ext.search.push(function(settings, data) {\n                if (settings.nTable.id !== 'completiontable') {\n                    return true;\n                }\n                let start = $('#timecompletedstart').val();\n                if (start !== '') {\n                    // Append the start of the day to the date.\n                    start = new Date(start);\n                    start.setHours(0, 0, 0);\n                }\n                let end = $('#timecompletedend').val();\n                if (end !== '') {\n                    // Append the end of the day to the date.\n                    end = new Date(end);\n                    end.setHours(23, 59, 59);\n                }\n                let index = columns.findIndex(x => x.data === 'timecompleted');\n                let value = data[index];\n                if ((start !== '' || end !== '') && value == 0) {\n                    return false;\n                }\n                if ((start === '' && end === '')\n                    || (start === '' && value <= new Date(end).getTime())\n                    || (end === '' && value >= new Date(start).getTime())\n                    || (value >= new Date(start).getTime() && value <= new Date(end).getTime())) {\n                    return true;\n                }\n                return false;\n            }\n            );\n            tabledata.draw();\n        });\n\n        // Right-click on data-cell to delete completion data for specific user and specific item.\n        $(document).on('click', 'td.data-cell .delete-cell', function(e) {\n            e.preventDefault();\n            if (access.canedit != 1) {\n                return;\n            }\n            let $this = $(this).closest('td');\n            let itemid = $this.data('item');\n            if ($this.text() === '-' || $this.text() === '') {\n                return;\n            }\n            let userid = $this.closest('tr').attr('id');\n            let userfullname = $this.closest('tr').find('td').eq(0).text();\n            let recordid = $this.closest('tr').find('td').eq(0).find('button').data('record');\n            let cellIndex = $this.index();\n            let title = $this.closest('table').find('th').eq(cellIndex).text();\n\n            const deleteCompletionData = async() => {\n                let type = $this.data('type');\n                let matchingContentTypes = contentTypes.find(x => x.name === type);\n                let amdmodule = matchingContentTypes.amdmodule;\n                let theAnnotation = itemsdata.find(x => x.id == itemid);\n                require([amdmodule], function(Module) {\n                    const module = new Module(player, itemsdata, cmid, courseid, null,\n                        completionpercentage, null, grademax, videotype, null,\n                        end - start, start, end, theAnnotation.prop, cm);\n                    if (module.deleteCompletionData(recordid, itemid, userid)) {\n                        let targetdata = tabledata.row($this.closest('tr')).data();\n                        targetdata.completeditems = JSON.stringify(\n                            JSON.parse(targetdata.completeditems).filter(x => x.id != itemid));\n                        let completiondetails = JSON.parse(targetdata.completiondetails);\n                        completiondetails = completiondetails.map(x => {\n                            x = JSON.parse(x);\n                            if (x.id == itemid) {\n                                x.hasDetails = true;\n                                x.deleted = true;\n                                x.reportView = '<i class=\"bi bi-trash3 text-danger\"></i>';\n                            }\n                            return JSON.stringify(x);\n                        });\n                        targetdata.completiondetails = JSON.stringify(completiondetails);\n                        tabledata.row($this.closest('tr')).data(targetdata).draw();\n                        addToast(M.util.get_string('completedeletedforthisitem', 'mod_interactivevideo', {\n                            item: title,\n                            user: userfullname\n                        }), {\n                            type: 'success'\n                        });\n                    } else {\n                        addToast(M.util.get_string('completionreseterror', 'mod_interactivevideo'), {\n                            type: 'error'\n                        });\n                    }\n                });\n            };\n\n            try {\n                Notification.deleteCancelPromise(\n                    M.util.get_string('deletecompletion', 'mod_interactivevideo'),\n                    M.util.get_string('deleterecordforitemforuserconfirm', 'mod_interactivevideo', {\n                        item: title,\n                        user: userfullname\n                    }),\n                    M.util.get_string('delete', 'mod_interactivevideo')\n                ).then(async() => {\n                    return deleteCompletionData();\n                }).catch(() => {\n                    return;\n                });\n            } catch { // Fallback for older versions of Moodle.\n                Notification.saveCancel(\n                    M.util.get_string('deletecompletion', 'mod_interactivevideo'),\n                    M.util.get_string('deleterecordforitemforuserconfirm', 'mod_interactivevideo', {\n                        item: title,\n                        user: userfullname\n                    }),\n                    M.util.get_string('delete', 'mod_interactivevideo'),\n                    function() {\n                        return deleteCompletionData();\n                    }\n                );\n            }\n        });\n\n        initonreport.forEach((type) => {\n            let matchingContentTypes = contentTypes.find(x => x.name === type);\n            let amdmodule = matchingContentTypes.amdmodule;\n            require([amdmodule], function(Module) {\n                new Module(player, itemsdata, cmid, courseid, null,\n                    completionpercentage, null, grademax, videotype, null,\n                    end - start, start, end, null, cm).init();\n            });\n        });\n    });\n\n    $(document).on('click', '[data-item] a', function() {\n        const convertSecondsToHMS = (seconds) => {\n            const h = Math.floor(seconds / 3600);\n            const m = Math.floor(seconds % 3600 / 60);\n            const s = Math.floor(seconds % 3600 % 60);\n            return (h > 0 ? h + ':' : '') + (m < 10 ? '0' : '') + m + ':' + (s < 10 ? '0' : '') + s;\n        };\n        let annotationid = $(this).closest('th').data('item');\n        let theAnnotation = itemsdata.find(x => x.id == annotationid);\n        let tabledatajson = tabledata.rows().data().toArray();\n        let title = theAnnotation.formattedtitle;\n        if (theAnnotation.timestamp > 0) {\n            title += \" @ \" + convertSecondsToHMS(theAnnotation.timestamp);\n        }\n        const modal = `<div class=\"modal fade\" id=\"annotation-modal\" role=\"dialog\"\n            aria-labelledby=\"annotation-modal\"\n         aria-hidden=\"true\" data-backdrop=\"static\" data-keyboard=\"false\">\n         <div id=\"message\" data-id=\"${theAnnotation.id}\" data-placement=\"popup\"\n          class=\"modal-dialog modal-xl modal-dialog-centered modal-dialog-scrollable ${theAnnotation.type}\" role=\"document\">\n            <div class=\"modal-content rounded-lg\">\n                <div class=\"modal-header d-flex align-items-center shadow-sm\" id=\"title\">\n                    <h5 class=\"modal-title text-truncate mb-0\">${title}</h5>\n                    <div class=\"btns d-flex align-items-center\">\n                        <button class=\"btn close-modal p-0 border-0\" aria-label=\"Close\" data-dismiss=\"modal\">\n                        <i class=\"bi bi-x-lg fa-fw fs-25px\"></i>\n                        </button>\n                    </div>\n                </div>\n                <div class=\"modal-body\" id=\"content\">\n                <div class=\"loader w-100 mt-5\"></div>\n                </div>\n                </div>\n            </div>\n            </div>`;\n        $('body').append(modal);\n        $('#annotation-modal').modal('show');\n        $('#annotation-modal').on('hide.bs.modal', function() {\n            $('#annotation-modal').remove();\n        });\n\n        $('#annotation-modal').on('shown.bs.modal', function() {\n            $('#annotation-modal .modal-body').fadeIn(300);\n            let matchingContentTypes = contentTypes.find(x => x.name === theAnnotation.type);\n            let amdmodule = matchingContentTypes.amdmodule;\n            require([amdmodule], function(Module) {\n                theAnnotation.completed = true;\n                new Module(player, itemsdata, cmid, courseid, null,\n                    completionpercentage, null, grademax, videotype, null,\n                    end - start, start, end, theAnnotation.prop, cm).displayReportView(theAnnotation, tabledatajson, DataTable);\n            });\n            $(this).find('.close-modal').focus();\n        });\n    });\n\n    // Delete single completion record.\n    $(document).on('click', 'td .reset', function(e) {\n        e.preventDefault();\n        const recordid = $(this).data('record');\n        let $this = $(this);\n        const deleteSingle = async() => {\n            return $.ajax({\n                url: M.cfg.wwwroot + '/mod/interactivevideo/ajax.php',\n                method: 'POST',\n                dataType: \"text\",\n                data: {\n                    action: 'delete_progress_by_id',\n                    recordid,\n                    courseid: courseid,\n                    cmid: cmid,\n                    contextid: M.cfg.contextid,\n                    sesskey: M.cfg.sesskey,\n                },\n                success: function(response) {\n                    if (response == 'deleted') {\n                        let targetdata = tabledata.row($this.closest('tr')).data();\n                        targetdata.completionpercentage = 0;\n                        targetdata.timecompleted = 0;\n                        targetdata.xp = 0;\n                        targetdata.timecreated = 0;\n                        targetdata.completeditems = null;\n                        targetdata.completiondetails = null;\n                        targetdata.completionid = null;\n                        tabledata.row($this.closest('tr')).data(targetdata).draw();\n                        addToast(M.util.get_string('completionresetsuccess', 'mod_interactivevideo'), {\n                            type: 'success'\n                        });\n                    }\n                },\n                error: function() {\n                    addToast(M.util.get_string('completionreseterror', 'mod_interactivevideo'), {\n                        type: 'error'\n                    });\n                }\n            });\n        };\n        try {\n            Notification.deleteCancelPromise(\n                M.util.get_string('deletecompletion', 'mod_interactivevideo'),\n                M.util.get_string('areyousureyouwanttoresetthecompletiondata', 'mod_interactivevideo'),\n                M.util.get_string('delete', 'mod_interactivevideo')\n            ).then(() => {\n                return deleteSingle();\n            }).catch(() => {\n                return;\n            });\n        } catch { // Fallback for older versions of Moodle.\n            Notification.saveCancel(\n                M.util.get_string('deletecompletion', 'mod_interactivevideo'),\n                M.util.get_string('areyousureyouwanttoresetthecompletiondata', 'mod_interactivevideo'),\n                M.util.get_string('delete', 'mod_interactivevideo'),\n                function() {\n                    return deleteSingle();\n                }\n            );\n        }\n    });\n\n    // Delete multiple completion records.\n    $(document).on('click', '#bulkdelete', function() {\n        let selectedRows = tabledata.rows({selected: true});\n        let selectedData = selectedRows.data().toArray();\n        let selectedIds = selectedData.map(x => x.completionid);\n        let selectedUsers = selectedData.map(x => x.id);\n        const bulkDeleteCompletionData = async() => {\n            return $.ajax({\n                url: M.cfg.wwwroot + '/mod/interactivevideo/ajax.php',\n                method: 'POST',\n                dataType: \"text\",\n                data: {\n                    action: 'delete_progress_by_ids',\n                    completionids: selectedIds.join(','),\n                    courseid: courseid,\n                    cmid: cmid,\n                    contextid: M.cfg.contextid,\n                    sesskey: M.cfg.sesskey,\n                },\n                success: function(response) {\n                    if (response == 'deleted') {\n                        selectedRows.every(function() {\n                            let targetdata = this.data();\n                            targetdata.completionpercentage = 0;\n                            targetdata.timecompleted = 0;\n                            targetdata.xp = 0;\n                            targetdata.timecreated = 0;\n                            targetdata.completeditems = null;\n                            targetdata.completiondetails = null;\n                            targetdata.completionid = null;\n                            tabledata.row(this.node()).data(targetdata);\n                        });\n                        tabledata.draw();\n                        addToast(M.util.get_string('completionresetsuccess', 'mod_interactivevideo'), {\n                            type: 'success'\n                        });\n                    }\n                },\n                error: function() {\n                    addToast(M.util.get_string('completionreseterror', 'mod_interactivevideo'), {\n                        type: 'error'\n                    });\n                }\n            });\n        };\n        try {\n            Notification.deleteCancelPromise(\n                M.util.get_string('deletecompletion', 'mod_interactivevideo'),\n                M.util.get_string('deleterecordforselectedusers', 'mod_interactivevideo', selectedUsers.length),\n                M.util.get_string('delete', 'mod_interactivevideo')\n            ).then(async() => {\n                return bulkDeleteCompletionData();\n            }).catch(() => {\n                return;\n            });\n        } catch { // Fallback for older versions of Moodle.\n            Notification.saveCancel(\n                M.util.get_string('deletecompletion', 'mod_interactivevideo'),\n                M.util.get_string('deleterecordforselectedusers', 'mod_interactivevideo', selectedUsers.length),\n                M.util.get_string('delete', 'mod_interactivevideo'),\n                function() {\n                    return bulkDeleteCompletionData();\n                }\n            );\n        }\n    });\n\n    $(document).on('click', 'td .completion-detail', function() {\n        let id = $(this).data('id');\n        let userid = $(this).data('userid');\n        let type = $(this).data('type');\n        let matchingContentTypes = contentTypes.find(x => x.name === type);\n        let amdmodule = matchingContentTypes.amdmodule;\n        // Get column header with the item id.\n        let theAnnotation = itemsdata.find(x => x.id == id);\n        require([amdmodule], function(Module) {\n            new Module(player, itemsdata, cmid, courseid, null,\n                completionpercentage, null, grademax, videotype, null,\n                end - start, start, end, theAnnotation.prop, cm).getCompletionData(theAnnotation, userid);\n        });\n    });\n};\n\n\n/**\n * Renders annotation logs in a DataTable with specified options.\n *\n * @param {Object} data - The data to be displayed in the table.\n * @param {Array} data.rows - The rows of data to be displayed.\n * @param {string} node - The DOM node selector where the table will be rendered.\n * @param {string} title - The title used for export options.\n */\nconst renderAnnotationLogs = (data, node, title) => {\n    let tableOptions = {\n        \"data\": data.rows,\n        \"deferRender\": true,\n        \"pageLength\": 25,\n        \"order\": [[0, \"asc\"]],\n        \"columnDefs\": [\n            {\n                \"targets\": 'not-sortable',\n                \"sortable\": false,\n            },\n        ],\n        \"pagingType\": \"full\",\n        \"language\": {\n            \"lengthMenu\": \"_MENU_\",\n            \"zeroRecords\": M.util.get_string('nofound', \"mod_interactivevideo\"),\n            \"search\": `<span class=\"d-none d-md-inline\">${M.util.get_string('search', \"mod_interactivevideo\")}</span>`,\n            \"info\": M.util.get_string('datatableinfo', \"mod_interactivevideo\"),\n            \"infoEmpty\": M.util.get_string('datatableinfoempty', \"mod_interactivevideo\"),\n            \"infoFiltered\": M.util.get_string('datatableinfofiltered', \"mod_interactivevideo\"),\n            \"paginate\": {\n                \"first\": '<i class=\"bi bi-chevron-double-left fs-unset\"></i>',\n                \"last\": '<i class=\"bi bi-chevron-double-right fs-unset\"></i>',\n                \"next\": '<i class=\"bi bi-chevron-right fs-unset\"></i>',\n                \"previous\": '<i class=\"bi bi-chevron-left fs-unset\"></i>'\n            },\n            \"select\": {\n                rows: {\n                    _: M.util.get_string('rowsselected', 'mod_interactivevideo'),\n                }\n            }\n        },\n        stateSaveParams: function(settings, data) {\n            // We only want to save the state of the colvis and length menu\n            data.search.search = \"\";\n            data.start = 0;\n            data.columns.forEach(function(column) {\n                column.search.search = \"\";\n            });\n            return data;\n        },\n        stateSave: true,\n        \"dom\": `Blft<'row'<'col-sm-6'i><'col-sm-6'p>>`,\n        \"buttons\": [\n            {\n                extend: \"copyHtml5\",\n                text: '<i class=\"bi bi-copy fa-fw fs-unset\"></i>',\n                className: \"btn btn-sm border-0\",\n                messageTop: null,\n                title: null,\n                exportOptions: {\n                    columns: ['.exportable'],\n                    format: {\n                        body: function(data) {\n                            // Remove any HTML tags from the data.\n                            const text = document.createElement(\"div\");\n                            text.innerHTML = data;\n                            return text.textContent.replace(/\\n/g, ' ').replace(/\\t/g, ' ').replace(/\\r/g, ' ');\n                        }\n                    }\n                }\n            },\n            {\n                extend: \"csvHtml5\",\n                text: '<i class=\"bi bi-filetype-csv fa-fw fs-unset\"></i>',\n                title: title,\n                className: \"btn btn-sm border-0\",\n                exportOptions: {\n                    columns: ['.exportable']\n                }\n            },\n            {\n                extend: \"excelHtml5\",\n                text: '<i class=\"bi bi-file-earmark-excel fa-fw fs-unset\"></i>',\n                className: \"btn btn-sm border-0\",\n                title: title,\n                exportOptions: {\n                    columns: ['.exportable']\n                }\n            }\n        ],\n        \"initComplete\": function() {\n            $(`${node} table`)\n                .wrap(\"<div style='overflow:auto;position:relative;width:100%' class='completiontablewrapper'></div>\");\n            $(`${node} .dataTables_length`).addClass(\"d-inline ml-1\");\n            $(`${node} .dataTables_filter`).addClass(\"d-inline float-right\");\n            $(`${node} .table-responsive`).addClass(\"p-1\");\n        }\n    };\n\n    $(`${node} table`).DataTable(tableOptions);\n};\n\nexport {\n    init,\n    renderAnnotationLogs\n};"],"names":["cmid","groupid","grademax","itemids","completionpercentage","videourl","videotype","cm","courseid","start","end","access","window","JSZip","DataTable","$","fn","dataTable","getContentTypes","ajax","url","M","cfg","wwwroot","method","dataType","data","action","sesskey","contextid","getReportData","ctxid","courseContextId","itemsdata","text","JSON","parse","contentTypes","tabledata","initonreport","filter","x","prop","Set","map","type","when","done","async","ct","hasCompletion","some","timecreated","profileFields","customProfileFields","customfields","reduce","acc","val","concat","undefined","each","pr","index","this","name","attr","length","customField","find","shortname","replace","push","exportOptions","columns","format","body","div","document","createElement","innerHTML","textContent","innerText","trim","header","querySelector","remove","visible","render","row","fullname","deletebutton","canedit","util","get_string","completionid","id","className","$identitycolumn","$this","fieldtype","value","date","Date","toLocaleString","getTime","datatableOptions","findIndex","c","rows","_","select","style","selector","stateSaveParams","settings","search","forEach","column","stateSave","extend","messageTop","title","titleAttr","footerCallback","api","rowCount","count","findColIndex","col","timecreatedIdx","timecompletedIdx","completionpercentageIdx","xpIdx","countTimecreated","timecreatedPerc","toFixed","countTimecompleted","timecompletedPerc","xpData","toArray","parseFloat","minXP","Math","min","maxXP","max","avgXp","cpData","minCp","maxCp","avgCp","footer","itemid","itemIdx","itemPerc","completiondetails","e","details","Number","deleted","removeClass","wrap","addClass","fadeOut","insertAfter","off","on","slideToggle","toggleClass","css","element","input","options","sort","join","optionsc","renderFilterBox","appendTo","select2","dropdownParent","width","placeholder","allowClear","evt","target","parents","append","toString","ctype","sortable","rtype","res","hasDetails","reportView","td","$tfoot","$tr","$td","deselect","stopImmediatePropagation","selectedRows","selected","every","node","after","regex","split","term","draw","ext","nTable","setHours","isNaN","stopPropagation","started","is","notstarted","inprogress","completed","percent","showless","showmore","parseInt","preventDefault","closest","userid","userfullname","eq","recordid","cellIndex","deleteCompletionData","amdmodule","theAnnotation","require","Module","player","targetdata","completeditems","stringify","item","user","deleteCancelPromise","then","catch","saveCancel","init","annotationid","tabledatajson","formattedtitle","timestamp","seconds","h","floor","m","s","convertSecondsToHMS","modal","fadeIn","displayReportView","focus","deleteSingle","success","response","timecompleted","xp","error","selectedData","selectedIds","selectedUsers","bulkDeleteCompletionData","completionids","getCompletionData","tableOptions"],"mappings":"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"}