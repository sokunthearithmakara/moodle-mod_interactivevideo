define("mod_interactivevideo/player/spotify",["exports","core/event_dispatcher","jquery","mod_interactivevideo/player/checkautoplay"],(function(_exports,_event_dispatcher,_jquery,_checkautoplay){function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj}}
/**
   * Spotify Player class
   *
   * @module     mod_interactivevideo/player/spotify
   * @copyright  2024 Sokunthearith Makara <sokunthearithmakara@gmail.com>
   * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
   */Object.defineProperty(_exports,"__esModule",{value:!0}),_exports.default=void 0,_jquery=_interopRequireDefault(_jquery),_checkautoplay=_interopRequireDefault(_checkautoplay);var _default=class{constructor(){this.type="spotify",this.frequency=1.2,this.support={playbackrate:!1,quality:!1,password:!1},this.useAnimationFrame=!1,(0,_jquery.default)("#controller #mute").remove()}async load(url,start,end){let opts=arguments.length>3&&void 0!==arguments[3]?arguments[3]:{};const node=opts.node||"player";this.node=node,this.allowAutoplay=await(0,_checkautoplay.default)(document.getElementById(node)),this.allowAutoplay||(0,_event_dispatcher.dispatchEvent)("iv:autoplayBlocked"),this.start=start,this.end=end;let match=/(?:https?:\/\/)?(?:open\.spotify\.com)\/(episode|track)\/([^/]+)/.exec(url),videoId=match[2],type=match[1];videoId=videoId.split("?")[0],this.videoId=videoId;let self=this;(0,_jquery.default)(".video-block, #start-screen").remove(),(0,_jquery.default)("#annotation-canvas").removeClass("d-none");if(opts.editform){const data=await _jquery.default.ajax({url:M.cfg.wwwroot+"/mod/interactivevideo/ajax.php",type:"POST",dataType:"text",data:{action:"get_from_url",contextid:M.cfg.contextid,url:"https://open.spotify.com/oembed?url="+encodeURIComponent(url),sesskey:M.cfg.sesskey}});try{var json=JSON.parse(data);self.title=json.title,self.posterImage=json.thumbnail_url}catch(e){self.title="",self.posterImage=""}}self.aspectratio=16/9;let ready=!1;self.ended=!1;const callback=EmbedController=>{window.EmbedController=EmbedController,EmbedController.on("ready",(()=>{(0,_jquery.default)("#video-wrapper iframe").attr("id",node),EmbedController.seek(self.start),EmbedController.play()})),EmbedController.addListener("playback_update",(async e=>{if(self.currentTime=e.data.position/1e3,ready){if(self.ended&&!1===e.data.isPaused)return self.ended=!1,void EmbedController.restart();if(self.currentTime<self.start)return EmbedController.pause(),void setTimeout((()=>{EmbedController.seek(self.start+self.frequency),EmbedController.resume()}),self.frequency);switch(e.data.isPaused){case!0:self.paused=!0,(0,_event_dispatcher.dispatchEvent)("iv:playerPaused");break;case!1:self.paused=!1,(0,_event_dispatcher.dispatchEvent)("iv:playerPlaying"),self.currentTime>=self.end-self.frequency&&(self.ended=!0,(0,_event_dispatcher.dispatchEvent)("iv:playerEnded"))}}else{let totaltime=e.data.duration/1e3;if(totaltime=Number(totaltime.toFixed(2)),0===totaltime)return;if(totaltime<40&&end>40)return EmbedController.pause(),EmbedController.destroy(),void(0,_event_dispatcher.dispatchEvent)("iv:playerError",{message:"The video is too short."});if(e.data.position/1e3<self.start)return EmbedController.seek(self.start),void EmbedController.pause();EmbedController.resume(),totaltime-=self.frequency,end=end?Math.min(end,totaltime):totaltime,end=Number(end.toFixed(2)),self.end=end,self.totaltime=totaltime,self.duration=self.end-self.start,ready=!0,(0,_event_dispatcher.dispatchEvent)("iv:playerReady",null,document.getElementById(node))}}))},element=document.getElementById(node),options={uri:"spotify:"+type+":"+videoId,startAt:self.start};if(window.EmbedController)window.IFrameAPI.createController(element,options,callback);else{var tag=document.createElement("script");tag.src="https://open.spotify.com/embed/iframe-api/v1",tag.async=!0,tag.type="text/javascript";var firstScriptTag=document.getElementsByTagName("script")[0];firstScriptTag.parentNode.insertBefore(tag,firstScriptTag),window.onSpotifyIframeApiReady=IFrameAPI=>{IFrameAPI=window.IFrameAPI||IFrameAPI,window.IFrameAPI=IFrameAPI,IFrameAPI.createController(element,options,callback)}}}play(){window.EmbedController.resume(),this.paused=!1}pause(){return window.EmbedController.pause(),this.paused=!0,!0}stop(starttime){window.EmbedController.seek(starttime),window.EmbedController.pause()}seek(time){return this.ended=!1,new Promise((resolve=>{window.EmbedController.seek(time),this.currentTime=time,(0,_event_dispatcher.dispatchEvent)("iv:playerSeek",{time:time}),resolve(!0)}))}getCurrentTime(){return this.currentTime}getDuration(){return this.totaltime}isPaused(){return this.paused}isPlaying(){return!this.paused}isEnded(){return this.ended||this.currentTime>=this.end}ratio(){return this.aspectratio}destroy(){window.EmbedController.destroy(),(0,_event_dispatcher.dispatchEvent)("iv:playerDestroyed")}getState(){return this.isPaused?"paused":"playing"}setRate(){return!1}mute(){}unMute(){}originalPlayer(){return window.EmbedController}setCaption(){}};return _exports.default=_default,_exports.default}));

//# sourceMappingURL=spotify.min.js.map