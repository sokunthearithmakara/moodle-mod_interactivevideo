{"version":3,"file":"bunnystream.min.js","sources":["../../src/player/bunnystream.js"],"sourcesContent":["\n// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * Bunny Stream Player class\n * Doc: https://docs.bunny.net/stream/playback-api#methods\n * @module     mod_interactivevideo/player/bunnystream\n * @copyright  2024 Sokunthearith Makara <sokunthearithmakara@gmail.com>\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\nimport {dispatchEvent} from 'core/event_dispatcher';\nimport $ from 'jquery';\nimport allowAutoplay from 'mod_interactivevideo/player/checkautoplay';\n\nvar player = {};\nclass BunnyStream {\n    /**\n     * Constructor of the bunnystream player.\n     */\n    constructor() {\n        this.useAnimationFrame = false;\n        this.type = 'bunnystream';\n        this.frequency = 0.25;\n        this.support = {\n            playbackrate: false,\n            quality: false,\n        };\n    }\n\n    async getInfo(url, node) {\n        this.node = node;\n        let self = this;\n\n        // URL: https://iframe.mediadelivery.net/embed/501013/66a7eb77-5878-4fde-8dc0-926a3c7f51bf\n        // URL: https://iframe.mediadelivery.net/watch/501013/66a7eb77-5878-4fde-8dc0-926a3c7f51bf\n        // URL: https://player.mediadelivery.net/embed/501013/66a7eb77-5878-4fde-8dc0-926a3c7f51bf?autoplay=1\n\n        let regex = /https?:\\/\\/iframe|player\\.mediadelivery\\.net\\/(?:embed|watch|play)\\/\\d+\\/([a-zA-Z0-9-]+)/i;\n        var match = regex.exec(url);\n        var videoId = match ? match[1] : null;\n        this.videoId = videoId;\n\n        // Get data from oembed.\n        let oembedUrl = `https://video.bunnycdn.com/OEmbed?url=${encodeURIComponent(url)}`;\n\n        let data = await $.ajax({\n            url: M.cfg.wwwroot + '/mod/interactivevideo/ajax.php',\n            type: 'POST',\n            dataType: 'text',\n            data: {\n                action: 'get_from_url',\n                contextid: M.cfg.contextid,\n                url: oembedUrl,\n                sesskey: M.cfg.sesskey,\n            }\n        });\n\n        try {\n            data = JSON.parse(data);\n        } catch (e) {\n            dispatchEvent('iv:playerError', {error: data});\n            return;\n        }\n        if (!data.title) {\n            dispatchEvent('iv:playerError', {error: data});\n            return;\n        }\n\n        self.title = data.title;\n        self.posterImage = data.thumbnail_url;\n\n        // Replace 'iframe.' with 'player.' in the HTML.\n        data.html = data.html.replace(/iframe\\./g, 'player.');\n        let $parent = $(`#${node}`).parent();\n        $(`#${node}`)\n            .replaceWith(data.html);\n        $parent.find('iframe').attr('id', node);\n        player[node] = new window.playerjs.Player(document.getElementById(node));\n\n        // eslint-disable-next-line consistent-return\n        return new Promise((resolve) => {\n            player[node].on('ready', () => {\n                player[node].getDuration(duration => {\n                    resolve({\n                        duration: duration,\n                        title: self.title,\n                        posterImage: self.posterImage,\n                    });\n                });\n\n            });\n        });\n    }\n    /**\n     * Creates an instance of the bunnystream player.\n     *\n     * @constructor\n     * @param {string} url - The URL of the bunnystream video.\n     * @param {number} start - The start time of the video in seconds.\n     * @param {number} end - The end time of the video in seconds.\n     * @param {object} opts - The options for the player.\n     */\n    async load(url, start, end, opts = {}) {\n        const node = opts.node || 'player';\n        this.node = node;\n        this.allowAutoplay = await allowAutoplay(document.getElementById(node));\n        if (!this.allowAutoplay) {\n            dispatchEvent('iv:autoplayBlocked', {\n                requireVideoBlock: true,\n            });\n        }\n\n        let self = this;\n\n        // URL: https://iframe.mediadelivery.net/embed/501013/66a7eb77-5878-4fde-8dc0-926a3c7f51bf\n        // URL: https://iframe.mediadelivery.net/watch/501013/66a7eb77-5878-4fde-8dc0-926a3c7f51bf\n        // URL: https://player.mediadelivery.net/embed/397733/9ab497c4-557a-4ed1-b2b8-a0693fdff84f\n        let regex = /https?:\\/\\/iframe|player\\.mediadelivery\\.net\\/(?:embed|watch|play)\\/\\d+\\/([a-zA-Z0-9-]+)/i;\n        var match = regex.exec(url);\n        var videoId = match ? match[1] : null;\n        this.videoId = videoId;\n\n        // Get data from oembed.\n        let oembedUrl = `https://video.bunnycdn.com/OEmbed?url=${encodeURIComponent(url)}`;\n\n        let data = await $.ajax({\n            url: M.cfg.wwwroot + '/mod/interactivevideo/ajax.php',\n            type: 'POST',\n            dataType: 'text',\n            data: {\n                action: 'get_from_url',\n                contextid: M.cfg.contextid,\n                url: oembedUrl,\n                sesskey: M.cfg.sesskey,\n            }\n        });\n\n        try {\n            data = JSON.parse(data);\n        } catch (e) {\n            dispatchEvent('iv:playerError', {error: data});\n            return;\n        }\n\n        if (!data.title) {\n            dispatchEvent('iv:playerError', {error: data});\n            return;\n        }\n\n        self.title = data.title;\n        self.posterImage = data.thumbnail_url;\n        self.aspectratio = data.width / data.height;\n\n        // Replace 'iframe.' with 'player.' in the HTML.\n        data.html = data.html.replace(/iframe\\./g, 'player.');\n\n        let $parent = $(`#${node}`).parent();\n        $(`#${node}`)\n            .replaceWith(data.html);\n        $parent.find('iframe').attr('id', node);\n        $parent.removeClass('d-none w-0');\n        $('.video-block, #video-block').remove();\n        player[node] = new window.playerjs.Player(document.getElementById(node));\n\n        player[node].on('ready', () => {\n            self.start = start || 0;\n            player[node].play(); // We need to play the video to get the duration.\n            player[node].getDuration(duration => {\n                self.seek(self.start);\n                let totaltime = Number(duration.toFixed(2)) - self.frequency;\n                end = !end ? totaltime : Math.min(end, totaltime);\n                end = Number(end.toFixed(2));\n                self.end = end;\n                self.totaltime = Number(totaltime.toFixed(2));\n                self.duration = self.end - self.start;\n                dispatchEvent('iv:playerReady', null, document.getElementById(node));\n            });\n\n            player[node].on('play', () => {\n                self.paused = false;\n                self.ended = false;\n                dispatchEvent('iv:playerPlay');\n            });\n\n            player[node].on('pause', () => {\n                self.paused = true;\n                dispatchEvent('iv:playerPaused');\n            });\n\n            player[node].on('ended', () => {\n                self.ended = true;\n                dispatchEvent('iv:playerEnded');\n            });\n\n            player[node].on('timeupdate', (data) => {\n                dispatchEvent('iv:playerPlaying');\n                if (data.seconds >= self.end) {\n                    self.ended = true;\n                    player[node].pause();\n                    dispatchEvent('iv:playerEnded');\n                }\n                if (data.seconds < self.start) {\n                    self.seek(self.start);\n                }\n            });\n\n            player[node].on('seeked', () => {\n                player[node].getCurrentTime(value => {\n                    dispatchEvent('iv:playerSeek', {time: value});\n                });\n\n            });\n        });\n    }\n\n    /**\n     * Play the video\n     * @return {Void}\n     */\n    play() {\n        if (!player[this.node]) {\n            return;\n        }\n        player[this.node].play();\n        this.paused = false;\n    }\n    /**\n     * Pause the video\n     * @return {Void}\n     */\n    pause() {\n        if (!player[this.node]) {\n            return;\n        }\n        player[this.node].pause();\n        this.paused = true;\n    }\n    /**\n     * Stop the video\n     * @param {Number} starttime\n     * @return {Void}\n     */\n    stop(starttime) {\n        if (!player[this.node]) {\n            return;\n        }\n        player[this.node].setCurrentTime(starttime);\n        player[this.node].pause();\n    }\n    /**\n     * Seek the video to a specific time\n     * @param {Number} time\n     * @return {Promise<Boolean>}\n     */\n    seek(time) {\n        if (!player[this.node]) {\n            return time;\n        }\n\n        return new Promise((resolve) => {\n            player[this.node].getCurrentTime(value => {\n                let currentTime = value;\n                dispatchEvent('iv:playerSeekStart', {time: currentTime});\n                this.ended = false;\n                player[this.node].setCurrentTime(time, true);\n                resolve(true);\n            });\n        });\n    }\n    /**\n     * Get the current time of the video\n     * @return {Number}\n     */\n    getCurrentTime() {\n        if (!player[this.node]) {\n            return 0;\n        }\n        return new Promise((resolve) => {\n            player[this.node].getCurrentTime(value => resolve(value));\n        });\n    }\n    /**\n     * Get the duration of the video\n     * @return {Number}\n     */\n    getDuration() {\n        if (!player[this.node]) {\n            return 0;\n        }\n        return new Promise(resolve => {\n            player[this.node].getDuration(value => resolve(value));\n        });\n    }\n    /**\n     * Check if the video is paused\n     * @return {Boolean}\n     */\n    isPaused() {\n        if (!player[this.node]) {\n            return true;\n        }\n        return new Promise((resolve) => {\n            player[this.node].getPaused(value => resolve(value === true));\n        });\n    }\n    /**\n     * Check if the video is playing\n     * @return {Boolean}\n     */\n    isPlaying() {\n        if (!player[this.node]) {\n            return false;\n        }\n        return new Promise((resolve) => {\n            player[this.node].getPaused(value => resolve(value === false));\n        });\n    }\n    /**\n     * Check if the video is ended\n     * @return {Boolean}\n     */\n    isEnded() {\n        if (!player[this.node]) {\n            return false;\n        }\n        return this.ended;\n    }\n    /**\n     * Get the aspect ratio of the video\n     * @return {Number}\n     */\n    ratio() {\n        if (!player[this.node]) {\n            return 16 / 9;\n        }\n        return this.aspectratio;\n    }\n    /**\n     * Destroy the player\n     * @return {Void}\n     */\n    destroy() {\n        $(`#${this.node}`).remove();\n        player[this.node] = null;\n        dispatchEvent('iv:playerDestroyed');\n    }\n    /**\n     * Get the state of the player\n     * @return {Number}\n     */\n    getState() {\n        if (!player[this.node]) {\n            return 'paused';\n        }\n        return new Promise((resolve) => {\n            player[this.node].getPaused(value => resolve(value ? 'paused' : 'playing'));\n        });\n    }\n    /**\n     * Set playback rate of the video\n     * @param {Number} rate\n     */\n    setRate(rate) {\n        if (!player[this.node]) {\n            return rate;\n        }\n        return rate;\n    }\n    /**\n     * Mute the video\n     */\n    mute() {\n        if (!player[this.node]) {\n            return;\n        }\n        player[this.node].mute();\n        player[this.node].setVolume(0);\n        this.muted = true;\n        dispatchEvent('iv:playerVolumeChange', {volume: 0});\n    }\n    /**\n     * Unmute the video\n     */\n    unMute() {\n        if (!player[this.node]) {\n            return;\n        }\n        player[this.node].unmute();\n        player[this.node].setVolume(100);\n        this.muted = false;\n        dispatchEvent('iv:playerVolumeChange', {volume: 1});\n    }\n\n    isMuted() {\n        if (!player[this.node]) {\n            return false;\n        }\n        return new Promise((resolve) => {\n            player[this.node].getMuted(value => resolve(value));\n        });\n    }\n    /**\n     * Get the original player object\n     */\n    originalPlayer() {\n        return player[this.node];\n    }\n\n    /**\n     * Set subtitle\n     * @param {string} track language code\n     */\n    setCaption(track) {\n        if (!player[this.node]) {\n            return null;\n        }\n        return track;\n    }\n}\n\nexport default BunnyStream;"],"names":["player","constructor","useAnimationFrame","type","frequency","support","playbackrate","quality","url","node","self","this","match","exec","videoId","oembedUrl","encodeURIComponent","data","$","ajax","M","cfg","wwwroot","dataType","action","contextid","sesskey","JSON","parse","e","error","title","posterImage","thumbnail_url","html","replace","$parent","parent","replaceWith","find","attr","window","playerjs","Player","document","getElementById","Promise","resolve","on","getDuration","duration","start","end","allowAutoplay","requireVideoBlock","aspectratio","width","height","removeClass","remove","play","seek","totaltime","Number","toFixed","Math","min","paused","ended","seconds","pause","getCurrentTime","value","time","stop","starttime","setCurrentTime","currentTime","isPaused","getPaused","isPlaying","isEnded","ratio","destroy","getState","setRate","rate","mute","setVolume","muted","volume","unMute","unmute","isMuted","getMuted","originalPlayer","setCaption","track"],"mappings":"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"}