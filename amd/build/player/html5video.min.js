define("mod_interactivevideo/player/html5video",["exports","core/event_dispatcher","mod_interactivevideo/player/checkautoplay"],(function(_exports,_event_dispatcher,_checkautoplay){var obj;Object.defineProperty(_exports,"__esModule",{value:!0}),_exports.default=void 0,_checkautoplay=(obj=_checkautoplay)&&obj.__esModule?obj:{default:obj};var _systemImportTransformerGlobalIdentifier="undefined"!=typeof window?window:"undefined"!=typeof self?self:"undefined"!=typeof global?global:{};var _default=class{constructor(){this.type="html5video",this.frequency=.4,this.useAnimationFrame=!1,this.support={playbackrate:!0,quality:!0}}async load(url,start,end){let opts=arguments.length>3&&void 0!==arguments[3]?arguments[3]:{};const showControls=opts.showControls||!1,node=opts.node||"player",autoplay=opts.autoplay||!1;this.start=start,this.end=end,this.allowAutoplay=await(0,_checkautoplay.default)(document.getElementById(node)),this.allowAutoplay||(0,_event_dispatcher.dispatchEvent)("iv:autoplayBlocked",{requireVideoBlock:!0});var player=document.getElementById(node);this.posterImage=player.poster;const ext=url.split(".").pop();if(-1===["fmp4","m4v","mov","mp4","ogv","webm","mkv","avi","flv","wmv","m3u8","mpd"].indexOf(ext)){this.audio=!0;const canvas='<canvas id="visualizer"></canvas>';player.insertAdjacentHTML("afterend",canvas),player.style.visibility="hidden"}if(-1!==url.indexOf(".m3u8")){let Hls=await("function"==typeof _systemImportTransformerGlobalIdentifier.define&&_systemImportTransformerGlobalIdentifier.define.amd?new Promise((function(resolve,reject){_systemImportTransformerGlobalIdentifier.require(["mod_interactivevideo/player/hls"],resolve,reject)})):"undefined"!=typeof module&&module.exports&&"undefined"!=typeof require||"undefined"!=typeof module&&module.component&&_systemImportTransformerGlobalIdentifier.require&&"component"===_systemImportTransformerGlobalIdentifier.require.loader?Promise.resolve(require("mod_interactivevideo/player/hls")):Promise.resolve(_systemImportTransformerGlobalIdentifier["mod_interactivevideo/player/hls"]));if(window.Hls=Hls,void 0!==Hls&&Hls.isSupported()){var hls=new Hls;this.hls=hls,hls.loadSource(url),hls.attachMedia(player),this.support.quality=!0,hls.on(Hls.Events.MANIFEST_PARSED,(function(event,data){this.hlsdata=data})),hls.on(Hls.Events.LEVEL_SWITCHED,(function(event,data){(0,_event_dispatcher.dispatchEvent)("iv:playerQualityChange",{quality:data.level})})),hls.on(Hls.Events.ERROR,(function(event,data){data.fatal&&(0,_event_dispatcher.dispatchEvent)("iv:playerError",{error:data})}))}else player.canPlayType("application/vnd.apple.mpegurl")?(player.src=url,this.support.quality=!1):(window.console.error("HLS is not supported in this browser."),this.support.quality=!1)}else if(-1!==url.indexOf(".mpd")){let dashjs=await("function"==typeof _systemImportTransformerGlobalIdentifier.define&&_systemImportTransformerGlobalIdentifier.define.amd?new Promise((function(resolve,reject){_systemImportTransformerGlobalIdentifier.require(["mod_interactivevideo/player/dash"],resolve,reject)})):"undefined"!=typeof module&&module.exports&&"undefined"!=typeof require||"undefined"!=typeof module&&module.component&&_systemImportTransformerGlobalIdentifier.require&&"component"===_systemImportTransformerGlobalIdentifier.require.loader?Promise.resolve(require("mod_interactivevideo/player/dash")):Promise.resolve(_systemImportTransformerGlobalIdentifier["mod_interactivevideo/player/dash"]));if(void 0!==dashjs){var dashPlayer=dashjs.MediaPlayer().create();dashPlayer.initialize(player,url,!1),this.dash=dashPlayer,dashPlayer.on(dashjs.MediaPlayer.events.REPRESENTATION_SWITCH,(function(){const current=dashPlayer.getCurrentRepresentationForType("video");current&&(0,_event_dispatcher.dispatchEvent)("iv:playerQualityChange",{quality:current.absoluteIndex})})),dashPlayer.on(dashjs.MediaPlayer.events.ERROR,(function(){(0,_event_dispatcher.dispatchEvent)("iv:playerError")})),this.support.quality=!0}else window.console.error("Dash.js library is not loaded."),this.support.quality=!1}else player.src=url,this.support.quality=!1;player.controls=showControls,player.currentTime=start,player.setAttribute("muted",""),!this.support.quality&&document.getElementById("quality")&&document.getElementById("quality").remove(),(document.body.classList.contains("mobiletheme")||autoplay)&&player.setAttribute("autoplay",""),player.tabIndex=-1;let self=this;showControls||document.body.classList.add("no-original-controls"),player.setAttribute("playsinline",""),player.setAttribute("disablePictureInPicture",""),player.setAttribute("disablePictureInPicture",""),player.addEventListener("loadedmetadata",(function(){self.aspectratio=self.ratio(),isNaN(self.aspectratio)&&(self.aspectratio=16/9);let totaltime=Number(player.duration.toFixed(2))-self.frequency;if((player.duration===1/0||isNaN(player.duration)||self.hls&&self.hls.latencyController.levelDetails.live)&&(totaltime=.1,self.live=!0),.1!=end||self.live||(end=totaltime),end=end?Math.min(end,totaltime):totaltime,end=Number(end.toFixed(2)),self.end=end,self.totaltime=totaltime,self.duration=self.end-self.start,player.pause(),self.dash)self.dash.on(window.dashjs.MediaPlayer.events.STREAM_INITIALIZED,(()=>{self.dash.setTextTrack(null);let tracks=self.dash.getTracksFor("text");tracks&&tracks.length>0&&(tracks=tracks.map((track=>{const locale=track.lang.split("-")[0],country=track.lang.split("-")[1];let displayNames,label;try{displayNames=new Intl.DisplayNames(["".concat(M.cfg.language)],{type:"language"})}catch(e){displayNames=new Intl.DisplayNames(["en"],{type:"language"})}var _displayNames$of;"auto"==country?label=displayNames.of(locale)+" (Auto)":label=null!==(_displayNames$of=displayNames.of(track.lang))&&void 0!==_displayNames$of?_displayNames$of:track.lang.toUpperCase();return{label:label,code:track.lang}})),self.captions=tracks),(0,_event_dispatcher.dispatchEvent)("iv:playerLoaded",{tracks:self.captions||null}),(0,_event_dispatcher.dispatchEvent)("iv:playerReady",null,document.getElementById(node))}));else if(self.hls){self.hls.subtitleTrack=-1;let tracks=self.hls.subtitleTracks;tracks&&tracks.length>0&&(tracks=tracks.map((track=>{const locale=track.lang.split("-")[0],country=track.lang.split("-")[1];let displayNames,label;try{displayNames=new Intl.DisplayNames(["".concat(M.cfg.language)],{type:"language"})}catch(e){displayNames=new Intl.DisplayNames(["en"],{type:"language"})}var _displayNames$of2;"auto"==country?label=displayNames.of(locale)+" (Auto)":label=null!==(_displayNames$of2=displayNames.of(track.lang))&&void 0!==_displayNames$of2?_displayNames$of2:track.lang.toUpperCase();return{label:label,code:track.lang}})),self.captions=tracks),(0,_event_dispatcher.dispatchEvent)("iv:playerLoaded",{tracks:self.captions||null}),(0,_event_dispatcher.dispatchEvent)("iv:playerReady",null,document.getElementById(node))}else(0,_event_dispatcher.dispatchEvent)("iv:playerLoaded",{tracks:null}),(0,_event_dispatcher.dispatchEvent)("iv:playerReady",null,document.getElementById(node))})),player.addEventListener("pause",(function(){self.paused=!0,(0,_event_dispatcher.dispatchEvent)("iv:playerPaused")})),player.addEventListener("play",(function(){self.paused=!1,(0,_event_dispatcher.dispatchEvent)("iv:playerPlay")})),player.addEventListener("timeupdate",(function(){self.paused||(player.currentTime<self.start&&(player.currentTime=self.start),player.currentTime>=self.end+self.frequency&&!self.live&&(player.currentTime=self.end-self.frequency),(0,_event_dispatcher.dispatchEvent)("iv:playerPlaying"),self.live||(self.ended?self.ended=!1:!self.ended&&player.currentTime>=self.end&&(self.ended=!0,self.paused=!0,player.pause(),(0,_event_dispatcher.dispatchEvent)("iv:playerEnded"))))})),player.addEventListener("error",(function(e){(0,_event_dispatcher.dispatchEvent)("iv:playerError",{error:e})})),player.addEventListener("ratechange",(function(){(0,_event_dispatcher.dispatchEvent)("iv:playerRateChange",{rate:player.playbackRate})})),player.addEventListener("waiting",(function(){(0,_event_dispatcher.dispatchEvent)("iv:playerBuffering")})),this.player=player}visualizer(){var context=new AudioContext,src=context.createMediaElementSource(this.player),analyser=context.createAnalyser(),canvas=document.getElementById("visualizer");canvas.width=window.innerWidth,canvas.height=window.innerHeight;var ctx=canvas.getContext("2d");src.connect(analyser),analyser.connect(context.destination),analyser.fftSize=256;var barHeight,bufferLength=analyser.frequencyBinCount,dataArray=new Uint8Array(bufferLength),WIDTH=canvas.width,HEIGHT=canvas.height,barWidth=WIDTH/bufferLength*2.5,x=0;const renderFrame=()=>{requestAnimationFrame(renderFrame),x=0,analyser.getByteFrequencyData(dataArray),ctx.fillStyle="#000",ctx.fillRect(0,0,WIDTH,HEIGHT);for(var i=0;i<bufferLength;i++){var r=(barHeight=dataArray[i])+i/bufferLength*25,g=i/bufferLength*250;ctx.fillStyle="rgb("+r+","+g+",50)",ctx.fillRect(x,HEIGHT-barHeight,barWidth,barHeight),x+=barWidth+1}};renderFrame()}play(){if(this.live&&(this.dash&&this.dash.seekToOriginalLive(),this.hls)){let seektime=this.hls.liveSyncPosition;this.seek(seektime)}this.player.play(),this.paused=!1}pause(){return this.player.pause(),this.paused=!0,!0}stop(starttime){this.player.pause(),this.player.currentTime=starttime}seek(time){return this.ended=!1,this.player.currentTime=time,(0,_event_dispatcher.dispatchEvent)("iv:playerSeek",{time:time}),!0}getCurrentTime(){return this.player.currentTime}getDuration(){return this.player.duration}isPaused(){return!!this.paused||this.player.paused}isPlaying(){return!this.paused&&!this.player.paused}isEnded(){return this.player.ended||this.player.currentTime>=this.end}ratio(){return!this.audio&&this.player.videoWidth&&this.player.videoHeight?this.player.videoWidth/this.player.videoHeight:16/9}destroy(){document.getElementById("video-wrapper").innerHTML='<div id="player" style="width:100%; max-width: 100%"></div>',this.player.pause(),this.player.removeAttribute("src"),this.player.load(),this.hls&&this.hls.destroy(),this.dash&&this.dash.destroy()}getState(){return this.player.paused?"paused":"playing"}setRate(rate){this.player.playbackRate=rate}mute(){this.player.muted=!0}unMute(){this.player.muted=!1,this.player.volume=1}isMuted(){return this.player.muted}originalPlayer(){return this.player}setQuality(quality){return this.support.quality&&(this.hls?this.hls.currentLevel=quality:this.dash&&(-1===quality?this.dash.updateSettings({streaming:{abr:{autoSwitchBitrate:{video:!0}}}}):(this.dash.updateSettings({streaming:{abr:{autoSwitchBitrate:{video:!1}}}}),this.dash.setRepresentationForTypeByIndex("video",quality)))),quality}getQualities(){if(this.support.quality){let keys,values,current;if(this.hls)keys=[-1,...this.hls.levels.map(((level,index)=>index))],values=["Auto",...this.hls.levels.map((level=>level.height+"p"))],current=this.hls.currentLevel;else if(this.dash){const qualities=this.dash.getRepresentationsByType("video");keys=[-1,...qualities.map((quality=>quality.absoluteIndex))],values=["Auto",...qualities.map((quality=>quality.height+"p ("+Math.round(quality.bitrateInKbit)+"kbps)"))],current=this.dash.getCurrentRepresentationForType("video").absoluteIndex,current||(current=-1)}return{qualities:keys,qualitiesLabel:values,currentQuality:current}}return[]}setCaption(track){if(this.dash)if("off"===track||""==track)this.dash.setTextTrack(null);else{const tracks=this.dash.getTracksFor("text");if(tracks&&tracks.length>0){const selectedTrack=tracks.find((t=>t.lang===track));selectedTrack?this.dash.setTextTrack(selectedTrack.id):window.console.warn("Caption track not found:",track)}}if(this.hls)if("off"===track||""==track)this.hls.subtitleTrack=-1;else{const tracks=this.hls.subtitleTracks;if(tracks&&tracks.length>0){const selectedTrack=tracks.find((t=>t.lang===track));selectedTrack?this.hls.subtitleTrack=selectedTrack.id:window.console.warn("Caption track not found:",track)}}return track}};return _exports.default=_default,_exports.default}));

//# sourceMappingURL=html5video.min.js.map