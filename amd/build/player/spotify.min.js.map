{"version":3,"file":"spotify.min.js","sources":["../../src/player/spotify.js"],"sourcesContent":["\n// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * Spotify Player class\n *\n * @module     mod_interactivevideo/player/spotify\n * @copyright  2024 Sokunthearith Makara <sokunthearithmakara@gmail.com>\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\nimport {dispatchEvent} from 'core/event_dispatcher';\nimport $ from 'jquery';\nclass Spotify {\n    constructor() {\n        this.type = 'spotify';\n        this.frequency = 1.2; // Spotify emits playback_update very very slowly (0.5 - 1 s).\n        this.support = {\n            playbackrate: false,\n            quality: false,\n            password: false,\n        };\n        this.useAnimationFrame = false;\n        // Remove the mute button since Spotify does not support mute.\n        $('#controller #mute').remove();\n    }\n    /**\n     * Creates an instance of the Spotify player.\n     *\n     * @param {string} url - The URL of the Spotify video.\n     * @param {number} start - The start time of the video in seconds.\n     * @param {number} end - The end time of the video in seconds.\n     * @param {object} opts - The options for the player.\n     */\n    async load(url, start, end, opts = {}) {\n        const node = opts.node || 'player';\n        this.node = node;\n        /**\n         * The start time of the video\n         * @type {Number}\n         * @private\n         */\n        this.start = start;\n        /**\n         * The end time of the video\n         * @type {Number}\n         */\n        this.end = end;\n\n        // Documented at https://developer.spotify.com/documentation/embeds/references/iframe-api\n        // e.g https://open.spotify.com/episode/7makk4oTQel546B0PZlDM5?si=8b1b1b1b1b1b1b1b\n        let regex = /(?:https?:\\/\\/)?(?:open\\.spotify\\.com)\\/(episode|track)\\/([^/]+)/;\n        let match = regex.exec(url);\n        let videoId = match[2];\n        let type = match[1];\n        videoId = videoId.split(\"?\")[0];\n        this.videoId = videoId;\n        let self = this;\n        $('.video-block, #start-screen').remove();\n        $('#annotation-canvas').removeClass('d-none');\n\n        const getData = function() {\n            return $.ajax({\n                url: M.cfg.wwwroot + '/mod/interactivevideo/ajax.php',\n                type: 'POST',\n                dataType: 'text',\n                data: {\n                    action: 'get_from_url',\n                    contextid: M.cfg.contextid,\n                    url: 'https://open.spotify.com/oembed?url=' + encodeURIComponent(url),\n                    sesskey: M.cfg.sesskey,\n                }\n            });\n        };\n\n        if (opts.editform) {\n            const data = await getData();\n            try {\n                var json = JSON.parse(data);\n                self.title = json.title;\n                self.posterImage = json.thumbnail_url;\n            } catch (e) {\n                self.title = '';\n                self.posterImage = '';\n            }\n        }\n\n        self.aspectratio = 16 / 9;\n        let ready = false;\n\n        const callback = (EmbedController) => {\n            window.EmbedController = EmbedController;\n            EmbedController.on('ready', () => {\n                $('#video-wrapper iframe').attr('id', node);\n                EmbedController.seek(self.start);\n                EmbedController.play();\n            });\n            EmbedController.addListener('playback_update', async e => {\n                self.currentTime = e.data.position / 1000;\n                if (!ready) {\n                    let totaltime = e.data.duration / 1000;\n                    totaltime = Number(totaltime.toFixed(2));\n                    if (totaltime === 0) {\n                        return;\n                    }\n                    if (e.data.position / 1000 < self.start) {\n                        EmbedController.seek(self.start);\n                        EmbedController.pause();\n                        return;\n                    }\n                    EmbedController.resume();\n                    totaltime = totaltime - self.frequency;\n                    end = !end ? totaltime : Math.min(end, totaltime);\n                    end = Number(end.toFixed(2));\n                    self.end = end;\n                    self.totaltime = totaltime;\n                    self.duration = self.end - self.start;\n                    ready = true;\n                    dispatchEvent('iv:playerReady');\n                } else {\n                    if (self.currentTime < self.start) {\n                        EmbedController.pause();\n                        setTimeout(() => {\n                            EmbedController.seek(self.start + self.frequency);\n                            EmbedController.resume();\n                        }, self.frequency);\n                        return;\n                    }\n                    let isPaused = e.data.isPaused;\n                    switch (isPaused) {\n                        case true:\n                            self.paused = true;\n                            dispatchEvent('iv:playerPaused');\n                            break;\n                        case false:\n                            self.paused = false;\n\n                            if (self.ended) {\n                                self.ended = false;\n                                EmbedController.restart();\n                                setTimeout(() => {\n                                    EmbedController.seek(self.start + self.frequency);\n                                }, self.frequency);\n                                return;\n                            }\n\n                            dispatchEvent('iv:playerPlaying');\n                            if (!self.ended && self.currentTime >= self.end - self.frequency) {\n                                self.ended = true;\n                                dispatchEvent('iv:playerEnded');\n                            }\n                            break;\n                    }\n                }\n            });\n        };\n\n        // Load the IFrame Player API code asynchronously.\n        const element = document.getElementById(node);\n        const options = {\n            uri: 'spotify:' + type + ':' + videoId,\n            startAt: self.start,\n        };\n        if (!window.EmbedController) {\n            var tag = document.createElement('script');\n            tag.src = \"https://open.spotify.com/embed/iframe-api/v1\";\n            tag.async = true;\n            tag.type = 'text/javascript';\n            var firstScriptTag = document.getElementsByTagName('script')[0];\n            firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);\n            // Replace the 'player' element with an <iframe> and Spotify player\n            window.onSpotifyIframeApiReady = (IFrameAPI) => {\n                IFrameAPI = window.IFrameAPI || IFrameAPI;\n                window.IFrameAPI = IFrameAPI;\n                IFrameAPI.createController(element, options, callback);\n            };\n        } else {\n            window.IFrameAPI.createController(element, options, callback);\n        }\n    }\n    /**\n     * Play the video\n     * @return {Void}\n     */\n    play() {\n        window.EmbedController.resume();\n        this.paused = false;\n    }\n    /**\n     * Pause the video\n     * @return {Void}\n     */\n    pause() {\n        window.EmbedController.pause();\n        this.paused = true;\n        return true;\n    }\n    /**\n     * Stop the video\n     * @param {Number} starttime\n     * @return {Void}\n     */\n    stop(starttime) {\n        window.EmbedController.seek(starttime);\n        window.EmbedController.pause();\n    }\n    /**\n     * Seek the video to a specific time\n     * @param {Number} time\n     * @return {Promise<Boolean>}\n     */\n    seek(time) {\n        this.ended = false;\n        return new Promise((resolve) => {\n            window.EmbedController.seek(time);\n            this.currentTime = time;\n            dispatchEvent('iv:playerSeek', {time: time});\n            resolve(true);\n        });\n    }\n    /**\n     * Get the current time of the video\n     * @return {Number}\n     */\n    getCurrentTime() {\n        return this.currentTime;\n    }\n    /**\n     * Get the duration of the video\n     * @return {Number}\n     */\n    getDuration() {\n        return this.totaltime;\n    }\n    /**\n     * Check if the video is paused\n     * @return {Boolean}\n     */\n    isPaused() {\n        return this.paused;\n    }\n    /**\n     * Check if the video is playing\n     * @return {Boolean}\n     */\n    isPlaying() {\n        return !this.paused;\n    }\n    /**\n     * Check if the video is ended\n     * @return {Boolean}\n     */\n    isEnded() {\n        return this.ended || this.currentTime >= this.end;\n    }\n    /**\n     * Get the aspect ratio of the video\n     * @return {Number}\n     */\n    ratio() {\n        return this.aspectratio;\n    }\n    /**\n     * Destroy the player\n     * @return {Void}\n     */\n    destroy() {\n        window.EmbedController.destroy();\n        dispatchEvent('iv:playerDestroyed');\n    }\n    /**\n     * Get the state of the player\n     * @return {Number}\n     */\n    getState() {\n        return this.isPaused ? 'paused' : 'playing';\n    }\n    /**\n     * Set playback rate of the video\n     */\n    setRate() {\n        return false;\n    }\n    /**\n     * Mute the video\n     */\n    mute() {\n        // Spotify does not support mute\n    }\n    /**\n     * Unmute the video\n     */\n    unMute() {\n        // Spotify does not support mute\n    }\n    /**\n     * Get the original player object\n     */\n    originalPlayer() {\n        return window.EmbedController;\n    }\n\n    /**\n     * Set subtitle\n     */\n    setCaption() {\n        // Spotify does not support captions\n    }\n}\n\nexport default Spotify;"],"names":["constructor","type","frequency","support","playbackrate","quality","password","useAnimationFrame","remove","url","start","end","opts","node","match","exec","videoId","split","self","this","removeClass","editform","data","$","ajax","M","cfg","wwwroot","dataType","action","contextid","encodeURIComponent","sesskey","json","JSON","parse","title","posterImage","thumbnail_url","e","aspectratio","ready","callback","EmbedController","window","on","attr","seek","play","addListener","async","currentTime","position","pause","setTimeout","resume","isPaused","paused","ended","restart","totaltime","duration","Number","toFixed","Math","min","element","document","getElementById","options","uri","startAt","IFrameAPI","createController","tag","createElement","src","firstScriptTag","getElementsByTagName","parentNode","insertBefore","onSpotifyIframeApiReady","stop","starttime","time","Promise","resolve","getCurrentTime","getDuration","isPlaying","isEnded","ratio","destroy","getState","setRate","mute","unMute","originalPlayer","setCaption"],"mappings":"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"}