{"version":3,"file":"spotify.min.js","sources":["../../src/player/spotify.js"],"sourcesContent":["\n// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * Spotify Player class\n *\n * @module     mod_interactivevideo/player/spotify\n * @copyright  2024 Sokunthearith Makara <sokunthearithmakara@gmail.com>\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\nimport {dispatchEvent} from 'core/event_dispatcher';\nimport $ from 'jquery';\nclass Spotify {\n    constructor() {\n        this.type = 'spotify';\n        this.frequency = 0.5; // Spotify emits playback_update very very slowly (0.5 - 1 s).\n        this.support = {\n            playbackrate: false,\n            quality: false,\n            password: false,\n        };\n        this.useAnimationFrame = false;\n        // Remove the mute button since Spotify does not support mute.\n        $('#controller #mute').remove();\n    }\n    /**\n     * Creates an instance of the Spotify player.\n     *\n     * @param {string} url - The URL of the Spotify video.\n     * @param {number} start - The start time of the video in seconds.\n     * @param {number} end - The end time of the video in seconds.\n     * @param {object} opts - The options for the player.\n     */\n    async load(url, start, end, opts = {}) {\n        const node = opts.node || 'player';\n        this.node = node;\n        /**\n         * The start time of the video\n         * @type {Number}\n         * @private\n         */\n        this.start = start;\n        /**\n         * The end time of the video\n         * @type {Number}\n         */\n        this.end = end;\n\n        // Documented at https://developer.spotify.com/documentation/embeds/references/iframe-api\n        // e.g https://open.spotify.com/episode/7makk4oTQel546B0PZlDM5?si=8b1b1b1b1b1b1b1b\n        let regex = /(?:https?:\\/\\/)?(?:open\\.spotify\\.com)\\/(episode|track)\\/([^/]+)/;\n        let match = regex.exec(url);\n        let videoId = match[2];\n        let type = match[1];\n        videoId = videoId.split(\"?\")[0];\n        this.videoId = videoId;\n        let self = this;\n        $('.video-block, #start-screen').remove();\n        $('#annotation-canvas').removeClass('d-none');\n\n        const getData = function() {\n            return $.ajax({\n                url: M.cfg.wwwroot + '/mod/interactivevideo/ajax.php',\n                type: 'POST',\n                dataType: 'text',\n                data: {\n                    action: 'get_from_url',\n                    contextid: M.cfg.contextid,\n                    url: 'https://open.spotify.com/oembed?url=' + encodeURIComponent(url),\n                    sesskey: M.cfg.sesskey,\n                }\n            });\n        };\n        const data = await getData();\n        let json = JSON.parse(data);\n        self.title = json.title;\n        self.posterImage = json.thumbnail_url;\n        self.aspectratio = json.width / json.height;\n        let ready = false;\n\n        const callback = (EmbedController) => {\n            window.EmbedController = EmbedController;\n            EmbedController.on('ready', () => {\n                $('#video-wrapper iframe').attr('id', node);\n                EmbedController.seek(self.start);\n                EmbedController.play();\n            });\n            EmbedController.addListener('playback_update', async e => {\n                self.currentTime = e.data.position / 1000;\n                if (!ready) {\n                    let totaltime = e.data.duration / 1000;\n                    if (totaltime === 0) {\n                        return;\n                    }\n                    if (e.data.position / 1000 < self.start) {\n                        EmbedController.seek(self.start);\n                        EmbedController.pause();\n                        return;\n                    }\n                    EmbedController.resume();\n                    totaltime = totaltime - self.frequency;\n                    end = !end ? totaltime : Math.min(end, totaltime);\n                    end = Number(end.toFixed(2));\n                    self.end = end;\n                    self.totaltime = totaltime;\n                    self.duration = self.end - self.start;\n                    ready = true;\n                    dispatchEvent('iv:playerReady');\n                } else {\n                    let isPaused = e.data.isPaused;\n                    switch (isPaused) {\n                        case true:\n                            self.paused = true;\n                            dispatchEvent('iv:playerPaused');\n                            break;\n                        case false:\n                            self.paused = false;\n                            if (self.ended || self.currentTime <= self.start) {\n                                self.ended = false;\n                                EmbedController.seek(self.start);\n                                EmbedController.resume();\n                                return;\n                            }\n                            dispatchEvent('iv:playerPlaying');\n                            if (!self.ended && self.currentTime >= self.end - self.frequency) {\n                                self.ended = true;\n                                dispatchEvent('iv:playerEnded');\n                            }\n                            break;\n                    }\n                }\n            });\n        };\n\n        // Load the IFrame Player API code asynchronously.\n        if (!window.IFrameAPI) {\n            var tag = document.createElement('script');\n            tag.src = \"https://open.spotify.com/embed/iframe-api/v1\";\n            tag.async = true;\n            tag.type = 'text/javascript';\n            var firstScriptTag = document.getElementsByTagName('script')[0];\n            firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);\n            // Replace the 'player' element with an <iframe> and Spotify player\n            window.onSpotifyIframeApiReady = (IFrameAPI) => {\n                IFrameAPI = window.IFrameAPI || IFrameAPI;\n                const element = document.getElementById(node);\n                const options = {\n                    uri: 'spotify:' + type + ':' + videoId,\n                    startAt: self.start,\n                };\n                IFrameAPI.createController(element, options, callback);\n            };\n        } else {\n            window.EmbedController.loadUri('spotify:' + type + ':' + videoId, true, self.start);\n        }\n    }\n    /**\n     * Play the video\n     * @return {Void}\n     */\n    play() {\n        window.EmbedController.resume();\n        this.paused = false;\n    }\n    /**\n     * Pause the video\n     * @return {Void}\n     */\n    pause() {\n        window.EmbedController.pause();\n        this.paused = true;\n        return true;\n    }\n    /**\n     * Stop the video\n     * @param {Number} starttime\n     * @return {Void}\n     */\n    stop(starttime) {\n        window.EmbedController.seek(starttime);\n        window.EmbedController.pause();\n    }\n    /**\n     * Seek the video to a specific time\n     * @param {Number} time\n     * @return {Promise<Boolean>}\n     */\n    seek(time) {\n        time = Math.min(time, this.end);\n        time = Math.max(time, this.start);\n        this.ended = false;\n        return new Promise((resolve) => {\n            window.EmbedController.seek(time);\n            this.currentTime = time;\n            dispatchEvent('iv:playerSeek', {time: time});\n            resolve(true);\n        });\n    }\n    /**\n     * Get the current time of the video\n     * @return {Number}\n     */\n    getCurrentTime() {\n        return this.currentTime;\n    }\n    /**\n     * Get the duration of the video\n     * @return {Number}\n     */\n    getDuration() {\n        return this.totaltime;\n    }\n    /**\n     * Check if the video is paused\n     * @return {Boolean}\n     */\n    isPaused() {\n        return this.paused;\n    }\n    /**\n     * Check if the video is playing\n     * @return {Boolean}\n     */\n    isPlaying() {\n        return !this.paused;\n    }\n    /**\n     * Check if the video is ended\n     * @return {Boolean}\n     */\n    isEnded() {\n        return this.ended || this.currentTime >= this.end;\n    }\n    /**\n     * Get the aspect ratio of the video\n     * @return {Number}\n     */\n    ratio() {\n        return this.aspectratio;\n    }\n    /**\n     * Destroy the player\n     * @return {Void}\n     */\n    destroy() {\n        window.EmbedController.destroy();\n        dispatchEvent('iv:playerDestroyed');\n    }\n    /**\n     * Get the state of the player\n     * @return {Number}\n     */\n    getState() {\n        return this.isPaused ? 'paused' : 'playing';\n    }\n    /**\n     * Set playback rate of the video\n     */\n    setRate() {\n        return false;\n    }\n    /**\n     * Mute the video\n     */\n    mute() {\n        // Spotify does not support mute\n    }\n    /**\n     * Unmute the video\n     */\n    unMute() {\n        // Spotify does not support mute\n    }\n    /**\n     * Get the original player object\n     */\n    originalPlayer() {\n        return window.EmbedController;\n    }\n\n    /**\n     * Set subtitle\n     */\n    setCaption() {\n        // Spotify does not support captions\n    }\n}\n\nexport default Spotify;"],"names":["constructor","type","frequency","support","playbackrate","quality","password","useAnimationFrame","remove","url","start","end","node","match","exec","videoId","split","self","this","removeClass","data","$","ajax","M","cfg","wwwroot","dataType","action","contextid","encodeURIComponent","sesskey","json","JSON","parse","title","posterImage","thumbnail_url","aspectratio","width","height","ready","callback","EmbedController","window","on","attr","seek","play","addListener","async","currentTime","e","position","isPaused","paused","ended","resume","totaltime","duration","pause","Math","min","Number","toFixed","IFrameAPI","loadUri","tag","document","createElement","src","firstScriptTag","getElementsByTagName","parentNode","insertBefore","onSpotifyIframeApiReady","element","getElementById","options","uri","startAt","createController","stop","starttime","time","max","Promise","resolve","getCurrentTime","getDuration","isPlaying","isEnded","ratio","destroy","getState","setRate","mute","unMute","originalPlayer","setCaption"],"mappings":"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"}