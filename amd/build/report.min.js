define("mod_interactivevideo/report",["exports","jquery","core/notification","core/toast","./libraries/jszip","./libraries/jquery.dataTables","./libraries/dataTables.bootstrap4","./libraries/dataTables.buttons","./libraries/buttons.bootstrap4","./libraries/buttons.html5","./libraries/buttons.colVis","./libraries/dataTables.select","./libraries/select.bootstrap4","./libraries/select2","./quickform"],(function(_exports,_jquery,_notification,_toast,_jszip,_jquery2,_dataTables,_dataTables2,_buttons,_buttons2,_buttons3,_dataTables3,_select,_select2,_quickform){function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj}}
/**
   * Handle report page
   *
   * @module     mod_interactivevideo/report
   * @copyright  2024 Sokunthearith Makara <sokunthearithmakara@gmail.com>
   * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
   */Object.defineProperty(_exports,"__esModule",{value:!0}),_exports.renderAnnotationLogs=_exports.init=void 0,_jquery=_interopRequireDefault(_jquery),_notification=_interopRequireDefault(_notification),_jszip=_interopRequireDefault(_jszip),_quickform=_interopRequireDefault(_quickform);_exports.init=(cmid,groupid,grademax,itemids,completionpercentage,videourl,videotype,cm,courseid,start,end,access)=>{window.JSZip=_jszip.default;let DataTable=_jquery.default.fn.dataTable;(0,_quickform.default)();const getContentTypes=_jquery.default.ajax({url:M.cfg.wwwroot+"/mod/interactivevideo/ajax.php",method:"POST",dataType:"text",data:{action:"get_all_contenttypes",sesskey:M.cfg.sesskey,contextid:M.cfg.contextid}}),getReportData=_jquery.default.ajax({url:M.cfg.wwwroot+"/mod/interactivevideo/ajax.php",method:"POST",data:{action:"get_report_data_by_group",cmid:cmid,sesskey:M.cfg.sesskey,contextid:M.cfg.contextid,ctxid:M.cfg.courseContextId,courseid:courseid,groupid:groupid}});let itemsdata=(0,_jquery.default)("#itemsdata").text();itemsdata=JSON.parse(itemsdata);let contentTypes,tabledata,initonreport=itemsdata.filter((x=>JSON.parse(x.prop).initonreport));initonreport=[...new Set(initonreport.map((x=>x.type)))],_jquery.default.when(getContentTypes,getReportData).done((async(ct,data)=>{contentTypes=JSON.parse(ct[0]),data=data[0];const hasCompletion=data.some((x=>x.timecreated>0));let profileFields=[],customProfileFields=data.map((x=>x.customfields));customProfileFields=customProfileFields.reduce(((acc,val)=>acc.concat(val)),[]),customProfileFields=[...new Set(customProfileFields)],customProfileFields=customProfileFields.filter((x=>void 0!==x)),(0,_jquery.default)("#completiontable th.profilefield").each((function(){const pr={index:(0,_jquery.default)("th").index((0,_jquery.default)(this)),text:(0,_jquery.default)(this).text(),name:(0,_jquery.default)(this).attr("id"),type:"text"};if(customProfileFields&&customProfileFields.length>0){const customField=customProfileFields.find((x=>x.shortname===pr.name.replace("profile_field_","")));customField&&(pr.type=customField.type)}profileFields.push(pr)}));let exportOptions={columns:[".exportable"],format:{body:function(data){const div=document.createElement("div");return div.innerHTML=data,(div.textContent||div.innerText||"").trim()},header:function(data){const div=document.createElement("div");return div.innerHTML=data,div.querySelector(".controls")&&div.querySelector(".controls").remove(),(div.textContent||div.innerText||"").trim()}}},columns=[{data:"id",visible:!1},{data:"picture",render:function(data,type,row){if("sort"===type)return row.fullname;let deletebutton="";return 1==access.canedit&&(deletebutton='<button title="'.concat(M.util.get_string("reset","mod_interactivevideo"),'"\n                 class="btn border-0 btn-sm text-danger reset m-1" data-record="').concat(row.completionid,'"\n                  data-userid="').concat(row.id,'">\n                 <i class="bi bi-trash3"></i></button>')),data=data.replace(/<a /g,'<a target="_blank" '),'<div class="d-flex align-items-center">\n                    '.concat(1==access.canedit?'<input class="mr-3" type="checkbox"\n                         data-record="'.concat(row.completionid,'" ').concat(row.timecreated>0?"":"disabled",'\n                         data-userid="').concat(row.id,'"/>'):"",'\n                    <div class="text-truncate d-flex align-items-center justify-content-between flex-grow-1">').concat(data,"\n                ").concat(row.timecreated>0?deletebutton:"","</div></div>")},className:"bg-white sticky-left-0"}],$identitycolumn=(0,_jquery.default)("#reporttable th.profilefield");$identitycolumn.length>0&&$identitycolumn.each((function(){let $this=(0,_jquery.default)(this);columns.push({data:(0,_jquery.default)(this).attr("id"),render:function(data,type,row){if(!row.customfields)return data;let fieldtype=row.customfields.find((x=>x.shortname===$this.attr("id").replace("profile_field_","")));return fieldtype?"datetime"!==fieldtype.type||"sort"!=type&&"filter"!=type?data:fieldtype.value:data}})})),window.console.log(itemids),columns=columns.concat([{data:"timecreated",render:function(data,type){if(data&&0!=data){const date=new Date(1e3*data);return"display"===type?date.toLocaleString():"filter"===type||"sort"===type?date.getTime():data}return"display"===type?"":0},className:"exportable timecreated"},{data:"timecompleted",render:function(data,type,row){if(data&&0!=data){const date=new Date(1e3*data);return"display"===type?date.toLocaleString():"filter"===type||"sort"===type?date.getTime():data}return row.timecreated?"display"===type?M.util.get_string("inprogress","mod_interactivevideo"):0:"display"===type?"":0},className:"exportable"+(0==itemids.length?" inv d-none":"")},{data:"completionpercentage",render:function(data,type){return data?data+"%":"display"===type?"":0},className:"exportable"+(0==itemids.length?" inv d-none":"")},{data:"xp",render:function(data){return data||""},className:"exportable"+(0==itemids.length?" inv d-none":"")}]);let datatableOptions={data:data,deferRender:!0,rowId:"id",pageLength:25,order:[[columns.findIndex((c=>"timecreated"==c.data)),"desc"],[1,"asc"]],columns:columns,columnDefs:[{targets:"not-sortable",sortable:!1},{targets:"inv",visible:!1},{targets:"colvis",visible:!1}],pagingType:"full",language:{lengthMenu:"_MENU_",zeroRecords:M.util.get_string("nofound","mod_interactivevideo"),search:'<span class="d-none d-md-inline">'.concat(M.util.get_string("search","mod_interactivevideo"),"</span>"),info:M.util.get_string("datatableinfo","mod_interactivevideo"),infoEmpty:M.util.get_string("datatableinfoempty","mod_interactivevideo"),infoFiltered:M.util.get_string("datatableinfofiltered","mod_interactivevideo"),paginate:{first:'<i class="bi bi-chevron-double-left fs-unset"></i>',last:'<i class="bi bi-chevron-double-right fs-unset"></i>',next:'<i class="bi bi-chevron-right fs-unset"></i>',previous:'<i class="bi bi-chevron-left fs-unset"></i>'},select:{rows:{_:M.util.get_string("rowsselected","mod_interactivevideo")}}},select:{style:"multi",selector:'td:first-child input[type="checkbox"]'},stateSaveParams:function(settings,data){return data.search.search="",data.start=0,data.columns.forEach((function(column){column.search.search=""})),data.columns.forEach((function(column){!1===column.visible&&(column.visible=!0)})),data},stateSave:!0,dom:"<'d-flex w-100 justify-content-between'<'d-flex align-items-center'Bl>'<''f>><'#filterregion.w-100 row mx-0 my-2 p-3 bg-light rounded border'>t<'row mt-2'<'col-sm-6'i><'col-sm-6'p>>",buttons:[{extend:"copyHtml5",text:'<i class="bi bi-copy fa-fw fs-unset"></i>',className:"btn btn-sm border-0",messageTop:null,title:null,exportOptions:exportOptions},{extend:"csvHtml5",text:'<i class="bi bi-filetype-csv fa-fw fs-unset"></i>',className:"btn btn-sm border-0",exportOptions:exportOptions},{extend:"excelHtml5",text:'<i class="bi bi-file-earmark-excel fa-fw fs-unset"></i>',className:"btn btn-sm border-0",exportOptions:exportOptions},{extend:"colvis",text:'<i class="bi bi-layout-three-columns fa-fw fs-unset"></i>',titleAttr:"",className:"btn btn-sm border-0",columns:".colvis"}],footerCallback:function(){var api=this.api(),rowCount=api.rows({filter:"applied"}).count();function findColIndex(prop){return columns.findIndex((function(col){return col.data===prop}))}var timecreatedIdx=findColIndex("timecreated"),timecompletedIdx=findColIndex("timecompleted"),completionpercentageIdx=findColIndex("completionpercentage"),xpIdx=findColIndex("xp"),countTimecreated=api.column(timecreatedIdx,{filter:"applied"}).data().reduce((function(acc,val){return acc+(val&&val>0?1:0)}),0),timecreatedPerc=(countTimecreated/rowCount*100).toFixed(1)+"%";0===rowCount&&(timecreatedPerc="0%");var countTimecompleted=api.column(timecompletedIdx,{filter:"applied"}).data().reduce((function(acc,val){return acc+(val&&val>0?1:0)}),0),timecompletedPerc=(countTimecompleted/rowCount*100).toFixed(1)+"%";0===rowCount&&(timecompletedPerc="0%");var xpData=api.column(xpIdx,{filter:"applied"}).data().toArray();xpData=xpData.map((x=>parseFloat(x)||0));var minXP=Math.min(...xpData),maxXP=Math.max(...xpData),avgXp=(xpData.reduce((function(acc,val){return acc+val}),0)/rowCount).toFixed(1);0===rowCount&&(avgXp="0",minXP="0",maxXP="0");var cpData=api.column(completionpercentageIdx,{filter:"applied"}).data().toArray();cpData=cpData.map((x=>parseFloat(x)||0));var minCp=Math.min(...cpData),maxCp=Math.max(...cpData),avgCp=(cpData.reduce((function(acc,val){return acc+val}),0)/rowCount).toFixed(1)+"%";0===rowCount&&(avgCp="0%",minCp="0",maxCp="0"),api.column(timecreatedIdx).footer()&&(api.column(timecreatedIdx).footer().innerHTML="<small>"+M.util.get_string("started","mod_interactivevideo")+"</small><br>"+timecreatedPerc+" ("+countTimecreated+"/"+rowCount+")"),api.column(timecompletedIdx).footer()&&(api.column(timecompletedIdx).footer().innerHTML="<small>"+M.util.get_string("completed","mod_interactivevideo")+"</small><br>"+timecompletedPerc+" ("+countTimecompleted+"/"+rowCount+")"),api.column(xpIdx).footer()&&(api.column(xpIdx).footer().innerHTML="<small>"+M.util.get_string("avg","mod_interactivevideo")+" ("+M.util.get_string("min","mod_interactivevideo")+"/"+M.util.get_string("max","mod_interactivevideo")+")</small><br>"+avgXp+" ("+minXP+"/"+maxXP+")"),api.column(completionpercentageIdx).footer()&&(api.column(completionpercentageIdx).footer().innerHTML="<small>"+M.util.get_string("avg","mod_interactivevideo")+" ("+M.util.get_string("min","mod_interactivevideo")+"/"+M.util.get_string("max","mod_interactivevideo")+")</small><br>"+avgCp+" ("+minCp+"/"+maxCp+")"),columns.forEach((function(column){if(column.itemid){var itemid=column.itemid,itemIdx=columns.findIndex((col=>col.itemid===itemid)),itemPerc=(api.column(itemIdx,{filter:"applied"}).data().reduce((function(acc,val){let completiondetails;try{completiondetails=JSON.parse(val.completiondetails).map((x=>JSON.parse(x)))}catch(e){return acc}let details=completiondetails.find((x=>Number(x.id)==Number(itemid)));return details?details.deleted?acc:acc+1:acc}),0)/rowCount*100).toFixed(1)+"%";0===rowCount&&(itemPerc="0%"),api.column(itemIdx).footer()&&(api.column(itemIdx).footer().innerHTML=itemPerc)}}))},initComplete:function(){hasCompletion&&(0,_jquery.default)("#completiontable th .controls").removeClass("d-none"),0==itemids.length&&(0,_jquery.default)("#completiontable th .controls").addClass("d-none"),(0,_jquery.default)("table#completiontable").wrap("<div style='overflow:auto;position:relative' class='completiontablewrapper my-2'></div>"),(0,_jquery.default)("#reporttable .dataTables_length ").addClass("d-inline ml-1"),(0,_jquery.default)("#reporttable .dataTables_filter").addClass("d-inline float-right"),(0,_jquery.default)("#reporttable .table-responsive").addClass("p-1"),(0,_jquery.default)("#reporttable .spinner-grow").remove(),(0,_jquery.default)("table#completiontable").removeClass("d-none"),(0,_jquery.default)("#background-loading").fadeOut(300),(0,_jquery.default)('<a class="btn btn-sm btn-secondary font-weight-bold ml-1 d-inline-block"\n                    href="javascript:void(0)" id="filters"\n                    title="Filter"><i class="bi bi-funnel left fa-fw fs-unset"></i></a>').insertAfter(".dataTables_filter label"),(0,_jquery.default)(document).off("click","#filters").on("click","#filters",(function(){(0,_jquery.default)("#filterregion").slideToggle("fast","swing"),(0,_jquery.default)(this).find("i").toggleClass("bi-funnel bi-funnel-fill")})),(0,_jquery.default)("#filterregion").css("display","none"),profileFields.forEach((element=>{(0,_jquery.default)((element=>{let input="";switch(element.type){case"text":case"textarea":case"url":case"email":default:input='<input type="text" class="form-control form-control-sm" id="filter-'.concat(element.index,'"\n                         data-index="').concat(element.index,'"/>');break;case"menu":var options=data.map((x=>x[element.name]));(options=(options=[...new Set(options)]).filter((x=>""!==x))).length>1?(options.sort(),input='<select class="custom-select custom-select-sm w-100" multiple id="filter-'.concat(element.index,'"\n                         data-index="').concat(element.index,'">\n                            ').concat(options.map((x=>'<option value="'.concat(x,'">').concat(x,"</option>"))).join(""),"\n                        </select>")):input='<input type="text" class="form-control form-control-sm" id="filter-'.concat(element.index,'"\n                         data-index="').concat(element.index,'"/>');break;case"checkbox":var optionsc=data.map((x=>x[element.name]));(optionsc=(optionsc=[...new Set(optionsc)]).filter((x=>""!==x))).length>1?(optionsc.sort(),input='<select class="custom-select custom-select-sm w-100" multiple id="filter-'.concat(element.index,'"\n                         data-index="').concat(element.index,'">\n                            ').concat(optionsc.map((x=>'<option value="'.concat(x,'">').concat(x,"</option>"))).join(""),"\n                        </select>")):input='<input type="text" class="form-control form-control-sm" id="filter-'.concat(element.index,'"\n                         data-index="').concat(element.index,'"/>');break;case"datetime":input='<div class="input-group input-group-sm">\n                            <input type="date" class="form-control custom-field" data-index="'.concat(element.index,'"\n                             id="filter-').concat(element.index,'-start"/>\n                            <input type="date" class="form-control custom-field" data-index="').concat(element.index,'"\n                             id="filter-').concat(element.index,'-end"/>\n                        </div>')}return'<div class="col-sm-6 col-md-4 col-lg-3 col-xl-'.concat("datetime"==element.type?"4":"2",' pl-0 pr-2 mb-2">\n                                    <div class="form-group mb-1">\n                                    <label for="filter-').concat(element.index,'">').concat(element.text,"</label>\n                                        ").concat(input,"\n                                    </div>\n                                </div>")})(element)).appendTo("#filterregion")})),(0,_jquery.default)("#filterregion .custom-select[multiple]").select2({dropdownParent:(0,_jquery.default)("body"),width:"100%",placeholder:M.util.get_string("select","mod_interactivevideo"),allowClear:!0}),(0,_jquery.default)(".custom-select").on("select2:open",(function(e){const evt="scroll.select2";(0,_jquery.default)(e.target).parents().off(evt),(0,_jquery.default)(window).off(evt)})),(0,_jquery.default)("#filterregion").append('<div class="col-sm-6 col-md-4 col-lg-3 col-xl-4 pl-0 pr-2 mb-2">\n                    <div class="form-group mb-1" id="timecreatedrange">\n                    <label for="timecreatedrange">'.concat(M.util.get_string("timecreatedrange","mod_interactivevideo"),'</label>\n                    <div class="input-group input-group-sm">\n                        <input type="date" class="form-control" id="timecreatedstart"/>\n                        <input type="date" class="form-control" id="timecreatedend"/>\n                    </div>\n                    </div>\n                </div>\n                <div class="col-sm-6 col-md-4 col-lg-3 col-xl-4 pl-0 pr-2 mb-2">\n                    <div class="form-group mb-1" id="timecompletedrange">\n                    <label for="timecompletedrange">').concat(M.util.get_string("timecompletedrange","mod_interactivevideo"),'</label>\n                    <div class="input-group input-group-sm">\n                        <input type="date" class="form-control" id="timecompletedstart"/>\n                        <input type="date" class="form-control" id="timecompletedend"/>\n                    </div>\n                    </div>\n                </div>\n                ')),(0,_jquery.default)("#filterregion").append('<div class="col-12 p-0 mx-0">\n                    <span class="text-muted small">'.concat(M.util.get_string("separatesearchtermsbyslash","mod_interactivevideo"),"</span>\n                    </div>"))}};(0,_jquery.default)("#reporttable th.rotate").each((function(){const itemid=(0,_jquery.default)(this).data("item").toString(),ctype=(0,_jquery.default)(this).data("type");datatableOptions.columns.push({data:null,itemid:itemid,sortable:!1,className:"text-center exportable data-cell",render:function(data,rtype,row){let completiondetails;try{completiondetails=JSON.parse(data.completiondetails).map((x=>JSON.parse(x)))}catch(e){completiondetails=[]}let details=completiondetails.find((x=>Number(x.id)==Number(itemid)));if(details){if(details.deleted)return"display"===rtype?'<i class="bi bi-trash3 text-muted"\n                             title="'.concat(M.util.get_string("deletedbyinstructor","mod_interactivevideo"),'"></i>'):"-";let res='<span class="completion-detail '.concat(details.hasDetails?"cursor-pointer":"",'"\n                                 data-id="').concat(itemid,'" data-userid="').concat(row.id,'" data-type="').concat(ctype,'">').concat(details.reportView,"</span>");return 1==access.canedit&&(res+='<i class="bi bi-trash3 fs-unset text-danger cursor-pointer position-absolute delete-cell"\n                                  title="'.concat(M.util.get_string("delete","mod_interactivevideo"),'"></i>')),res}return"-"},createdCell:function(td){(0,_jquery.default)(td).attr("data-item",itemid),(0,_jquery.default)(td).attr("data-type",ctype)}})}));let $tfoot=(0,_jquery.default)("<tfoot></tfoot>"),$tr=(0,_jquery.default)("<tr></tr>");columns.forEach((function(column){let $td=(0,_jquery.default)("<td></td>");column.data&&$td.attr("id",column.data),column.itemid&&$td.attr("data-item",column.itemid),$tr.append($td)})),$tfoot.append($tr),(0,_jquery.default)("#completiontable").append($tfoot),tabledata=(0,_jquery.default)("#completiontable").DataTable(datatableOptions),tabledata.on("draw",(function(){(0,_jquery.default)("tr.selected td.checkbox input").prop("checked",!0),(0,_jquery.default)("tr:not(.selected) td.checkbox input").prop("checked",!1)})),tabledata.on("search",(function(){tabledata.rows().deselect()})),tabledata.on("select deselect",(function(e){e.stopImmediatePropagation();var selectedRows=tabledata.rows({selected:!0});selectedRows.every((function(){var row=this.node();(0,_jquery.default)(row).find("td:first-child input").prop("checked",!0)})),tabledata.rows({selected:!1}).every((function(){var row=this.node();(0,_jquery.default)(row).find("td:first-child input").prop("checked",!1)})),(0,_jquery.default)("#bulkactions").remove(),selectedRows.count()>0&&selectedRows.count()<=20&&(0,_jquery.default)("#completiontable_length").after('<div class="d-flex align-items-center" id="bulkactions">\n                    <button class="btn btn-sm btn-danger ml-1" id="bulkdelete">\n                        <i class="bi bi-trash3 mr-1 fs-unset"></i>'.concat(M.util.get_string("delete","mod_interactivevideo"),"\n                         (").concat(selectedRows.count(),")\n                    </button>\n                    </div>"))})),(0,_jquery.default)("#filterregion :input:not([type=date])").on("keyup change",(function(){let index=(0,_jquery.default)(this).data("index"),value=(0,_jquery.default)(this).val();"string"!=typeof value&&(value=value.join("|"));let regex=value.split("|").map((term=>term.trim())).filter((term=>term.length>0)).join("|");tabledata.column(index).search(regex,!0,!1).draw()})),(0,_jquery.default)("#filterregion :input[type=date].custom-field").on("change",(function(){let index=(0,_jquery.default)(this).data("index");_jquery.default.fn.dataTable.ext.search.push((function(settings,data){if("completiontable"!==settings.nTable.id)return!0;let start=(0,_jquery.default)("#filter-".concat(index,"-start")).val();""!==start&&(start=new Date(start),start.setHours(0,0,0));let end=(0,_jquery.default)("#filter-".concat(index,"-end")).val();""!==end&&(end=new Date(end),end.setHours(23,59,59));let value=data[index];return(isNaN(value)||""==value)&&(value=0),value*=1e3,(""===start&&""===end||0!=value)&&(""===start&&""===end||""===start&&value<=new Date(end).getTime()||""===end&&value>=new Date(start).getTime()||value>=new Date(start).getTime()&&value<=new Date(end).getTime())})),tabledata.draw()})),(0,_jquery.default)("#reporttable th#timecreated input").on("click",(function(e){e.stopPropagation();let index=columns.findIndex((x=>"timecreated"===x.data)),started=(0,_jquery.default)("th#timecreated input[data-start=true]").is(":checked"),notstarted=(0,_jquery.default)("th#timecreated input[data-start=false]").is(":checked");started&&notstarted?tabledata.column(index).search("",!0,!1).draw():started?tabledata.column(index).search("^(?!0$)",!0,!1).draw():notstarted?tabledata.column(index).search("^0$",!0,!1).draw():tabledata.column(index).search("-",!0,!1).draw()})),(0,_jquery.default)("#reporttable th#timecompleted input").on("click",(function(e){e.stopPropagation();let index=columns.findIndex((x=>"timecompleted"===x.data)),inprogress=(0,_jquery.default)("th#timecompleted input[data-completed=false]").is(":checked"),completed=(0,_jquery.default)("th#timecompleted input[data-completed=true]").is(":checked");inprogress&&completed?tabledata.column(index).search("",!0,!1).draw():inprogress?tabledata.column(index).search("^0$",!0,!1).draw():completed?tabledata.column(index).search("^(?!0$)",!0,!1).draw():tabledata.column(index).search("-",!0,!1).draw()})),(0,_jquery.default)("#reporttable th[data-type] input").on("click",(function(e){e.stopPropagation();let index=columns.findIndex((x=>x.itemid==(0,_jquery.default)(this).data("item")));(0,_jquery.default)(this).is(":checked")?tabledata.column(index).search("^(?!-$)",!0,!1).draw():tabledata.column(index).search("",!0,!1).draw()})),(0,_jquery.default)("#reporttable th#completionpercentage input").on("click",(function(e){e.stopPropagation();let $this=(0,_jquery.default)(this);_jquery.default.fn.dataTable.ext.search.push((function(settings,data){if("completiontable"!==settings.nTable.id)return!0;let index=columns.findIndex((x=>"completionpercentage"===x.data)),percent=$this.data("percentage"),showless=(0,_jquery.default)("th#completionpercentage input.less").is(":checked"),showmore=(0,_jquery.default)("th#completionpercentage input.more").is(":checked"),value=data[index];return value=parseInt(value.replace("%","")),!(!showless||!showmore)||(showless?value<percent:!!showmore&&value>=percent)})),tabledata.draw()})),(0,_jquery.default)("#filterregion #timecreatedrange input").on("change",(function(){_jquery.default.fn.dataTable.ext.search.push((function(settings,data){if("completiontable"!==settings.nTable.id)return!0;let start=(0,_jquery.default)("#timecreatedstart").val();""!==start&&(start=new Date(start),start.setHours(0,0,0));let end=(0,_jquery.default)("#timecreatedend").val();""!==end&&(end=new Date(end),end.setHours(23,59,59));let value=data[columns.findIndex((x=>"timecreated"===x.data))];return(""===start&&""===end||0!=value)&&(""===start&&""===end||""===start&&value<=new Date(end).getTime()||""===end&&value>=new Date(start).getTime()||value>=new Date(start).getTime()&&value<=new Date(end).getTime())})),tabledata.draw()})),(0,_jquery.default)("#filterregion #timecompletedrange input").on("change",(function(){_jquery.default.fn.dataTable.ext.search.push((function(settings,data){if("completiontable"!==settings.nTable.id)return!0;let start=(0,_jquery.default)("#timecompletedstart").val();""!==start&&(start=new Date(start),start.setHours(0,0,0));let end=(0,_jquery.default)("#timecompletedend").val();""!==end&&(end=new Date(end),end.setHours(23,59,59));let value=data[columns.findIndex((x=>"timecompleted"===x.data))];return(""===start&&""===end||0!=value)&&(""===start&&""===end||""===start&&value<=new Date(end).getTime()||""===end&&value>=new Date(start).getTime()||value>=new Date(start).getTime()&&value<=new Date(end).getTime())})),tabledata.draw()})),(0,_jquery.default)(document).on("click","td.data-cell .delete-cell",(function(e){if(e.preventDefault(),1!=access.canedit)return;let $this=(0,_jquery.default)(this).closest("td"),itemid=$this.data("item");if("-"===$this.text()||""===$this.text())return;let userid=$this.closest("tr").attr("id"),userfullname=$this.closest("tr").find("td").eq(0).text(),recordid=$this.closest("tr").find("td").eq(0).find("button").data("record"),cellIndex=$this.index(),title=$this.closest("table").find("th").eq(cellIndex).text();const deleteCompletionData=async()=>{let type=$this.data("type"),amdmodule=contentTypes.find((x=>x.name===type)).amdmodule,theAnnotation=itemsdata.find((x=>x.id==itemid));require([amdmodule],(function(Module){if(new Module(undefined,itemsdata,cmid,courseid,null,completionpercentage,null,grademax,videotype,null,end-start,start,end,theAnnotation.prop,cm).deleteCompletionData(recordid,itemid,userid)){let targetdata=tabledata.row($this.closest("tr")).data();targetdata.completeditems=JSON.stringify(JSON.parse(targetdata.completeditems).filter((x=>x.id!=itemid)));let completiondetails=JSON.parse(targetdata.completiondetails);completiondetails=completiondetails.map((x=>((x=JSON.parse(x)).id==itemid&&(x.hasDetails=!0,x.deleted=!0,x.reportView='<i class="bi bi-trash3 text-danger"></i>'),JSON.stringify(x)))),targetdata.completiondetails=JSON.stringify(completiondetails),tabledata.row($this.closest("tr")).data(targetdata).draw(),(0,_toast.add)(M.util.get_string("completedeletedforthisitem","mod_interactivevideo",{item:title,user:userfullname}),{type:"success"})}else(0,_toast.add)(M.util.get_string("completionreseterror","mod_interactivevideo"),{type:"error"})}))};try{_notification.default.deleteCancelPromise(M.util.get_string("deletecompletion","mod_interactivevideo"),M.util.get_string("deleterecordforitemforuserconfirm","mod_interactivevideo",{item:title,user:userfullname}),M.util.get_string("delete","mod_interactivevideo")).then((async()=>deleteCompletionData())).catch((()=>{}))}catch{_notification.default.saveCancel(M.util.get_string("deletecompletion","mod_interactivevideo"),M.util.get_string("deleterecordforitemforuserconfirm","mod_interactivevideo",{item:title,user:userfullname}),M.util.get_string("delete","mod_interactivevideo"),(function(){return deleteCompletionData()}))}})),initonreport.forEach((type=>{let amdmodule=contentTypes.find((x=>x.name===type)).amdmodule;require([amdmodule],(function(Module){new Module(undefined,itemsdata,cmid,courseid,null,completionpercentage,null,grademax,videotype,null,end-start,start,end,null,cm).init()}))}))})),(0,_jquery.default)(document).on("click","[data-item] a",(function(){let annotationid=(0,_jquery.default)(this).closest("th").data("item"),theAnnotation=itemsdata.find((x=>x.id==annotationid)),tabledatajson=tabledata.rows().data().toArray(),title=theAnnotation.formattedtitle;theAnnotation.timestamp>0&&(title+=" @ "+(seconds=>{const h=Math.floor(seconds/3600),m=Math.floor(seconds%3600/60),s=Math.floor(seconds%3600%60);return(h>0?h+":":"")+(m<10?"0":"")+m+":"+(s<10?"0":"")+s})(theAnnotation.timestamp));const modal='<div class="modal fade" id="annotation-modal" role="dialog"\n            aria-labelledby="annotation-modal"\n         aria-hidden="true" data-backdrop="static" data-keyboard="false">\n         <div id="message" data-id="'.concat(theAnnotation.id,'" data-placement="popup"\n          class="modal-dialog modal-xl modal-dialog-centered modal-dialog-scrollable ').concat(theAnnotation.type,'" role="document">\n            <div class="modal-content rounded-lg">\n                <div class="modal-header d-flex align-items-center shadow-sm" id="title">\n                    <h5 class="modal-title text-truncate mb-0">').concat(title,'</h5>\n                    <div class="btns d-flex align-items-center">\n                        <button class="btn close-modal p-0 border-0" aria-label="Close" data-dismiss="modal">\n                        <i class="bi bi-x-lg fa-fw fs-25px"></i>\n                        </button>\n                    </div>\n                </div>\n                <div class="modal-body" id="content">\n                <div class="loader w-100 mt-5"></div>\n                </div>\n                </div>\n            </div>\n            </div>');(0,_jquery.default)("body").append(modal),(0,_jquery.default)("#annotation-modal").modal("show"),(0,_jquery.default)("#annotation-modal").on("hide.bs.modal",(function(){(0,_jquery.default)("#annotation-modal").remove()})),(0,_jquery.default)("#annotation-modal").on("shown.bs.modal",(function(){(0,_jquery.default)("#annotation-modal .modal-body").fadeIn(300);let amdmodule=contentTypes.find((x=>x.name===theAnnotation.type)).amdmodule;require([amdmodule],(function(Module){theAnnotation.completed=!0,new Module(undefined,itemsdata,cmid,courseid,null,completionpercentage,null,grademax,videotype,null,end-start,start,end,theAnnotation.prop,cm).displayReportView(theAnnotation,tabledatajson,DataTable)})),(0,_jquery.default)(this).find(".close-modal").focus()}))})),(0,_jquery.default)(document).on("click","td .reset",(function(e){e.preventDefault();const recordid=(0,_jquery.default)(this).data("record");let $this=(0,_jquery.default)(this);const deleteSingle=async()=>_jquery.default.ajax({url:M.cfg.wwwroot+"/mod/interactivevideo/ajax.php",method:"POST",dataType:"text",data:{action:"delete_progress_by_id",recordid:recordid,courseid:courseid,cmid:cmid,contextid:M.cfg.contextid,sesskey:M.cfg.sesskey},success:function(response){if("deleted"==response){let targetdata=tabledata.row($this.closest("tr")).data();targetdata.completionpercentage=0,targetdata.timecompleted=0,targetdata.xp=0,targetdata.timecreated=0,targetdata.completeditems=null,targetdata.completiondetails=null,targetdata.completionid=null,tabledata.row($this.closest("tr")).data(targetdata).draw(),(0,_toast.add)(M.util.get_string("completionresetsuccess","mod_interactivevideo"),{type:"success"})}},error:function(){(0,_toast.add)(M.util.get_string("completionreseterror","mod_interactivevideo"),{type:"error"})}});try{_notification.default.deleteCancelPromise(M.util.get_string("deletecompletion","mod_interactivevideo"),M.util.get_string("areyousureyouwanttoresetthecompletiondata","mod_interactivevideo"),M.util.get_string("delete","mod_interactivevideo")).then((()=>deleteSingle())).catch((()=>{}))}catch{_notification.default.saveCancel(M.util.get_string("deletecompletion","mod_interactivevideo"),M.util.get_string("areyousureyouwanttoresetthecompletiondata","mod_interactivevideo"),M.util.get_string("delete","mod_interactivevideo"),(function(){return deleteSingle()}))}})),(0,_jquery.default)(document).on("click","#bulkdelete",(function(){let selectedRows=tabledata.rows({selected:!0}),selectedData=selectedRows.data().toArray(),selectedIds=selectedData.map((x=>x.completionid)),selectedUsers=selectedData.map((x=>x.id));const bulkDeleteCompletionData=async()=>_jquery.default.ajax({url:M.cfg.wwwroot+"/mod/interactivevideo/ajax.php",method:"POST",dataType:"text",data:{action:"delete_progress_by_ids",completionids:selectedIds.join(","),courseid:courseid,cmid:cmid,contextid:M.cfg.contextid,sesskey:M.cfg.sesskey},success:function(response){"deleted"==response&&(selectedRows.every((function(){let targetdata=this.data();targetdata.completionpercentage=0,targetdata.timecompleted=0,targetdata.xp=0,targetdata.timecreated=0,targetdata.completeditems=null,targetdata.completiondetails=null,targetdata.completionid=null,tabledata.row(this.node()).data(targetdata)})),tabledata.draw(),(0,_toast.add)(M.util.get_string("completionresetsuccess","mod_interactivevideo"),{type:"success"}))},error:function(){(0,_toast.add)(M.util.get_string("completionreseterror","mod_interactivevideo"),{type:"error"})}});try{_notification.default.deleteCancelPromise(M.util.get_string("deletecompletion","mod_interactivevideo"),M.util.get_string("deleterecordforselectedusers","mod_interactivevideo",selectedUsers.length),M.util.get_string("delete","mod_interactivevideo")).then((async()=>bulkDeleteCompletionData())).catch((()=>{}))}catch{_notification.default.saveCancel(M.util.get_string("deletecompletion","mod_interactivevideo"),M.util.get_string("deleterecordforselectedusers","mod_interactivevideo",selectedUsers.length),M.util.get_string("delete","mod_interactivevideo"),(function(){return bulkDeleteCompletionData()}))}})),(0,_jquery.default)(document).on("click","td .completion-detail",(function(){let id=(0,_jquery.default)(this).data("id"),userid=(0,_jquery.default)(this).data("userid"),type=(0,_jquery.default)(this).data("type"),amdmodule=contentTypes.find((x=>x.name===type)).amdmodule,theAnnotation=itemsdata.find((x=>x.id==id));require([amdmodule],(function(Module){new Module(undefined,itemsdata,cmid,courseid,null,completionpercentage,null,grademax,videotype,null,end-start,start,end,theAnnotation.prop,cm).getCompletionData(theAnnotation,userid)}))}))};_exports.renderAnnotationLogs=(data,node,title)=>{let tableOptions={data:data.rows,deferRender:!0,pageLength:25,order:[[0,"asc"]],columnDefs:[{targets:"not-sortable",sortable:!1}],pagingType:"full",language:{lengthMenu:"_MENU_",zeroRecords:M.util.get_string("nofound","mod_interactivevideo"),search:'<span class="d-none d-md-inline">'.concat(M.util.get_string("search","mod_interactivevideo"),"</span>"),info:M.util.get_string("datatableinfo","mod_interactivevideo"),infoEmpty:M.util.get_string("datatableinfoempty","mod_interactivevideo"),infoFiltered:M.util.get_string("datatableinfofiltered","mod_interactivevideo"),paginate:{first:'<i class="bi bi-chevron-double-left fs-unset"></i>',last:'<i class="bi bi-chevron-double-right fs-unset"></i>',next:'<i class="bi bi-chevron-right fs-unset"></i>',previous:'<i class="bi bi-chevron-left fs-unset"></i>'},select:{rows:{_:M.util.get_string("rowsselected","mod_interactivevideo")}}},stateSaveParams:function(settings,data){return data.search.search="",data.start=0,data.columns.forEach((function(column){column.search.search=""})),data},stateSave:!0,dom:"Blft<'row'<'col-sm-6'i><'col-sm-6'p>>",buttons:[{extend:"copyHtml5",text:'<i class="bi bi-copy fa-fw fs-unset"></i>',className:"btn btn-sm border-0",messageTop:null,title:null,exportOptions:{columns:[".exportable"],format:{body:function(data){const text=document.createElement("div");return text.innerHTML=data,text.textContent.replace(/\n/g," ").replace(/\t/g," ").replace(/\r/g," ")}}}},{extend:"csvHtml5",text:'<i class="bi bi-filetype-csv fa-fw fs-unset"></i>',title:title,className:"btn btn-sm border-0",exportOptions:{columns:[".exportable"]}},{extend:"excelHtml5",text:'<i class="bi bi-file-earmark-excel fa-fw fs-unset"></i>',className:"btn btn-sm border-0",title:title,exportOptions:{columns:[".exportable"]}}],initComplete:function(){(0,_jquery.default)("".concat(node," table")).wrap("<div style='overflow:auto;position:relative;width:100%' class='completiontablewrapper'></div>"),(0,_jquery.default)("".concat(node," .dataTables_length")).addClass("d-inline ml-1"),(0,_jquery.default)("".concat(node," .dataTables_filter")).addClass("d-inline float-right"),(0,_jquery.default)("".concat(node," .table-responsive")).addClass("p-1")}};(0,_jquery.default)("".concat(node," table")).DataTable(tableOptions)}}));

//# sourceMappingURL=report.min.js.map