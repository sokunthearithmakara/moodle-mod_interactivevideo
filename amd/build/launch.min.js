var _systemImportTransformerGlobalIdentifier="undefined"!=typeof window?window:"undefined"!=typeof self?self:"undefined"!=typeof global?global:{};
/**
 * Launch the interactive video in modal on course page
 *
 * @module     mod_interactivevideo/launch
 * @copyright  2024 Sokunthearith Makara <sokunthearithmakara@gmail.com>
 * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
 */define("mod_interactivevideo/launch",["jquery","core/str","core/templates"],(function($,str,Templates){return{init:async function(){let ModalForm,addToast;$(document).on("click",".launch-interactivevideo",(async function(e){let title=document.title,showcontrols=!!localStorage.getItem("showcontrols");e.preventDefault();const id=$(this).data("id"),instance=$(this).data("instance"),course=$(this).data("course"),contextid=$(this).data("contextid"),$card=$(this).closest("#interactivevideo-"+instance);$card.find(".image-container").addClass("hovered");let dataForTemplate={id:id,showcontrols:showcontrols,root:M.cfg.wwwroot};const modal=await Templates.render("mod_interactivevideo/playermodal",dataForTemplate);$("#playermodal").remove(),$("body").append(modal),$("#playermodal").modal("show");const headerFunction=function(){let $header=$("#playermodal .modal-header");$header.hasClass("show")||($header.addClass("show"),$header.fadeIn(),$("#playermodal").hasClass("locked")||setTimeout((function(){$header.removeClass("show"),$header.fadeOut()}),5e3))};let iframeDoc,iframeAnnos,details,player;$("#playermodal").on("shown.bs.modal",(function(){$("body").addClass("overflow-hidden"),$(this).find(".modal-header").addClass("show"),localStorage.getItem("lock-bar")&&$(this).find(".lock-bar").trigger("click");let $completion=$card.find("[data-region=activity-information]");$completion=$completion.clone(),$(this).find('[data-region="activity-completion"]').html($completion);let checkIframeDoc=function(){try{iframeDoc=document.getElementById("ivplayer").contentDocument}catch(e){return void cancelAnimationFrame(checkIframeDoc)}if(iframeAnnos=document.getElementById("ivplayer").contentWindow.IVANNO,iframeDoc.getElementById("player"))if($("#background-loading").hide(0),iframeAnnos)if(player=document.getElementById("ivplayer").contentWindow.IVPLAYER,iframeDoc.getElementById("player")){$("#playermodal .modal-header").removeClass("show"),$("#playermodal .toggle-controls").removeClass("d-none"),showcontrols||setTimeout((function(){$("#playermodal .modal-content").removeClass("show-control")}),1e3),$("#playermodal .toggle-controls").on("click",(function(){$("#playermodal .modal-content").toggleClass("show-control"),showcontrols=$("#playermodal .modal-content").hasClass("show-control"),showcontrols?localStorage.setItem("showcontrols","1"):localStorage.removeItem("showcontrols")})),iframeDoc.addEventListener("annotationitemsrendered",(function(e){details=e.detail})),$(iframeDoc).on("mousemove","#video-wrapper",(function(){if($("#playermodal").hasClass("locked"))return;let $message=iframeDoc.querySelector("#message:not(.sticky)"),$activestart=iframeDoc.querySelector("#start-screen:not(.d-none) .hasintro");$message||$activestart?$("#playermodal .modal-header").removeClass("show"):headerFunction()})),iframeDoc.addEventListener("videoPaused",(function(){if($("#playermodal").hasClass("locked"))return;let $message=iframeDoc.querySelector("#message:not(.sticky)"),$activestart=iframeDoc.querySelector("#start-screen:not(.d-none) .hasintro");$message||$activestart?$("#playermodal .modal-header").removeClass("show"):headerFunction(),$("#playermodal .toggle-controls").fadeOut(300)})),iframeDoc.addEventListener("iv:playerPlaying",(function(){$("#playermodal .toggle-controls").fadeIn(300)}));let $progressbar=$card.find(".analytics.progress .progress-bar");if(0==$progressbar.length)return;let current=$progressbar.data("current");iframeDoc.addEventListener("analyticsupdated",(function(e){let percentage=e.detail.percentage;percentage>current&&($progressbar.css("width",percentage+"%").data("current",percentage),$card.find(".analytics-percentage").text(Math.round(percentage)))}))}else requestAnimationFrame(checkIframeDoc);else requestAnimationFrame(checkIframeDoc);else requestAnimationFrame(checkIframeDoc)};requestAnimationFrame(checkIframeDoc),$(this).off("hidden.bs.modal").on("hidden.bs.modal",(function(){cancelAnimationFrame(checkIframeDoc)})),$(document).off("click",'#playermodal [data-action="toggle-manual-completion"]').on("click",'#playermodal [data-action="toggle-manual-completion"]',(function(){$(this).parent().addClass("updated"),1==$(this).data("withavailability")&&history.pushState(null,null,M.cfg.wwwroot+"/course/view.php?id="+course+"#module-"+id)})),history.pushState(null,null,M.cfg.wwwroot+"/mod/interactivevideo/view.php?id="+id);let activitytitle=$card.data("title");document.title=activitytitle})),$("#playermodal").on("hide.bs.modal",(async function(){if($("body").removeClass("overflow-hidden"),setTimeout((function(){$card.find(".image-container").removeClass("hovered")}),1e3),!player)return void $(this).remove();if(await player.pause(),$card.find(".automatic-completion-conditions").length>0){const completion=await $.ajax({url:M.cfg.wwwroot+"/mod/interactivevideo/ajax.php",method:"POST",dataType:"text",data:{action:"get_cm_completion",cmid:id,sesskey:M.cfg.sesskey,contextid:contextid,courseid:course,userid:M.cfg.userId||0}});if(completion){const completiondata=JSON.parse(completion);$card.find("[data-region=activity-information]").html($(completiondata.completion).html())}}let $manualcompletion=$(this).find(".completion-info.updated");if($manualcompletion.length>0&&$card.find(".completion-info").html($manualcompletion.html()),details){let progressbar=$card.find(".tasks .progress-bar");progressbar.length>0&&(progressbar.css("width",Math.round(details.completed/details.total*100)+"%"),details.completed==details.total?progressbar.addClass("bg-success").removeClass("bg-primary"):progressbar.removeClass("bg-success").addClass("bg-primary"),$card.find(".percentage").text(Math.round(details.completed/details.total*100)),$card.find(".items").text("(".concat(details.completed,"/").concat(details.total,")")),$card.find(".xp").text(details.xp))}history.pushState(null,null,M.cfg.wwwroot+"/course/view.php?id="+course),document.title=title,iframeAnnos&&$card.find(".new-badge").remove(),$card.closest(".modtype_interactivevideo")[0].scrollIntoView({behavior:"smooth",block:"center",inline:"center"}),iframeDoc&&$(iframeDoc).off()})),window.onpopstate=function(e){"/course/view.php"==e.target.location.pathname&&$("#playermodal").modal("hide")},$(document).off("click",".lock-bar").on("click",".lock-bar",(async function(e){e.preventDefault(),$(this).toggleClass("locked"),$("#playermodal").toggleClass("locked"),$(this).hasClass("locked")?($(this).attr("title",await str.get_string("unlock","mod_interactivevideo")),$(this).find("i").removeClass("fa-unlock").addClass("fa-lock"),$("#playermodal .modal-header").addClass("show"),localStorage.setItem("lock-bar","1"),headerFunction()):($(this).attr("title",await str.get_string("lock","mod_interactivevideo")),$(this).find("i").removeClass("fa-lock").addClass("fa-unlock"),localStorage.removeItem("lock-bar"),setTimeout((function(){$("#playermodal .modal-header").removeClass("show")}),5e3))}))})),$(document).on("click",".open-external-link",(function(){$("#playermodal").modal("hide"),window.open($(this).data("href"),"_blank")})),$(document).on("click",".interactivevideo-card .description-show",(function(){$(this).closest(".top-section").find(".description").slideToggle("fast","swing"),$(this).toggleClass("rotate")})),$(document).ready((function(){let hash=window.location.hash;if(hash){let $element=$(hash);$element.length>0&&$element.hasClass("modtype_interactivevideo")&&($element.addClass("highlighted"),setTimeout((()=>{$element[0].scrollIntoView({behavior:"smooth",block:"center",inline:"center"}),setTimeout((function(){$element.removeClass("highlighted")}),3e3)}),1e3))}})),$(document).on("click",".launch-report",(async function(e){e.preventDefault();const href=$(this).data("href");if(!e.ctrlKey&&!e.metaKey)return void(window.location.href=href);const data={id:"reportModal",title:await str.get_string("reportfor","mod_interactivevideo",$(this).data("title")),body:'<iframe src="'.concat(href,'&embed=1"\n                                        style="width: 100%; height: 100%; border: 0; z-index:1050; position:absolute;"></iframe>')};let Modal=await Templates.render("mod_interactivevideo/fullscreenmodal",data);$("body").append(Modal),$("#reportModal").modal("show"),$("#reportModal").on("shown.bs.modal",(function(){$(this).focus()})),$("#reportModal").on("hidden.bs.modal",(function(){$(this).remove()}))})),$(document).on("click",".iv_quickform",(async function(e){const $this=$(this);e.preventDefault();const href=$this.data("href");if(!e.ctrlKey&&!e.metaKey)return void(window.location.href=href);let formdata={contextid:$(this).data("contextid"),cmid:$(this).data("cmid"),courseid:$(this).data("courseid"),interaction:$(this).data("interaction"),origin:"coursepage"};ModalForm||(ModalForm=await("function"==typeof _systemImportTransformerGlobalIdentifier.define&&_systemImportTransformerGlobalIdentifier.define.amd?new Promise((function(resolve,reject){_systemImportTransformerGlobalIdentifier.require(["core_form/modalform"],resolve,reject)})):"undefined"!=typeof module&&module.exports&&"undefined"!=typeof require||"undefined"!=typeof module&&module.component&&_systemImportTransformerGlobalIdentifier.require&&"component"===_systemImportTransformerGlobalIdentifier.require.loader?Promise.resolve(require("core_form/modalform")):Promise.resolve(_systemImportTransformerGlobalIdentifier["core_form/modalform"]))),addToast||(addToast=await("function"==typeof _systemImportTransformerGlobalIdentifier.define&&_systemImportTransformerGlobalIdentifier.define.amd?new Promise((function(resolve,reject){_systemImportTransformerGlobalIdentifier.require(["core/toast"],resolve,reject)})):"undefined"!=typeof module&&module.exports&&"undefined"!=typeof require||"undefined"!=typeof module&&module.component&&_systemImportTransformerGlobalIdentifier.require&&"component"===_systemImportTransformerGlobalIdentifier.require.loader?Promise.resolve(require("core/toast")):Promise.resolve(_systemImportTransformerGlobalIdentifier["core/toast"])));let DynamicForm,form=new ModalForm({formClass:"mod_interactivevideo\\form\\quicksettings_form",args:formdata,modalConfig:{title:await str.get_string("quicksettings","mod_interactivevideo"),removeOnClose:!0}});form.show(),form.addEventListener(form.events.LOADED,(e=>{e.stopImmediatePropagation(),setTimeout((()=>{$(".modal-dialog").removeClass("modal-lg").addClass("modal-xl path-mod-interactivevideo")}),1e3),setTimeout((async()=>{let strings=await str.get_strings([{key:"moresettings",component:"mod_interactivevideo"},{key:"resettodefaults",component:"mod_interactivevideo"}]);$('[data-region="footer"]').css("align-items","unset").prepend('<span class="btn btn-secondary mr-1 default" title="'.concat(strings[1],'">\n                        <i class="fa fa-refresh"></i></span>\n                        <a type="button" class="btn btn-secondary mr-auto" target="_blank" data-dismiss="modal"\n                            title="').concat(strings[0],'"\n                            href="').concat(M.cfg.wwwroot,"/course/modedit.php?update=").concat(formdata.cmid,'"><i class="fa fa-cog"></i>\n                            </a>'))}),2e3)})),form.addEventListener(form.events.FORM_SUBMITTED,(e=>{e.stopImmediatePropagation(),addToast.add(str.get_string("settingssaved","mod_interactivevideo"),{type:"success"});let $newcard=$(e.detail.html);$this.closest(".modtype_interactivevideo").replaceWith($newcard).trigger("click")})),$(document).off("click",".default").on("click",".default",(async function(e){e.preventDefault(),formdata.action="reset",DynamicForm||(DynamicForm=await("function"==typeof _systemImportTransformerGlobalIdentifier.define&&_systemImportTransformerGlobalIdentifier.define.amd?new Promise((function(resolve,reject){_systemImportTransformerGlobalIdentifier.require(["core_form/dynamicform"],resolve,reject)})):"undefined"!=typeof module&&module.exports&&"undefined"!=typeof require||"undefined"!=typeof module&&module.component&&_systemImportTransformerGlobalIdentifier.require&&"component"===_systemImportTransformerGlobalIdentifier.require.loader?Promise.resolve(require("core_form/dynamicform")):Promise.resolve(_systemImportTransformerGlobalIdentifier["core_form/dynamicform"]))),new DynamicForm(document.querySelector('[data-region="body"]'),"mod_interactivevideo\\form\\quicksettings_form").load(formdata),addToast.add(str.get_string("formvaluesarereset","mod_interactivevideo"),{type:"info"})}))}))}}}));

//# sourceMappingURL=launch.min.js.map