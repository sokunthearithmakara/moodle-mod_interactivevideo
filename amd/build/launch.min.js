var _systemImportTransformerGlobalIdentifier="undefined"!=typeof window?window:"undefined"!=typeof self?self:"undefined"!=typeof global?global:{};
/**
 * Launch the interactive video in modal on course page
 *
 * @module     mod_interactivevideo/launch
 * @copyright  2024 Sokunthearith Makara <sokunthearithmakara@gmail.com>
 * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
 */define("mod_interactivevideo/launch",["jquery","core/str","core/templates","core/modal_factory","core/modal_events","core/event_dispatcher"],(function($,str,Templates,ModalFactory,ModalEvents,eventDispatcher){let playerModal;return{init:async function(){const launchVideo=async($card,course,contextid,id)=>{let title=document.title,currentUrl=window.location.href,showcontrols=!!localStorage.getItem("showcontrols"),fullscreen=!!!localStorage.getItem("resized");playerModal&&playerModal.destroy(),playerModal=await ModalFactory.create({body:await Templates.render("mod_interactivevideo/playermodal",{id:id,wwwroot:M.cfg.wwwroot,title:title,fullscreen:fullscreen}),large:!0,show:!1,removeOnClose:!1,isVerticallyCentered:!0});const root=playerModal.getRoot();let rootheader=root.find("#head").html(),rootbody=root.find("#body").html();root.find(".modal-header").addClass("border-0 text-white align-items-center py-0 h-0 position-absolute w-100\n                         z-index-1 iv-rounded-0").empty().append(rootheader),root.find(".modal-body").addClass("p-0").html(rootbody),root.find("#background-loading").show(),root.addClass(fullscreen?"modal-fullscreen iv-rounded-0":"modal-resized"),root.attr("id","playermodal"),root.find(".modal-dialog").addClass("modal-xl "+(fullscreen?"iv-rounded-0":"")).removeClass("modal-lg"),root.find(".modal-content").addClass("border-0 show-control "+(fullscreen?"iv-rounded-0":"")),playerModal.show(),root.find(".toggle-controls").trigger("click");let $header=root.find(".modal-header"),$content=root.find(".modal-content"),$toggle=root.find(".toggle-controls");showcontrols&&!$content.hasClass("show-control")&&$toggle.trigger("click");const headerFunction=function(){$header.hasClass("show")||($header.addClass("show"),$header.fadeIn(),root.hasClass("locked")||setTimeout((function(){$header.removeClass("show"),$header.fadeOut()}),5e3))};let iframeDoc,iframeAnnos,details,player,iframeWindow;root.off(ModalEvents.shown),root.on(ModalEvents.shown,(function(){if($("body").addClass("overflow-hidden"),$header.addClass("show"),localStorage.getItem("lock-bar")&&$(this).find(".lock-bar").trigger("click"),$card){let $completion=$card.find("[data-region=activity-information]");$completion=$completion.clone(),$(this).find('[data-region="activity-completion"]').html($completion)}let checkIframeDoc=function(){try{iframeDoc=document.getElementById("ivplayer").contentDocument}catch(e){return void cancelAnimationFrame(checkIframeDoc)}if(iframeWindow=document.getElementById("ivplayer").contentWindow,iframeAnnos=iframeWindow.IVANNO,!iframeDoc.getElementById("player"))return void requestAnimationFrame(checkIframeDoc);if($("#background-loading").hide(0),!iframeAnnos)return void requestAnimationFrame(checkIframeDoc);player=iframeWindow.IVPLAYER,window.console.log(player),1==player.doptions.hidemainvideocontrols&&(showcontrols=!0,$toggle.remove()),showcontrols?iframeDoc.querySelector("body").classList.add("showcontrols"):iframeDoc.querySelector("body").classList.remove("showcontrols");let nocontrols=!1;if(iframeDoc.getElementById("controller")||($content.addClass("show-control"),$toggle.remove(),nocontrols=!0),iframeDoc.getElementById("player")){if(iframeWindow.focus(),$header.removeClass("show"),$toggle.removeClass("d-none"),showcontrols||nocontrols||setTimeout((function(){$content.removeClass("show-control")}),1e3),$toggle.on("click",(function(){$content.toggleClass("show-control"),showcontrols=$content.hasClass("show-control"),showcontrols?(localStorage.setItem("showcontrols","1"),iframeDoc.querySelector("body").classList.add("showcontrols")):(localStorage.removeItem("showcontrols"),iframeDoc.querySelector("body").classList.remove("showcontrols"))})),iframeDoc.addEventListener("annotationitemsrendered",(function(e){details=e.detail})),$(iframeDoc).on("mousemove","#interactivevideo-container",(function(){if(root.hasClass("locked"))return;let $message=iframeDoc.querySelector("#message:not(.sticky)"),$activestart=iframeDoc.querySelector("#start-screen:not(.d-none) .hasintro");$message||$activestart?$header.removeClass("show"):headerFunction()})),iframeDoc.addEventListener("videoPaused",(function(){if(root.hasClass("locked"))return;let $message=iframeDoc.querySelector("#message:not(.sticky)"),$activestart=iframeDoc.querySelector("#start-screen:not(.d-none) .hasintro");$message||$activestart?$header.removeClass("show"):headerFunction(),$toggle.fadeOut(300)})),iframeDoc.addEventListener("iv:playerPlay",(function(){window.console.log("iv:playerPlay"),$toggle.fadeIn(300)})),iframeDoc.addEventListener("iv:playerReload",(function(e){player=e.detail.player})),null===$card)return;let $progressbar=$card.find(".analytics.progress .progress-bar");if(0==$progressbar.length)return;let current=$progressbar.data("current");iframeDoc.addEventListener("analyticsupdated",(function(e){window.console.log(e.detail);let percentage=e.detail.percentage;percentage>current&&($progressbar.css("width",percentage+"%").data("current",percentage),$card.find(".analytics-percentage").text(Math.round(percentage))),player||root.remove()}))}else requestAnimationFrame(checkIframeDoc)};if(requestAnimationFrame(checkIframeDoc),$(this).off(ModalEvents.hidden).on(ModalEvents.hidden,(function(){cancelAnimationFrame(checkIframeDoc)})),root.off("click",'[data-action="toggle-manual-completion"]').on("click",'[data-action="toggle-manual-completion"]',(function(){$(this).parent().addClass("updated"),1==$(this).data("withavailability")&&history.pushState(null,null,M.cfg.wwwroot+"/course/view.php?id="+course+"#module-"+id)})),history.pushState(null,null,M.cfg.wwwroot+"/mod/interactivevideo/view.php?id="+id),$card){let activitytitle=$card.data("title");document.title=activitytitle}else document.title=$('li[data-id="'+id+'"] .activityname').text()})),$(document).off("interactivevideo:closemodal"),$(document).on("interactivevideo:closemodal",(async function(){if($("body").removeClass("overflow-hidden"),$card&&setTimeout((function(){$card.find(".image-container").removeClass("hovered")}),1e3),player){if(await player.pause(),$card){if($card.find(".automatic-completion-conditions").length>0){const completion=await $.ajax({url:M.cfg.wwwroot+"/mod/interactivevideo/ajax.php",method:"POST",dataType:"text",data:{action:"get_cm_completion",cmid:id,sesskey:M.cfg.sesskey,contextid:contextid,courseid:course,userid:M.cfg.userId||0}});if(completion){const completiondata=JSON.parse(completion);if(iframeDoc.body.classList.contains("withavailability")&&completiondata.overallcompletion)return currentUrl=currentUrl.indexOf("#module-")>-1?currentUrl.replace(/#module-\d+/,"#module-"+id):currentUrl+"#module-"+id,void(window.location.href=currentUrl);$card.find("[data-region=activity-information]").html($(completiondata.completion).html())}}let $manualcompletion=$(this).find(".completion-info.updated");if($manualcompletion.length>0&&$card.find(".completion-info").html($manualcompletion.html()),details){let progressbar=$card.find(".tasks .progress-bar");if(progressbar.length>0&&details.total>0){let percentage=Math.round(details.completed/details.total*100);progressbar.css("width",percentage+"%"),details.completed==details.total?progressbar.addClass("bg-success").removeClass("bg-primary"):progressbar.removeClass("bg-success").addClass("bg-primary"),$card.find(".percentage").text(percentage),$card.find(".items").text("(".concat(details.completed,"/").concat(details.total,")")),$card.find(".xp").text(details.xp)}}}history.pushState(null,null,currentUrl),document.title=title,$card&&(iframeAnnos&&$card.find(".new-badge").remove(),$card.closest(".modtype_interactivevideo")[0].scrollIntoView({behavior:"smooth",block:"center",inline:"center"})),iframeDoc&&($(iframeDoc).off(),iframeAnnos=null,details=null,player=null,0==$card.find(".analytics.progress .progress-bar").length&&(playerModal.hide(),iframeDoc=null))}})),root.off(ModalEvents.hidden),root.on(ModalEvents.hidden,(function(){playerModal&&playerModal.hide()})),$(document).find("iframe#ivplayer").off("load").on("load",(function(){$(this).closest(".modal").hasClass("hide")&&playerModal.destroy()})),window.onpopstate=function(e){if("/course/view.php"==e.target.location.pathname){if(player)try{player.pause()}catch(error){}playerModal.hide()}},$(document).off("click",'[data-action="hidemodal"]').on("click",'[data-action="hidemodal"]',(async function(e){if(e.preventDefault(),iframeWindow.postMessage({event:"closemodal"},"*"),$(this).find("i").removeClass("fa-arrow-left fa-arrow-right").addClass("fa-circle-o-notch fa-spin"),player)try{await player.pause()}catch(e){}setTimeout((()=>{eventDispatcher.dispatchEvent("interactivevideo:closemodal"),root.find('[data-action="hide"]').trigger("click")}),player?1500:0)})),root.find('[data-action="hide"]').on("click",(function(){root.attr("data-region","modal-container"),$(".modal-backdrop.show").remove()})),$(document).off("click",".lock-bar").on("click",".lock-bar",(async function(e){e.preventDefault(),$(this).toggleClass("locked"),root.toggleClass("locked"),$(this).hasClass("locked")?($(this).attr("title",await str.get_string("unlock","mod_interactivevideo")),$(this).find("i").removeClass("fa-unlock").addClass("fa-lock"),$header.addClass("show"),localStorage.setItem("lock-bar","1"),headerFunction()):($(this).attr("title",await str.get_string("lock","mod_interactivevideo")),$(this).find("i").removeClass("fa-lock").addClass("fa-unlock"),localStorage.removeItem("lock-bar"),setTimeout((function(){$header.removeClass("show")}),5e3))})),root.off("click",".resize").on("click",".resize",(function(e){if(e.preventDefault(),root.toggleClass("modal-fullscreen iv-rounded-0 modal-resized"),root.find(".modal-dialog, .modal-content").toggleClass("iv-rounded-0"),$(this).find("i").toggleClass("fa-expand fa-compress"),root.hasClass("modal-fullscreen")){localStorage.removeItem("resized"),!!localStorage.getItem("showcontrols")?iframeDoc.querySelector("body").classList.add("showcontrols"):iframeDoc.querySelector("body").classList.remove("showcontrols")}else localStorage.setItem("resized","1"),iframeDoc.querySelector("body").classList.add("showcontrols")}))};let ModalForm,addToast;$(document).on("click",".launch-interactivevideo",(async function(e){e.preventDefault();const id=$(this).data("id"),instance=$(this).data("instance"),course=$(this).data("course"),contextid=$(this).data("contextid"),$card=$(this).closest("#interactivevideo-"+instance);$card.find(".image-container").addClass("hovered"),launchVideo($card,course,contextid,id)})),$(document).on("click",'.activityname a[href*="mod/interactivevideo/view.php"]',(async function(e){if($(this).closest("li").hasClass("launchinpopup")){e.preventDefault();const id=$(this).closest("li").data("id");launchVideo(null,M.cfg.courseId,null,id)}})),$(document).on("click",".open-external-link",(function(){playerModal.hide(),window.open($(this).data("href"),"_blank")})),$(document).on("click",".interactivevideo-card .description-toggle",(function(){$(this).closest(".top-section").find(".description").slideToggle("fast","swing"),$(this).find(".description-show").toggleClass("rotate")})),$(document).ready((function(){let hash=window.location.hash;if(hash){let $element=$(hash);$element.length>0&&$element.hasClass("modtype_interactivevideo")&&($element.addClass("highlighted"),setTimeout((()=>{$element[0].scrollIntoView({behavior:"smooth",block:"center",inline:"center"}),setTimeout((function(){$element.removeClass("highlighted"),history.pushState(null,null,window.location.href.split("#module")[0])}),3e3)}),1e3))}})),$(document).on("click",".launch-report",(async function(e){e.preventDefault();const href=$(this).data("href");if(!e.ctrlKey&&!e.metaKey)return void(window.location.href=href);const reportModal=await ModalFactory.create({body:await Templates.render("mod_interactivevideo/backgroundloading",{show:!0})+'<iframe src="'.concat(href,'&embed=1"\n                         class="w-100 position-absolute h-100 border-0"\n                         allow="autoplay"\n                         style="z-index:1050;"></iframe>'),title:await str.get_string("reportfor","mod_interactivevideo",$(this).data("title")),large:!0,show:!1,removeOnClose:!0,isVerticallyCentered:!0}),root=reportModal.getRoot();root.attr("id","reportModal").addClass("modal-fullscreen iv-modal"),root.find(".modal-body").addClass("p-0"),reportModal.show(),root.off(ModalEvents.hidden),root.on(ModalEvents.hidden,(function(){reportModal.destroy()}))})),$(document).on("click",".iv_quickform",(async function(e){const $this=$(this);e.preventDefault();const href=$this.data("href");if(!e.ctrlKey&&!e.metaKey)return void(window.location.href=href);let formdata={contextid:$(this).data("contextid"),cmid:$(this).data("cmid"),courseid:$(this).data("courseid"),interaction:$(this).data("interaction"),origin:"coursepage"};ModalForm||(ModalForm=await("function"==typeof _systemImportTransformerGlobalIdentifier.define&&_systemImportTransformerGlobalIdentifier.define.amd?new Promise((function(resolve,reject){_systemImportTransformerGlobalIdentifier.require(["core_form/modalform"],resolve,reject)})):"undefined"!=typeof module&&module.exports&&"undefined"!=typeof require||"undefined"!=typeof module&&module.component&&_systemImportTransformerGlobalIdentifier.require&&"component"===_systemImportTransformerGlobalIdentifier.require.loader?Promise.resolve(require("core_form/modalform")):Promise.resolve(_systemImportTransformerGlobalIdentifier["core_form/modalform"]))),addToast||(addToast=await("function"==typeof _systemImportTransformerGlobalIdentifier.define&&_systemImportTransformerGlobalIdentifier.define.amd?new Promise((function(resolve,reject){_systemImportTransformerGlobalIdentifier.require(["core/toast"],resolve,reject)})):"undefined"!=typeof module&&module.exports&&"undefined"!=typeof require||"undefined"!=typeof module&&module.component&&_systemImportTransformerGlobalIdentifier.require&&"component"===_systemImportTransformerGlobalIdentifier.require.loader?Promise.resolve(require("core/toast")):Promise.resolve(_systemImportTransformerGlobalIdentifier["core/toast"])));let DynamicForm,form=new ModalForm({formClass:"mod_interactivevideo\\form\\quicksettings_form",args:formdata,modalConfig:{title:await str.get_string("quicksettings","mod_interactivevideo"),removeOnClose:!0}});form.show(),form.addEventListener(form.events.LOADED,(e=>{e.stopImmediatePropagation(),setTimeout((()=>{$(".modal.show").addClass("path-mod-interactivevideo"),$(".modal-dialog").removeClass("modal-lg").addClass("modal-xl")}),1e3),setTimeout((async()=>{let strings=await str.get_strings([{key:"moresettings",component:"mod_interactivevideo"},{key:"resettodefaults",component:"mod_interactivevideo"}]);$('[data-region="footer"]').css("align-items","unset").prepend('<span class="btn btn-secondary iv-mr-1 default" title="'.concat(strings[1],'">\n                        <i class="fa fa-refresh"></i></span>\n                        <a type="button" class="btn btn-secondary iv-mr-auto" target="_blank" data-dismiss="modal"\n                         data-bs-dismiss="modal" title="').concat(strings[0],'"\n                            href="').concat(M.cfg.wwwroot,"/course/modedit.php?update=").concat(formdata.cmid,'"><i class="fa fa-cog"></i>\n                            </a>'))}),2e3)})),form.addEventListener(form.events.FORM_SUBMITTED,(e=>{e.stopImmediatePropagation(),addToast.add(str.get_string("settingssaved","mod_interactivevideo"),{type:"success"});let $newcard=$(e.detail.html);$this.closest(".modtype_interactivevideo").replaceWith($newcard).trigger("click")})),$(document).off("click",".default").on("click",".default",(async function(e){e.preventDefault(),formdata.action="reset",DynamicForm||(DynamicForm=await("function"==typeof _systemImportTransformerGlobalIdentifier.define&&_systemImportTransformerGlobalIdentifier.define.amd?new Promise((function(resolve,reject){_systemImportTransformerGlobalIdentifier.require(["core_form/dynamicform"],resolve,reject)})):"undefined"!=typeof module&&module.exports&&"undefined"!=typeof require||"undefined"!=typeof module&&module.component&&_systemImportTransformerGlobalIdentifier.require&&"component"===_systemImportTransformerGlobalIdentifier.require.loader?Promise.resolve(require("core_form/dynamicform")):Promise.resolve(_systemImportTransformerGlobalIdentifier["core_form/dynamicform"]))),new DynamicForm(document.querySelector('[data-region="body"]'),"mod_interactivevideo\\form\\quicksettings_form").load(formdata),addToast.add(str.get_string("formvaluesarereset","mod_interactivevideo"),{type:"info"})}))}))}}}));

//# sourceMappingURL=launch.min.js.map