{"version":3,"file":"viewannotation.min.js","sources":["../src/viewannotation.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n\n/**\n * View page module\n *\n * @module     mod_interactivevideo/viewannotation\n * @copyright  2024 Sokunthearith Makara <sokunthearithmakara@gmail.com>\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\n\ndefine([\n    'jquery', 'core/str', 'core/event_dispatcher', 'core/toast', 'mod_interactivevideo/quickform',\n    'mod_interactivevideo/libraries/jquery-ui'\n], function($, str, eventDispatcher, Toast, quickform) {\n    const getString = str.get_string;\n    const {dispatchEvent} = eventDispatcher;\n    const ctRenderer = {};\n    const isBS5 = $('body').hasClass('bs-5');\n    const bsAffix = isBS5 ? '-bs' : '';\n    let annotations, // Array of annotations.\n        totaltime, // Video total time.\n        activityType, // Current activityType.\n        viewedAnno = [], // Array of viewed annotations.\n        contentTypes, // Array of available content types.\n        displayoptions, // Display options.\n        releventAnnotations, // Array of annotations that are not skipped.\n        completionid, // Id of the completion record.\n        player, // Video player instance.\n        lastrun, // Last run annotation.\n        subvideo; // For multiple videos.\n\n    const $videoNav = $('#video-nav');\n    const $interactionNav = $('#interactions-nav');\n    const $loader = $('#background-loading');\n    const formatTime = (seconds) => {\n        const hours = Math.floor(seconds / 3600);\n        const minutes = Math.floor((seconds % 3600) / 60);\n        const remainingSeconds = seconds % 60;\n        let string = '';\n        if (hours > 0) {\n            string += hours + 'h ';\n        }\n        if (minutes > 0) {\n            string += minutes + 'm ';\n        }\n        if (remainingSeconds > 0) {\n            string += remainingSeconds + 's';\n        }\n        return string;\n    };\n\n    let $meta = $('.metadata');\n    let $wrapper = $('#wrapper');\n    const renderAnnotationItems = async(annos, start, totaltime) => {\n        $meta.empty();\n        $interactionNav.find('ul').empty();\n        $videoNav.find('ul').empty();\n        $('.annolistinchapter').empty();\n        if (displayoptions.preventseeking == 1) {\n            $videoNav.addClass('no-pointer-events');\n        }\n\n        if (annos.length > 0) {\n            releventAnnotations = annos;\n            window.IVANNO = annos;\n        }\n        let actualduration = totaltime;\n\n        const skipsegments = annos.filter(x => x.type == 'skipsegment');\n\n        if (skipsegments.length > 0) {\n            skipsegments.forEach(x => {\n                const length = (Number(x.title) - Number(x.timestamp));\n                actualduration -= length;\n            });\n        }\n\n        const completableAnno = annos.filter(x => x.hascompletion == 1);\n        const actualAnnotationCounts = completableAnno.length;\n\n        const xp = completableAnno.map(x => Number(x.xp)).reduce((a, b) => a + b, 0);\n\n        const completedAnnos = completableAnno\n            .filter(x => x.completed == true);\n\n        const xpEarned = completableAnno.map(x => Number(x.earned)).reduce((a, b) => a + b, 0) || 0;\n\n        if (actualAnnotationCounts > 0) {\n            $meta.append(`<span class=\"d-inline-block iv-mr-3\">\n            <i class=\"bi bi-stopwatch iv-mr-2\"></i>${formatTime(Math.ceil(actualduration))}</span>\n            <span class=\"d-inline-block iv-mr-3\">\n        <i class=\"bi bi-bullseye iv-mr-2\"></i>${completedAnnos.length} / ${actualAnnotationCounts}</span>\n        <span class=\"d-inline-block\"><i class=\"bi bi-star iv-mr-2\"></i>${xpEarned} / ${xp}</span>`);\n        }\n\n        if (displayoptions.hidemainvideocontrols == 1 || displayoptions.hideinteractions == 1) {\n            if (displayoptions.hidemainvideocontrols == 1) {\n                $wrapper.addClass('no-videonav');\n            }\n            dispatchEvent('annotationitemsrendered', {\n                'annotations': annos,\n                'completed': completedAnnos.length,\n                'total': actualAnnotationCounts,\n                'xp': xpEarned,\n                'totalxp': xp,\n            });\n            return;\n        }\n        for (const x of annos) {\n            const renderer = ctRenderer[x.type];\n            await renderer.renderItemOnVideoNavigation(x);\n        }\n        dispatchEvent('annotationitemsrendered', {\n            'annotations': annos,\n            'completed': completedAnnos.length,\n            'total': actualAnnotationCounts,\n            'xp': xpEarned,\n            'totalxp': xp,\n        });\n\n        // Handle the chapter list.\n        const chapteritems = annos.filter(x => x.type != 'skipsegment'\n            && x.hascompletion == 1);\n        chapteritems.sort((a, b) => a.timestamp - b.timestamp);\n        chapteritems.forEach((x) => {\n            const advanced = JSON.parse(x.advanced);\n            if ((advanced.visiblebeforecompleted == \"1\" && !x.completed)\n                || (advanced.visibleaftercompleted == \"1\" && x.completed)) {\n                $('[data-region=\"chapterlists\"] li').each(function() {\n\n                    const cstart = $(this).data('start');\n                    const cend = $(this).data('end');\n                    if (x.timestamp >= cstart && x.timestamp < cend) {\n                        $(this).find('.annolistinchapter')\n                            .append(`<li class=\"border-bottom anno d-flex align-items-center justify-content-between\n                         px-3 py-2 ${x.completed ? \"completed\" : \"\"}\" data-id=\"${x.id}\" data-timestamp=\"${x.timestamp}\">\n                         <span class=\"text-nowrap\">\n                         <i class=\"small bi ${x.completed ? \"bi-check-circle-fill text-success\" : 'bi-circle'} iv-mr-2\"></i>\n                         <i class=\"${JSON.parse(x.prop).icon} iv-mr-2\"></i></span>\n                         <span class=\"flex-grow-1 text-truncate\">${x.formattedtitle}</span>\n                         <span class=\"text-nowrap\">${x.xp}<i class=\"bi bi-star iv-ml-1\"></i></span></li>`);\n                    }\n                });\n            }\n        });\n        if (annos.length == 0) {\n            $('#chaptertoggle').hide();\n        } else {\n            $('#chaptertoggle').show();\n        }\n        dispatchEvent('chapterrendered', {'annotations': annos});\n    };\n\n    const fireConfetti = () => {\n        var duration = 5 * 1000;\n        let confetti = window.confetti;\n        var animationEnd = Date.now() + duration;\n        var defaults = {startVelocity: 30, spread: 360, ticks: 60, zIndex: 1055};\n\n        const randomInRange = (min, max) => {\n            return Math.random() * (max - min) + min;\n        };\n\n        var interval = setInterval(function() {\n            var timeLeft = animationEnd - Date.now();\n\n            if (timeLeft <= 0) {\n                return clearInterval(interval);\n            }\n\n            var particleCount = 50 * (timeLeft / duration);\n            // Since particles fall down, start a bit higher than random\n            confetti({...defaults, particleCount, origin: {x: randomInRange(0.1, 0.3), y: Math.random() - 0.2}});\n            confetti({...defaults, particleCount, origin: {x: randomInRange(0.7, 0.9), y: Math.random() - 0.2}});\n            return true;\n        }, 250);\n    };\n\n    window.fireConfetti = fireConfetti;\n\n    // Preload audio.\n    const pop = new Audio(M.cfg.wwwroot + '/mod/interactivevideo/sounds/pop.mp3');\n    const point = new Audio(M.cfg.wwwroot + '/mod/interactivevideo/sounds/point-awarded.mp3');\n    window.IVAudio = {\n        pop,\n        point\n    };\n\n    return {\n        /**\n         * Render annotation items on the video navigation and chapter list.\n         */\n        renderAnnotationItems: renderAnnotationItems,\n        /**\n         * Initialize the view annotation on page loads.\n         * @param {string} url - The video url.\n         * @param {number} cmid - The course module id.\n         * @param {number} interaction - Interactive video instance.\n         * @param {number} course - The course id.\n         * @param {number} userid - The user id.\n         * @param {number} start - The start time of the video.\n         * @param {number} end - The end time of the video.\n         * @param {number} completionpercentage - The completion percentage.\n         * @param {number} gradeiteminstance - The grade item instance.\n         * @param {number} grademax - The grade max.\n         * @param {string} vtype - The video type.\n         * @param {boolean} preventskip - Prevent user from skipping the video.\n         * @param {number} moment - The moment to share.\n         * @param {object} doptions - The display options.\n         * @param {string} token - The token.\n         * @param {string} extendedcompletion - The extended completion requirements.\n         * @param {boolean} isPreviewMode - The preview mode flag.\n         * @param {boolean} isCompleted - The completed flag.\n         * @param {boolean} iseditor - The editor flag.\n         * @return {void}\n         */\n        init: function(\n            url, cmid, interaction, course, userid, start = 0, end,\n            completionpercentage, gradeiteminstance, grademax, vtype,\n            preventskip = true, moment = null, doptions = {}, token = null, extendedcompletion = null, isPreviewMode = false,\n            isCompleted = false, iseditor = false) {\n\n            doptions = $('#doptions').length > 0 ? JSON.parse($('#doptions').text()) : doptions;\n\n            let $remainingtime = $('#remainingtime');\n            let $currenttime = $('#currenttime');\n            let $lightprogressbar = $('#lightprogressbar');\n            let $duration = $('#duration');\n            let $taskinfo = $('#taskinfo');\n            let $seek = $('#seek');\n            let $startscreen = $('#start-screen');\n            let $endscreen = $('#end-screen');\n            let $controller = $('#controller');\n            let $videowrapper = $('#video-wrapper');\n            let $wrapper = $('#wrapper');\n            let $annotationcanvas = $('#annotation-canvas');\n            let $rewindbutton = $('#rewindbutton');\n            let $forwardbutton = $('#forwardbutton');\n            let $body = $('body');\n            let $progressbar = $videoNav.find('#progress');\n            let $seekhead = $videoNav.find('#seekhead');\n\n            quickform({\n                contextid: M.cfg.contextid,\n                courseid: course,\n                cmid,\n                interaction,\n            });\n\n            require(['theme_boost/bootstrap/modal']);\n            require(['theme_boost/bootstrap/tooltip']);\n\n            // Convert start to number if string\n            start = Number(start);\n            if (isNaN(start)) {\n                start = 0;\n            }\n\n            // Convert end to number if string\n            end = Number(end);\n            if (isNaN(end)) {\n                end = null;\n            }\n\n            displayoptions = doptions;\n\n            if (displayoptions.hidemainvideocontrols == 1 && displayoptions.useoriginalvideocontrols == 1) {\n                $lightprogressbar.remove();\n            }\n\n            let playerReady = false;\n            let uprogress = null;\n            let timeended = null;\n\n            if (localStorage.getItem('limitedwidth') == 'true' && displayoptions.hidemainvideocontrols == 0) {\n                $body.addClass('limited-width');\n                $controller.find('#expand i').removeClass('bi-file').addClass('bi-square');\n            }\n\n            if (vtype == 'spotify') { // Spotify player.\n                $body.addClass('limited-width');\n            }\n\n            /**\n             * Function to convert seconds to HH:MM:SS format.\n             * @param {number} seconds\n             * @returns {string}\n             */\n            const convertSecondsToHMS = (seconds) => {\n                if (seconds < 0) {\n                    return '00:00';\n                }\n                const h = Math.floor(seconds / 3600);\n                const m = Math.floor(seconds % 3600 / 60);\n                const s = Math.floor(seconds % 3600 % 60);\n                return (h > 0 ? h + ':' : '') + (m < 10 ? '0' : '') + m + ':' + (s < 10 ? '0' : '') + s;\n            };\n\n            /**\n             * Function to replace the progress bars on the video navigation.\n             * @param {number} percentage\n             * @returns {Promise<boolean>}\n             */\n            const replaceProgressBars = async(percentage) => {\n                let livestring = await getString('live', 'mod_interactivevideo');\n                return new Promise((resolve) => {\n                    percentage = percentage > 100 ? 100 : percentage;\n                    let time = percentage / 100 * totaltime;\n                    $currenttime.text(convertSecondsToHMS(time));\n                    $remainingtime.text(\n                        player.live ? livestring : convertSecondsToHMS(totaltime - time));\n                    $progressbar.css('width', percentage + '%');\n                    $seekhead.css('left', percentage + '%');\n                    $lightprogressbar.css('width', percentage + '%');\n                    resolve(true);\n                });\n            };\n\n            /**\n             * Function to get all annotations from the database and render them.\n             * @returns {Promise}\n             */\n            const getAnnotations = () => {\n                // Get all interaction items.\n                const annnoitems = $.ajax({\n                    url: M.cfg.wwwroot + '/mod/interactivevideo/ajax.php',\n                    method: \"POST\",\n                    dataType: \"text\",\n                    data: {\n                        action: 'get_items',\n                        sesskey: M.cfg.sesskey,\n                        id: interaction,\n                        contextid: M.cfg.courseContextId,\n                        token: token,\n                        cmid: cmid\n                    }\n                });\n\n                // Get current user progress.\n                const userprogress = $.ajax({\n                    url: M.cfg.wwwroot + '/mod/interactivevideo/ajax.php',\n                    method: \"POST\",\n                    dataType: \"text\",\n                    data: {\n                        action: 'get_progress',\n                        sesskey: M.cfg.sesskey,\n                        id: interaction,\n                        uid: userid,\n                        token: token,\n                        cmid: cmid,\n                        contextid: M.cfg.contextid,\n                        previewmode: isPreviewMode ? 1 : 0\n                    }\n                });\n\n                // Get all content types.\n                const getContentTypes = $.ajax({\n                    url: M.cfg.wwwroot + '/mod/interactivevideo/ajax.php',\n                    method: \"POST\",\n                    dataType: \"text\",\n                    data: {\n                        action: 'get_all_contenttypes',\n                        sesskey: M.cfg.sesskey,\n                        token: token,\n                        cmid: cmid,\n                        fromview: 1,\n                        contextid: M.cfg.contextid\n                    }\n                });\n\n                $.when(annnoitems, userprogress, getContentTypes).done(async function(annos, progress, ct) {\n                    annotations = JSON.parse(annos[0]);\n                    if (player.live) { // Live video does not have end time.\n                        annotations = annotations.filter(x => x.timestamp < 0);\n                    }\n                    progress = JSON.parse(progress[0]);\n                    uprogress = progress;\n                    timeended = progress.timeended;\n                    contentTypes = JSON.parse(ct[0]);\n                    completionid = progress.id;\n                    let completiondetails = JSON.parse(progress.completiondetails || '[]');\n                    if (typeof completiondetails == 'object') {\n                        completiondetails = Object.values(completiondetails);\n                    }\n                    annotations = filterAnnotations(annotations, contentTypes, start, end);\n                    annotations = processAnnotations(annotations, contentTypes, progress, start, end, completiondetails);\n                    // Sort by type first, then by timestamp\n                    annotations.sort((a, b) => {\n                        if (a.type < b.type) {\n                            return -1;\n                        }\n                        if (a.type > b.type) {\n                            return 1;\n                        }\n                        return a.timestamp - b.timestamp;\n                    });\n\n                    releventAnnotations = getRelevantAnnotations(annotations, start, end, contentTypes);\n                    window.ANNOS = releventAnnotations;\n                    if (releventAnnotations.length > 0 && !releventAnnotations.find(x => x.type == 'chapter')) {\n                        await prependDummyChapter(releventAnnotations, start, contentTypes);\n                    }\n\n                    await initializeContentTypeRenderers(contentTypes, releventAnnotations, player, interaction, course, userid,\n                        completionpercentage, gradeiteminstance, grademax, vtype, preventskip,\n                        totaltime, start, end, cmid, token, completionid);\n\n                    await renderAnnotationItems(releventAnnotations, start, end - start);\n                    $(\"#play\").removeClass('d-none');\n                    $(\"#spinner\").remove();\n                    $(\"#video-info\").removeClass('d-none');\n                    return new Promise((resolve) => {\n                        resolve();\n                    });\n                });\n\n                /**\n                 * Filters annotations based on content types and a time range.\n                 *\n                 * @param {Array} annotations - The list of annotations to filter.\n                 * @param {Array} contentTypes - The list of content types to include.\n                 * @param {number} start - The start time of the range.\n                 * @param {number} end - The end time of the range.\n                 * @returns {Array} - The filtered list of annotations.\n                 */\n                function filterAnnotations(annotations, contentTypes, start, end) {\n                    return annotations.filter(annotation => {\n                        const inContentType = contentTypes.some(y => y.name === annotation.type);\n                        if (!inContentType) {\n                            return false;\n                        }\n\n                        if (annotation.type === 'skipsegment') {\n                            return !(annotation.timestamp > end || annotation.title < start);\n                        }\n\n                        return (annotation.timestamp >= start && annotation.timestamp <= end) || annotation.timestamp < 0;\n                    });\n                }\n\n                /**\n                 * Maps and processes annotations based on provided content types, progress, and time range.\n                 *\n                 * @param {Array} annotations - The list of annotations to be processed.\n                 * @param {Array} contentTypes - The list of content types to match with annotations.\n                 * @param {Object} progress - The progress object containing completed items.\n                 * @param {number} start - The start time of the segment.\n                 * @param {number} end - The end time of the segment.\n                 * @param {Object} completiondetails - The completion details object.\n                 * @returns {Array} - The processed list of annotations.\n                 */\n                function processAnnotations(annotations, contentTypes, progress, start, end, completiondetails) {\n                    const completedItems = progress.completeditems == '' ? [] : JSON.parse(progress.completeditems);\n                    const contentTypeMap = new Map(contentTypes.map(ct => [ct.name, ct]));\n                    return annotations.map(annotation => {\n                        annotation.timestamp = Number(annotation.timestamp);\n                        annotation.xp = Number(annotation.xp);\n                        const completionitem = completiondetails.find(x => JSON.parse(x).id == annotation.id);\n                        if (completionitem) {\n                            let thisitem = JSON.parse(completionitem);\n                            annotation.earned = Number(thisitem.xp); // Earned from previous attempt.\n                            if (thisitem.percent) { // IV1.4.1 introduce percent to handle when teacher updates XP afterward.\n                                annotation.earned = annotation.xp * thisitem.percent;\n                            }\n                            if (annotation.earned > annotation.xp) { // What if the teacher decreases the XP afterward?\n                                annotation.earned = annotation.xp;\n                            }\n                        } else {\n                            annotation.earned = 0;\n                        }\n                        if (annotation.type == 'skipsegment') {\n                            annotation.title = Number(annotation.title);\n                            if (annotation.timestamp < start && annotation.title > start) {\n                                annotation.timestamp = start;\n                            }\n                            if (annotation.title > end && annotation.timestamp < end) {\n                                annotation.title = end;\n                            }\n                        }\n                        annotation.prop = JSON.stringify(contentTypeMap.get(annotation.type));\n                        annotation.completed = completedItems.indexOf(annotation.id) > -1;\n\n                        let advanced;\n                        try {\n                            advanced = JSON.parse(annotation.advanced);\n                        } catch (e) {\n                            advanced = null;\n                        }\n                        annotation.rerunnable = advanced && advanced.replaybehavior === '1';\n\n                        return annotation;\n                    });\n                }\n\n                /**\n                 * Filters and returns relevant annotations within a specified time range,\n                 * excluding those that fall within skip segments.\n                 *\n                 * @param {Array} annotations - The list of annotations to filter.\n                 * @returns {Array} - The filtered list of relevant annotations.\n                 */\n                function getRelevantAnnotations(annotations) {\n                    const skipsegments = annotations.filter(annotation => annotation.type == 'skipsegment');\n                    let releventAnnotations = [];\n                    annotations.forEach(annotation => {\n                        let shouldAdd = true;\n                        skipsegments.forEach(skipsegment => {\n                            if (Number(annotation.timestamp) > Number(skipsegment.timestamp)\n                                && Number(annotation.timestamp) < Number(skipsegment.title)) {\n                                shouldAdd = false;\n                            }\n                        });\n                        if (shouldAdd) {\n                            releventAnnotations.push(annotation);\n                            if (isPreviewMode) {\n                                annotation.completed = true;\n                                annotation.previewMode = true;\n                            }\n                        }\n                    });\n                    return releventAnnotations;\n                }\n\n                /**\n                 * Adds a dummy chapter annotation to the beginning of the relevant annotations array.\n                 *\n                 * @param {Array} releventAnnotations - The array of relevant annotations to which the dummy chapter will be added.\n                 * @param {number} start - The timestamp at which the dummy chapter starts.\n                 * @param {Array} contentTypes - The array of content types to find the chapter type from.\n                 */\n                async function prependDummyChapter(releventAnnotations, start, contentTypes) {\n                    let startChapter = await getString('startchapter', 'mod_interactivevideo');\n                    releventAnnotations.unshift({\n                        id: 0,\n                        title: startChapter,\n                        formattedtitle: startChapter,\n                        timestamp: start,\n                        type: 'chapter',\n                        prop: JSON.stringify(contentTypes.find(x => x.name == 'chapter')),\n                        xp: 0,\n                        completed: true,\n                        hide: true\n                    });\n                }\n\n                /**\n                 * Asynchronously loads and initializes content type renderers for interactive video annotations.\n                 *\n                 * @param {Array} contentTypes - Array of content type objects.\n                 * @param {Array} releventAnnotations - Array of relevant annotation objects.\n                 * @param {Object} player - The video player instance.\n                 * @param {Object} interaction - The interaction object.\n                 * @param {Object} course - The course object.\n                 * @param {number} userid - The user ID.\n                 * @param {number} completionpercentage - The completion percentage.\n                 * @param {number} gradeiteminstance - The grade item instance.\n                 * @param {number} grademax - The maximum grade.\n                 * @param {string} vtype - The video type.\n                 * @param {boolean} preventskip - Flag to prevent skipping.\n                 * @param {number} totaltime - The total time of the video.\n                 * @param {number} start - The start time of the video.\n                 * @param {number} end - The end time of the video.\n                 * @param {number} cmid - The course module ID.\n                 * @param {string} token - The authentication token.\n                 * @param {number} completionid - Completion record id.\n                 */\n                async function initializeContentTypeRenderers(contentTypes, releventAnnotations,\n                    player, interaction, course, userid, completionpercentage, gradeiteminstance,\n                    grademax, vtype, preventskip, totaltime, start, end, cmid, token, completionid) {\n                    const chapterContentType = contentTypes.find(x => x.name == 'chapter');\n                    // We only want the relevant content types.\n                    contentTypes = contentTypes.filter(x => releventAnnotations.map(y => y.type).includes(x.name));\n                    if (contentTypes.length == 0) {\n                        $('#chaptertoggle, #chapter-container-left, #chapter-container-right').remove();\n                        return;\n                    } else {\n                        $('#chaptertoggle, #chapter-container-left, #chapter-container-right').removeClass('d-none');\n                    }\n                    if (!contentTypes.find(x => x.name == 'chapter')) {\n                        contentTypes.push(chapterContentType);\n                    }\n                    await Promise.all(contentTypes.map(contentType => {\n                        return new Promise((resolve) => {\n                            require([contentType.amdmodule], function(Type) {\n                                ctRenderer[contentType.name] = new Type(player, releventAnnotations, interaction, course, userid,\n                                    completionpercentage, gradeiteminstance, grademax, vtype, preventskip, totaltime, start,\n                                    end, contentType, cmid, token, displayoptions, completionid, extendedcompletion, {\n                                    isPreviewMode,\n                                    isCompleted,\n                                    iseditor,\n                                    url\n                                });\n                                resolve();\n                            });\n                        });\n                    }));\n\n                    await Promise.all(contentTypes.map(async(contentType) => {\n                        try {\n                            await ctRenderer[contentType.name].init();\n                        } catch (error) {\n                            // Do nothing.\n                        }\n                    }));\n                }\n            };\n\n            /**\n             * Run the interaction.\n             * @param {object} annotation annotation object\n             * @param {boolean} force force run the interaction\n             * @returns {void}\n             */\n            const runInteraction = async(annotation, force = false) => {\n                if (subvideo) {\n                    return;\n                }\n                // First making sure the player is paused.\n                player.pause();\n                let isPaused = await player.isPaused();\n                if (!isPaused) {\n                    runInteraction(annotation);\n                    return;\n                }\n                // Continue with the interaction. Take notes of the earlier interactions to avoid accidental re-runs.\n                lastrun = annotation.id;\n                viewedAnno = [];\n                // Put all annotations with timestamp < annotation.timestamp in the viewedAnno.\n                releventAnnotations.forEach(x => {\n                    if (Number(x.timestamp) <= Number(annotation.timestamp)) {\n                        viewedAnno.push(Number(x.id));\n                    }\n                });\n                viewedAnno.push(Number(annotation.id));\n                viewedAnno = [...new Set(viewedAnno)];\n\n                // Remove the previous message but keep the one below the video.\n                $('#annotation-modal').modal('hide');\n\n                $('#message').not('[data-placement=bottom]').not('.sticky').not(`[data-id=${annotation.id}]`).remove();\n                $startscreen.fadeOut(300);\n                $endscreen.fadeOut(300);\n\n                if (preventskip) {\n                    const theAnnotations = releventAnnotations\n                        .filter(x => Number(x.timestamp) < Number(annotation.timestamp)\n                            && x.completed == false && x.hascompletion == 1);\n                    if (theAnnotations.length > 0) {\n                        const theAnnotation = theAnnotations[0];\n                        await player.pause();\n                        await player.seek(theAnnotation.timestamp);\n                        runInteraction(theAnnotation);\n                        Toast.add(await getString('youmustcompletethistaskfirst', 'mod_interactivevideo'), {\n                            type: 'danger'\n                        });\n                        return;\n                    }\n                }\n\n                // If the annotation has displayoptions == 'side' and it is already run, then we don't need to run it again.\n                // But we need to show the message.\n                if (annotation.displayoptions == 'side' && $(`.sidebar-nav-item[data-id=${annotation.id}]`).length > 0 && !force) {\n                    if (!$body.hasClass('hassidebar')) {\n                        // Toggle the drawer.\n                        $('#annotation-toggle').trigger('click');\n                    }\n                    $(`.sidebar-nav-item[data-id=${annotation.id}]`).trigger('click');\n                } else {\n                    activityType = ctRenderer[annotation.type];\n                    setTimeout(() => {\n                        activityType.runInteraction(annotation);\n                        // In case there is an active interaction, trigger the interactionclose event.\n                        if ($('#message.active').length > 0) {\n                            $('#message.active').each(function() {\n                                const id = $(this).data('id');\n                                if (id != annotation.id) {\n                                    $(this).removeClass('active');\n                                    dispatchEvent('interactionclose', {'annotation': {'id': id}});\n                                }\n                            });\n                        }\n                        dispatchEvent('interactionrun', {'annotation': annotation});\n                    }, 100);\n                }\n\n            };\n\n            /**\n             * Shares a specific moment in the video by seeking to the given timestamp and playing the video.\n             * If the timestamp is within the valid range, it hides the start screen, seeks to the timestamp,\n             * plays the video, runs the relevant annotation interaction, and updates the progress bars.\n             * Finally, it removes the timestamp parameter from the URL.\n             *\n             * @async\n             * @function shareMoment\n             * @returns {Promise<void>} A promise that resolves when the video has been successfully sought and played.\n             */\n            const shareMoment = async() => {\n                if (!moment) {\n                    return;\n                }\n                // Check if the url has a timestamp using url params.\n                const urlParams = new URLSearchParams(window.location.search);\n                urlParams.delete('t');\n                const newurl = window.location.protocol\n                    + '//' + window.location.host + window.location.pathname + '?' + urlParams.toString();\n                window.history.replaceState(null, null, newurl);\n            };\n\n            const updateTime = async(duration) => {\n                duration = Number(duration);\n                let toUpdatetime = false;\n                if (!end || end == 0) {\n                    toUpdatetime = true;\n                }\n                if (!start || start >= duration || start < 0 || start >= duration) {\n                    toUpdatetime = true;\n                }\n                start = start > duration ? 0 : start;\n                if (toUpdatetime) {\n                    await $.ajax({\n                        url: M.cfg.wwwroot + '/mod/interactivevideo/ajax.php',\n                        method: \"POST\",\n                        dataType: \"text\",\n                        data: {\n                            action: 'update_videotime',\n                            sesskey: M.cfg.sesskey,\n                            id: interaction,\n                            cmid: cmid,\n                            courseid: course,\n                            start: start,\n                            end: !end || end == 0 ? duration : end,\n                            contextid: M.cfg.contextid\n                        }\n                    });\n                }\n                end = !end || end == 0 || end > duration ? duration : end;\n                return {start, end};\n            };\n\n            let loaded = false;\n            let lookbacktime = 0;\n\n            const onLoaded = async(reloaded = false, e = null) => {\n                let $changecaption = $('#changecaption');\n                if (e) {\n                    const captions = e.detail.tracks;\n                    if (captions && captions.length > 0) {\n                        $changecaption.removeClass('d-none');\n                        $changecaption.find('.dropdown-menu')\n                            .html(`<a class=\"dropdown-item changecaption px-3\" data-lang=\"\" href=\"#\">\n                     <i class=\"bi fa-fw bi-check\"></i>${await getString('off', 'mod_interactivevideo')}</a>`);\n                        let menu = '';\n                        captions.forEach((caption, i) => {\n                            menu += `<a class=\"dropdown-item changecaption text-white px-3\"\n                         data-lang=\"${caption.code}\" href=\"#\"><i class=\"bi fa-fw\"></i>${caption.label}</a>`;\n                            if (i == captions.length - 1) {\n                                $changecaption.find('.dropdown-menu')\n                                    .append(menu);\n                                const lang = localStorage.getItem(`caption-${userid}`);\n                                if (lang && lang.length) {\n                                    $changecaption.find(`[data-lang=\"${lang}\"]`).trigger('click');\n                                }\n                            }\n                        });\n                    } else {\n                        $changecaption.addClass('d-none');\n                    }\n                }\n\n                if (loaded) {\n                    return;\n                }\n                if (displayoptions.passwordprotected == 1 && player.support.password) {\n                    // Remove start screen, set .video-block to d-none, #annotation-canvas remove d-none.\n                    $startscreen.removeClass('d-none');\n                    $('.video-block').removeClass('no-pointer bg-transparent');\n                }\n                loaded = true;\n                // Add player to Window object.\n                window.IVPLAYER = player;\n                lookbacktime = Math.max(0.5, player.frequency); // How far back to look for annotations.\n                // Check if the player supports playback rate and quality adjustments.\n                if (player.support.playbackrate == false) {\n                    $('#changerate').addClass('d-none');\n                } else {\n                    $('#changerate').removeClass('d-none');\n                }\n\n                if (player.support.quality == false) {\n                    $('#changequality').addClass('d-none');\n                } else {\n                    $('#changequality').removeClass('d-none');\n                }\n\n                const duration = player.totaltime;\n                if (!reloaded) {\n                    ({start, end} = await updateTime(duration));\n                }\n                totaltime = end - start;\n\n                if (!player.live) {\n                    $duration.text(convertSecondsToHMS(totaltime));\n                }\n\n                // Recalculate the ratio of the video\n                let ratio = 16 / 9;\n                if (!displayoptions.usefixedratio || displayoptions.usefixedratio == 0) {\n                    ratio = player.aspectratio;\n                }\n                $videowrapper.css('padding-bottom', (1 / ratio) * 100 + '%');\n                let gap = '125px';\n                if ($body.hasClass('embed-mode')) {\n                    if (displayoptions.hidemainvideocontrols == 1) {\n                        $(\"#wrapper\").css({\n                            'width': 'calc(100dvh * ' + ratio + ')'\n                        });\n                    } else {\n                        $(\"#wrapper\").css({\n                            'width': 'calc((100dvh - 55px) * ' + ratio + ')'\n                        });\n                    }\n                } else {\n                    if (displayoptions.hidemainvideocontrols == 1) {\n                        gap = '75px';\n                    }\n                    $(\"#wrapper\").css({\n                        'width': 'calc((100dvh - ' + gap + ' - 2rem) * ' + ratio + ')'\n                    });\n                }\n\n                $wrapper.attr('data-ratio', ratio);\n                $wrapper.attr('data-gap', gap);\n\n                $startscreen.find('#start').focus();\n\n                // Resize observer\n                if (!reloaded) {\n                    let vwrapper = document.querySelector('#video-wrapper');\n                    // Optimize: Only update DOM if state changes, and debounce resize events.\n                    let lastExpandVisible = null;\n                    let resizeTimeout;\n                    const updateExpandVisibility = () => {\n                        const shouldShow = vwrapper.clientWidth > 1050;\n                        if (shouldShow !== lastExpandVisible) {\n                            $controller.find('#expand').toggleClass('d-none', !shouldShow);\n                            lastExpandVisible = shouldShow;\n                        }\n                    };\n                    const resizeObserver = new ResizeObserver(() => {\n                        clearTimeout(resizeTimeout);\n                        resizeTimeout = setTimeout(updateExpandVisibility, 100);\n                    });\n                    resizeObserver.observe(vwrapper);\n                    // Initial check\n                    updateExpandVisibility();\n\n                    // Scroll into view #video-wrapper\n                    if ($body.hasClass('embed-mode')) {\n                        return;\n                    }\n                    $('#annotation-content')[0].scrollIntoView({behavior: \"smooth\", block: \"end\", inline: \"nearest\"});\n                }\n            };\n\n            /**\n             * Initializes the video player and its controls when the player is ready.\n             *\n             * This function performs the following tasks:\n             * - Checks if the player supports playback rate and quality adjustments, and updates the UI accordingly.\n             * - Sets the background image of the start screen if a poster image is available.\n             * - Adjusts the background of the video block to be transparent.\n             * - Retrieves the video duration and updates the end time if necessary.\n             * - Calculates the total playback time and updates the duration display.\n             * - Recalculates the aspect ratio of the video and updates the video wrapper's padding.\n             * - Sets the player as ready and focuses on the start button.\n             * - Initializes the seek head draggable functionality, allowing users to seek through the video.\n             *\n             * @async\n             * @function onReady\n             * @param {boolean} reloaded Whether the video is being reloaded.\n             * @param {boolean} main Whether the video is the default video.\n             * @returns {Promise<void>} A promise that resolves when the player is fully initialized and ready.\n             */\n            const onReady = async(reloaded = false, main = false) => {\n                if ((window.braveEthereum || window.braveSolana) && !player.allowAutoplay) {\n                    player.destroy();\n                    Toast.add(await getString('braveautoplay', 'mod_interactivevideo'), {\n                        type: 'danger',\n                        autohide: false,\n                    });\n                    setTimeout(() => {\n                        $('#toast-0').css('margin-top', '70px');\n                        $('#interactivevideo-container').addClass('no-pointer-events');\n                    }, 500);\n                    return;\n                }\n\n                if (!reloaded) {\n                    player.pause();\n                    const isPaused = await player.isPaused();\n                    if (!isPaused) {\n                        if (!player.live) {\n                            await player.seek(start);\n                        }\n                        onReady();\n                        return;\n                    }\n                }\n\n                if (!loaded) {\n                    await onLoaded(reloaded);\n                }\n\n                if (player.audio) {\n                    $annotationcanvas.addClass('bg-black');\n                }\n\n                // Explanation: YT shows annoying related videos if the player is large enough when the script is loading.\n                // So we're tricking it by hiding the canvas which also hides the #player first\n                // and only shows it when player is ready.\n                $(\"#annotation-canvas\").removeClass('w-0 d-none');\n                $(\".video-block\").css('background', 'transparent');\n                if (displayoptions.useoriginalvideocontrols == 0) {\n                    $(\".video-block\").removeClass('no-pointer');\n                }\n\n                if (!reloaded) {\n                    await getAnnotations();\n                } else {\n                    if (main) {\n                        await renderAnnotationItems(releventAnnotations, start, end - start);\n                    } else {\n                        await renderAnnotationItems([], start, end - start);\n                    }\n                }\n\n                if (player.live) {\n                    // Remove the slash.\n                    $currenttime.next().removeClass('d-md-inline');\n                    $currenttime.removeClass('d-md-inline');\n                    $duration.text(await getString('live', 'mod_interactivevideo'));\n                    $remainingtime.text(await getString('live', 'mod_interactivevideo'));\n                    $taskinfo.addClass('no-pointer-events');\n                    end = Number.MAX_SAFE_INTEGER;\n                    // Progress 100%.\n                    replaceProgressBars(100);\n                    return;\n                } else {\n                    $currenttime.next().addClass('d-md-inline');\n                    $currenttime.addClass('d-md-inline');\n                }\n\n                if (!reloaded) {\n                    $seekhead.draggable({\n                        'containment': '#video-nav',\n                        'axis': 'x',\n                        'cursor': 'col-resize',\n                        'start': async function(event, ui) {\n                            const isPaused = await player.isPaused();\n                            if (!isPaused) {\n                                player.pause();\n                            }\n                            $(this).addClass('active');\n                            $taskinfo.addClass('no-pointer-events');\n                            $('#message').not('[data-placement=bottom]').not('.sticky').remove();\n                            $endscreen.fadeOut(300);\n                            $seek.append('<div id=\"position\"><div id=\"timelabel\"></div></div>');\n                            let $position = $('#position');\n                            const relX = ui.position.left;\n                            $position.css('left', (relX) + 'px');\n                            const percentage = relX / $(this).width();\n                            const time = percentage * totaltime;\n                            const formattedTime = convertSecondsToHMS(time);\n                            $position.find('#timelabel').text(formattedTime);\n                        },\n                        'drag': async function(event, ui) {\n                            let timestamp = ((ui.position.left) / $videoNav.width()) * totaltime + start;\n                            let percentage = ui.position.left / $videoNav.width();\n                            await replaceProgressBars(percentage * 100);\n                            $seek.find('#position').css('left', ui.position.left + 'px');\n                            $seek.find('#position #timelabel').text(convertSecondsToHMS(timestamp - start));\n                            await player.seek(timestamp);\n                        },\n                        'stop': async function() {\n                            // Reset the launched annotation.\n                            lastrun = null;\n                            viewedAnno = [];\n                            setTimeout(function() {\n                                $taskinfo.removeClass('no-pointer-events');\n                            }, 200);\n                            setTimeout(function() {\n                                $('#seekhead').removeClass('active');\n                                $seek.find('#position').remove();\n                            }, 1000);\n                            player.play();\n                        }\n                    });\n\n                    dispatchEvent('timeupdate', {'time': start}); // Dispatch the timeupdate event with the start time.\n                }\n            };\n\n            /**\n             * Handles the event when the video player is paused.\n             *\n             * This function performs the following actions:\n             * - Checks if the player is ready. If not, it exits early.\n             * - Clears the interval timer.\n             * - Updates the play/pause button icon to indicate 'play'.\n             * - Sets the tooltip of the play/pause button to 'play'.\n             */\n            let lastSaved;\n            const onPaused = async(savepoint = false) => {\n                if (!playerReady) {\n                    return;\n                }\n                $('#playpause').find('i').removeClass('bi-pause-fill').addClass('bi-play-fill');\n                $('#playpause').attr('data-original-title', await getString('playtooltip', 'mod_interactivevideo'));\n                if (player.live) {\n                    return;\n                }\n                cancelAnimationFrame(playingInterval);\n                // Save watched progress to database.\n                // We don't save the progress of the subvideo.\n                if (subvideo) {\n                    return;\n                }\n                if (savepoint || $body.hasClass('embed-mode') || $body.hasClass('iframe')\n                    || $body.hasClass('mobileapp') || navigator.userAgent.includes('MoodleMobile') || $body.hasClass('embed')) {\n                    let t = await player.getCurrentTime();\n                    let watchedpoint = Math.round(t);\n                    // Make sure the watchedpoint is not the same as the last saved point or so close to it.\n                    if ((Math.abs(watchedpoint - lastSaved) < 5 && watchedpoint != Math.round(end)) || watchedpoint < start + 5) {\n                        return;\n                    }\n                    lastSaved = watchedpoint;\n                    fetch(M.cfg.wwwroot + '/mod/interactivevideo/ajax.php', {\n                        method: 'POST',\n                        headers: {\n                            'Content-Type': 'application/x-www-form-urlencoded',\n                        },\n                        body: new URLSearchParams({\n                            action: 'update_watchedpoint',\n                            sesskey: M.cfg.sesskey,\n                            completionid: completionid,\n                            watchedpoint: watchedpoint,\n                            contextid: M.cfg.contextid\n                        }).toString(),\n                        keepalive: true\n                    });\n                }\n            };\n\n            let videoEnded = false;\n            /**\n             * Handles the end of the video playback.\n             *\n             *\n             * @returns {void}\n             *\n             * This function performs the following actions:\n             * - Checks if the player is ready.\n             * - Updates the UI to show the end screen and restart button.\n             * - Clears the interval and pauses the player.\n             * - Updates the play/pause button to show the play icon.\n             */\n            const onEnded = async() => {\n                if (!playerReady) {\n                    return;\n                }\n                if (videoEnded || player.live) {\n                    return;\n                }\n\n                let isPlaying = await player.isPlaying();\n                if (isPlaying) {\n                    player.pause();\n                    onEnded(); // Repeat until player is paused.\n                    return;\n                }\n\n                onPaused(); // Run the onPaused function to save the last watched point.\n\n                dispatchEvent('timeupdate', {'time': end});\n                $('#restart').removeClass('d-none').fadeIn(300);\n                $endscreen.removeClass('d-none').fadeIn(300);\n                dispatchEvent('ended', {'time': end});\n                replaceProgressBars(100);\n                videoEnded = true;\n                viewedAnno = [];\n\n                // Update the timeended field in the database if it is not already set.\n                if (!timeended) {\n                    $.ajax({\n                        url: M.cfg.wwwroot + '/mod/interactivevideo/ajax.php',\n                        method: \"POST\",\n                        dataType: \"text\",\n                        data: {\n                            action: 'update_timeended',\n                            sesskey: M.cfg.sesskey,\n                            completionid: completionid,\n                            contextid: M.cfg.contextid,\n                            courseid: course,\n                            interactivevideo: interaction,\n                            userid: userid,\n                            updatestate: extendedcompletion && JSON.parse(extendedcompletion).watchtillend == 1 ? 1 : 0,\n                        },\n                        success: function(data) {\n                            try {\n                                data = JSON.parse(data);\n                            } catch {\n                                return;\n                            }\n                            if (data) {\n                                timeended = true;\n                                dispatchEvent('completionupdated', {\n                                    response: JSON.stringify({\n                                        overallcomplete: data.overallcomplete,\n                                    })\n                                });\n                            }\n                        }\n                    });\n                }\n            };\n\n            /**\n             * Handles the seek event for the video player.\n             *\n             * @param {number} t - The time to seek to. If not provided, the current time of the player will be used.\n             * @returns {Promise<void>} - A promise that resolves when the seek operation is complete.\n             */\n            const onSeek = async(t) => {\n                if (!playerReady) {\n                    return;\n                }\n                if (player.live) {\n                    return;\n                }\n                if (t) {\n                    t = Number(t);\n                } else {\n                    t = await player.getCurrentTime();\n                }\n                if (!firstPlay) {\n                    // If seeking before the first play, then we need to set the resumetime to the current time.\n                    window.resumetime = t;\n                }\n                if (t > start && t < end) {\n                    $endscreen.addClass('d-none');\n                    $startscreen.addClass('d-none');\n                }\n                const percentage = (t - start) / (totaltime) * 100;\n                replaceProgressBars(percentage);\n                dispatchEvent('timeupdate', {'time': t});\n                // Reset the launched annotation to include only the ones that are before the current time.\n                viewedAnno = [];\n                releventAnnotations.forEach(x => {\n                    if (Number(x.timestamp) < t) {\n                        viewedAnno.push(Number(x.id));\n                    }\n                });\n                // If lastrun timestamp is greater than t, then we need to reset it.\n                if (lastrun && releventAnnotations.find(x => x.id == lastrun).timestamp > t) {\n                    lastrun = null;\n                }\n            };\n\n            let visualized = false;\n            let playingInterval = null;\n            let firstPlay = false;\n            /**\n             * Handles the 'playing' event of the video player.\n             * This function is triggered when the video is playing and performs various actions such as:\n             * - Resetting the annotation content.\n             * - Handling fullscreen mode for mobile themes.\n             * - Hiding modals and messages.\n             * - Updating the play/pause button state.\n             * - Managing the video progress and annotations.\n             *\n             * @async\n             * @function onPlaying\n             * @returns {Promise<void>} A promise that resolves when the function completes.\n             */\n            const onPlaying = async() => {\n                // Reset the annotation content.\n                if (!playerReady) {\n                    return;\n                }\n\n                if (player.live) {\n                    return;\n                }\n\n                if (!firstPlay) {\n                    dispatchEvent('iv:playerStart');\n                    replaceProgressBars(window.resumetime ? (window.resumetime - start) / totaltime * 100 : 0);\n                    viewedAnno = [];\n                    firstPlay = true;\n                    if (window.resumetime && window.resumetime > start && window.resumetime < end) {\n                        if (player.allowAutoplay) {\n                            await player.seek(window.resumetime);\n                        } else {\n                            await player.pause();\n                            await player.seek(window.resumetime);\n                            player.play();\n                        }\n                    }\n                    player.unMute();\n                    dispatchEvent('iv:playerStarted');\n                }\n\n                const intervalFunction = async function() {\n                    const isPlaying = await player.isPlaying();\n                    const isEnded = await player.isEnded();\n                    const isPaused = await player.isPaused();\n                    if (isEnded) {\n                        onEnded();\n                        return;\n                    }\n                    if (isPaused) {\n                        onPaused();\n                        return;\n                    }\n                    if (!isPlaying) {\n                        if (player.type == 'spotify' || player.type == 'rutube' || player.type == 'yt') {\n                            player.pause();\n                            cancelAnimationFrame(playingInterval);\n                        }\n                        return;\n                    }\n\n                    let t = await player.getCurrentTime();\n                    t = Number(t);\n\n                    if (t > end) {\n                        onEnded();\n                        return;\n                    }\n\n                    videoEnded = false;\n\n                    dispatchEvent('timeupdate', {'time': t});\n\n                    const time = Number(t.toFixed(2));\n                    // If it is the same annotation we just run, then we don't need to run it again.\n                    let percentagePlayed = (t - start) / totaltime;\n                    percentagePlayed = percentagePlayed > 1 ? 1 : percentagePlayed;\n                    replaceProgressBars(percentagePlayed * 100);\n\n                    if (subvideo) {\n                        return;\n                    }\n\n                    const theAnnotation = releventAnnotations.find(x => (((t - lookbacktime).toFixed(2) <= x.timestamp\n                        && (t + player.frequency).toFixed(2) >= x.timestamp) || time == x.timestamp) &&\n                        x.id != 0 && !viewedAnno.includes(Number(x.id)));\n\n                    if (theAnnotation) {\n                        viewedAnno = [];\n                        releventAnnotations.forEach(x => {\n                            if (Number(x.timestamp) < t) {\n                                viewedAnno.push(Number(x.id));\n                            }\n                        });\n\n                        $interactionNav.find('.annotation[data-id=\"' + theAnnotation.id + '\"] .item').trigger('mouseover')\n                            .addClass('active');\n                        if (isBS5) {\n                            $interactionNav.find('.annotation[data-id=\"' + theAnnotation.id + '\"] [data-bs-toggle=tooltip]')\n                                .tooltip('show');\n                        }\n                        setTimeout(function() {\n                            $interactionNav.find('.annotation[data-id=\"' + theAnnotation.id + '\"] .item')\n                                .trigger('mouseout').removeClass('active');\n                            if (isBS5) {\n                                $interactionNav.find('.annotation[data-id=\"' + theAnnotation.id + '\"] [data-bs-toggle=tooltip]')\n                                    .tooltip('hide');\n                            }\n                        }, 2000);\n\n                        if (lastrun && theAnnotation.id == lastrun) {\n                            return;\n                        }\n                        // If in preview mode, don't run the interaction.\n                        if (isPreviewMode) {\n                            return;\n                        }\n                        // Run the interaction if it isn't complete or rerunnable.\n                        if (!theAnnotation.completed || theAnnotation.rerunnable) {\n                            replaceProgressBars((theAnnotation.timestamp - start) / totaltime * 100);\n                            if (time < theAnnotation.timestamp - player.frequency) {\n                                await player.seek(theAnnotation.timestamp);\n                            }\n                            runInteraction(theAnnotation);\n                        } else {\n                            if (theAnnotation.completed) {\n                                if (time < theAnnotation.timestamp - player.frequency) {\n                                    await player.seek(theAnnotation.timestamp);\n                                }\n                                viewedAnno.push(Number(theAnnotation.id));\n                            }\n                        }\n                    }\n                };\n\n                if (player.useAnimationFrame) {\n                    const animate = async() => {\n                        const isPlaying = await player.isPlaying();\n                        if (isPlaying) {\n                            intervalFunction();\n                            playingInterval = requestAnimationFrame(animate);\n                        }\n                    };\n                    playingInterval = requestAnimationFrame(animate);\n                } else {\n                    const isPlaying = await player.isPlaying();\n                    if (isPlaying) {\n                        intervalFunction();\n                    }\n                }\n            };\n\n            const onPlay = async() => {\n                if (!playerReady) {\n                    return;\n                }\n                $body.removeClass('disablekb');\n                // Initialize the player visualizer for html5 audio.\n                if (player.audio && !visualized) {\n                    player.visualizer();\n                    visualized = true;\n                }\n                // Force fullscreen for mobile themes and mobile devices.\n                if ($body.hasClass('mobiletheme') && !$wrapper.hasClass('fullscreen')) {\n                    $(\"#fullscreen\").trigger('click');\n                }\n\n                $('#playpause').find('i').removeClass('bi-play-fill').addClass('bi-pause-fill');\n                $('#playpause').attr('data-original-title', await getString('pausetooltip', 'mod_interactivevideo'));\n\n                if ($('#message.active').length > 0) {\n                    $('#message.active').each(function() {\n                        const mid = $(this).data('id');\n                        if (mid) {\n                            $(this).removeClass('active');\n                            dispatchEvent('interactionclose', {'annotation': {'id': mid}});\n                        }\n                    });\n                }\n\n                $('#annotation-modal').modal('hide');\n                $('#message').not('[data-placement=bottom]').not('.sticky').remove();\n\n                if (!videoEnded) {\n                    $endscreen.fadeOut(300);\n                    $startscreen.fadeOut(300);\n                    $('#restart').addClass('d-none');\n                } else {\n                    viewedAnno = [];\n                }\n\n                // Autohide controls if $videowrapper is not hovered after 5 seconds.\n                if (displayoptions.autohidecontrols == 1\n                    && !$body.hasClass('embed-mode') && !$body.hasClass('mobileapp') && !$body.hasClass('iframe')) {\n                    setTimeout(function() {\n                        if (!$videowrapper.is(':hover')) {\n                            $controller.addClass('fadeOut');\n                        }\n                    }, 5000);\n                }\n            };\n\n            // Implement the player.\n            require(['mod_interactivevideo/player/' + vtype], function(VideoPlayer) {\n                player = new VideoPlayer();\n                player.poster = $('#posterimagehidden').attr('src');\n                player.doptions = doptions;\n                player.title = $('#titlehidden').val();\n                if (displayoptions.passwordprotected == 1 && player.support.password) {\n                    // Remove start screen, set .video-block to d-none, #annotation-canvas remove d-none.\n                    $startscreen.addClass('d-none');\n                    $('.video-block').addClass('no-pointer bg-transparent');\n                    $annotationcanvas.removeClass('d-none w-0');\n                }\n                player.load(url,\n                    start,\n                    end,\n                    {\n                        'showControls': displayoptions.useoriginalvideocontrols == 1,\n                        'customStart': true,\n                        'preload': false,\n                        'autoplay': displayoptions.autoplay == 1,\n                        'passwordprotected': displayoptions.passwordprotected == 1 && player.support.password,\n                    });\n            });\n\n            // Move toast-wrapper to the #wrapper element so it can be displayed on top of the video in fullscreen mode.\n            let $toast = $('.toast-wrapper').detach();\n            $wrapper.append($toast);\n\n            $(document).on('click', '.completion-required', async function(e) {\n                e.preventDefault();\n                e.stopImmediatePropagation();\n                Toast.add(await getString('youmustcompletethistaskfirst', 'mod_interactivevideo'), {\n                    type: 'danger'\n                });\n                return;\n            });\n\n            const handleUnskippable = async(t) => {\n                // Handle unskippable interactions.\n                if (!t) {\n                    t = await player.getCurrentTime();\n                }\n                if (!t) {\n                    return false;\n                }\n                if (releventAnnotations) {\n                    const theAnnotation = releventAnnotations.find(x => Number(x.timestamp) < Number(t.toFixed(2))\n                        && x.completed == false && JSON.parse(x.advanced).advskippable == 0 && x.hascompletion == 1);\n                    if (theAnnotation) {\n                        await player.pause();\n                        await player.seek(theAnnotation.timestamp);\n                        runInteraction(theAnnotation);\n                        Toast.add(await getString('youmustcompletethistaskfirst', 'mod_interactivevideo'), {\n                            type: 'danger'\n                        });\n                        replaceProgressBars((theAnnotation.timestamp - start) / totaltime * 100);\n                        return true;\n                    }\n                }\n                return false;\n            };\n\n            $(document).on('timeupdate', async function(e) {\n                if (!playerReady || isPreviewMode || player.live) {\n                    return;\n                }\n                const t = e.originalEvent.detail.time;\n                if (preventskip && releventAnnotations) {\n                    // Check if there is any uncompleted activity before the current time.\n                    const theAnnotations = releventAnnotations.filter(x => Number(x.timestamp) < Number(t.toFixed(2))\n                        && x.completed == false && x.hascompletion == 1);\n                    if (theAnnotations.length > 0) {\n                        const theAnnotation = theAnnotations[0];\n                        await player.pause();\n                        await player.seek(theAnnotation.timestamp);\n                        runInteraction(theAnnotation);\n                        Toast.add(await getString('youmustcompletethistaskfirst', 'mod_interactivevideo'), {\n                            type: 'danger'\n                        });\n                        replaceProgressBars((theAnnotation.timestamp - start) / totaltime * 100);\n                    }\n                }\n                handleUnskippable(t);\n            });\n\n            // Handle the refresh button:: allowing user to refresh the content\n            $(document).on('click', '#message #refresh', function(e) {\n                e.preventDefault();\n                e.stopImmediatePropagation();\n                $(this).tooltip('hide');\n                const id = $(this).data('id');\n                const annotation = releventAnnotations.find(x => x.id == id);\n                $(this).closest('#message').remove();\n                dispatchEvent('interactionrefresh', {'annotation': annotation});\n                runInteraction(annotation, true);\n            });\n\n            // Handle video control events:: fullscreen toggle\n            $(document).on('click', '#fullscreen', async function(e) {\n                e.preventDefault();\n                if (!playerReady) {\n                    return;\n                }\n\n                // Put the wrapper in fullscreen mode\n                let elem = document.getElementById('wrapper');\n                $('#fullscreen').toggleClass('active');\n                if (!$wrapper.hasClass('fullscreen')) {\n                    if (elem.requestFullscreen) {\n                        elem.requestFullscreen();\n                    } else if (elem.mozRequestFullScreen) { /* Firefox */\n                        elem.mozRequestFullScreen();\n                    } else if (elem.webkitRequestFullscreen) { /* Chrome, Safari and Opera */\n                        elem.webkitRequestFullscreen();\n                    } else if (elem.msRequestFullscreen) { /* IE/Edge */\n                        elem.msRequestFullscreen();\n                    } else if (elem.webkitEnterFullscreen) { /* IOS Safari */\n                        elem.webkitEnterFullscreen();\n                    } else {\n                        Toast.add(await getString('fullscreenisnotsupported', 'mod_interactivevideo'), {\n                            type: 'danger'\n                        });\n                        // Remove the fullscreen button.\n                        $('#fullscreen').remove();\n                    }\n                } else {\n                    if (document.exitFullscreen) {\n                        document.exitFullscreen();\n                    } else if (document.mozCancelFullScreen) { /* Firefox */\n                        document.mozCancelFullScreen();\n                    } else if (document.webkitExitFullscreen) { /* Chrome, Safari and Opera */\n                        document.webkitExitFullscreen();\n                    } else if (document.msExitFullscreen) { /* IE/Edge */\n                        document.msExitFullscreen();\n                    }\n                }\n            });\n\n            $(document).on('fullscreenchange', async function() {\n                if (document.fullscreenElement) {\n                    $wrapper.addClass('fullscreen');\n                    $('#interactivevideo-container').addClass('fullscreen');\n                    $videowrapper.css('padding-bottom', '0');\n                    $wrapper.find(`[data${bsAffix}-toggle=\"tooltip\"]`).tooltip({\n                        container: '#wrapper',\n                        boundary: 'window',\n                    });\n                    $controller.addClass('bg-black').removeClass('bg-dark');\n                } else {\n                    $wrapper.removeClass('fullscreen');\n                    $('#interactivevideo-container').removeClass('fullscreen');\n                    let ratio = 16 / 9;\n                    if (!displayoptions.usefixedratio || displayoptions.usefixedratio == 0) {\n                        ratio = player.aspectratio;\n                    }\n                    $videowrapper.css('padding-bottom', (1 / ratio) * 100 + '%');\n                    $controller.addClass('bg-dark').removeClass('bg-black');\n                }\n                $wrapper.find('#fullscreen i').toggleClass('bi-fullscreen bi-fullscreen-exit');\n            });\n\n            $(document).on('visibilitychange', async function() {\n                // Pause video when the tab is not visible and the pauseonblur option is enabled.\n                if (displayoptions.pauseonblur && displayoptions.pauseonblur == 1) {\n                    if (!playerReady) {\n                        return;\n                    }\n                    if (document.visibilityState == 'hidden') {\n                        player.pause();\n                        onPaused(true);\n                    }\n                }\n            });\n\n            // Handle player size change event.\n            $(document).on('click', '#controller #expand', function(e) {\n                e.preventDefault();\n                $body.toggleClass('limited-width');\n                localStorage.setItem('limitedwidth', $body.hasClass('limited-width'));\n                $(this).find('i').toggleClass('bi-square bi-file');\n            });\n\n            // Handle share this moment event.\n            $(document).on('click', '#controller #share', async function(e) {\n                e.preventDefault();\n                e.stopImmediatePropagation();\n                let time = await player.getCurrentTime();\n                const url = window.location.href;\n                let shareurl = url + (url.indexOf('?') > 0 ? '&' : '?') + 't=' + Math.round(time);\n                // Remove the embed parameter if it exists.\n                shareurl = shareurl.replace(/&embed=1/g, '');\n                // Add shareurl to clipboard.\n                await navigator.clipboard.writeText(shareurl);\n                const copied = await getString('copiedtoclipboard', 'mod_interactivevideo');\n                Toast.add(copied, {\n                    type: 'success',\n                    autohide: true,\n                    delay: 2000,\n                });\n            });\n\n            // Display time when user hover on the progress bar.\n            $(document).on('mouseenter', '#video-nav #seek', function(e) {\n                if (!playerReady) {\n                    return;\n                }\n                $(this).append('<div id=\"position\"><div id=\"timelabel\"></div></div>');\n                let $position = $('#position');\n                const parentOffset = $(this).offset();\n                const relX = e.pageX - parentOffset.left;\n\n                $position.css('left', (relX) + 'px');\n                const percentage = relX / $(this).width();\n                const time = percentage * totaltime;\n                const formattedTime = convertSecondsToHMS(time);\n                $position.find('#timelabel').text(formattedTime);\n            });\n\n            $(document).on('mousemove', '#video-nav #seek', function(e) {\n                if (!playerReady) {\n                    return;\n                }\n                const parentOffset = $(this).offset();\n                const relX = e.pageX - parentOffset.left;\n                const percentage = relX / $(this).width();\n                const time = percentage * totaltime;\n                const formattedTime = convertSecondsToHMS(time);\n                $('#position').css('left', (relX) + 'px');\n                $('#position #timelabel').text(formattedTime);\n            });\n\n            $(document).on('mouseleave', '#video-nav #seek', function() {\n                $('#position').remove();\n            });\n\n            // Handle annotation click event:: when user click on the annotation on the progress bar\n            $(document).on('click', '#interactions-nav .annotation, #video-nav .annotation', async function(e) {\n                e.preventDefault();\n                e.stopImmediatePropagation();\n                const timestamp = $(this).data('timestamp');\n\n                let hasSkippable = await handleUnskippable(timestamp);\n                if (hasSkippable) {\n                    return;\n                }\n\n                $loader.fadeIn(300);\n                if ($(this).hasClass('no-click')) {\n                    // Add a tooltip that seeking is disabled.\n                    Toast.add(await getString('youcannotviewthisannotationyet', 'mod_interactivevideo'), {\n                        type: 'danger'\n                    });\n                    return;\n                }\n                const currenttime = await player.getCurrentTime();\n                if (currenttime == timestamp && lastrun) {\n                    $loader.fadeOut(300);\n                    return;\n                }\n                lastrun = null;\n                const isPaused = await player.isPaused();\n                if (!isPaused) {\n                    player.pause();\n                }\n                await replaceProgressBars((timestamp - start) / totaltime * 100);\n                await player.seek(Number(timestamp));\n                const id = $(this).data('id');\n                const theAnnotation = releventAnnotations.find(x => x.id == id);\n                runInteraction(theAnnotation);\n                $loader.fadeOut(300);\n                // Clear the viewed annotations that are after this timestamp.\n                const preceedingAnno = releventAnnotations.filter(x => x.timestamp < timestamp).map(x => Number(x.id));\n                viewedAnno = preceedingAnno;\n                viewedAnno.push(id);\n                // Concatenate the preceeding annotations.\n                viewedAnno = [...new Set(viewedAnno)];\n            });\n\n            // Handle seeking event:: when user click on the progress bar\n            $(document).on('click', '#seek', async function(e) {\n                if (!playerReady) {\n                    return;\n                }\n                e.preventDefault();\n                e.stopImmediatePropagation();\n                if ($videoNav.hasClass('no-click')) {\n                    // Add a tooltip that seeking is disabled.\n                    Toast.add(await getString('seekingdisabled', 'mod_interactivevideo'), {\n                        type: 'danger'\n                    });\n                    return;\n                }\n                $startscreen.fadeOut(300);\n                $endscreen.fadeOut(300);\n                const parentOffset = $(this).offset();\n                const relX = e.pageX - parentOffset.left;\n                const percentage = relX / $(this).width();\n                await replaceProgressBars(percentage * 100);\n                $loader.fadeIn(300);\n                await player.seek((percentage * totaltime) + start);\n                const isPlaying = await player.isPlaying();\n                if (!isPlaying || videoEnded) {\n                    await player.play();\n                }\n                viewedAnno = [];\n                setTimeout(() => {\n                    // Remove the position.\n                    $('#position').remove();\n                    $loader.fadeOut(300);\n                }, 300);\n            });\n\n            // Handle video control events:: play\n            $(document).on('click', '#start-screen #play', async function(e) {\n                e.preventDefault();\n                if ($(this).hasClass('reload')) {\n                    location.reload();\n                    return;\n                }\n                $startscreen.find('.h1').addClass('trantohide');\n                $startscreen.fadeOut(300);\n                $(this).addClass('d-none');\n                $videoNav.removeClass('d-none');\n                try {\n                    player.play();\n                } catch (error) {\n                    // Do nothing.\n                }\n            });\n\n            // Handle video control events:: restart\n            $(document).on('click', '#end-screen #restart', async function(e) {\n                e.preventDefault();\n                dispatchEvent('iv:playerRestart');\n                $('#message').remove();\n                // Remove sidebar/drawer.\n                if ($body.hasClass('hassidebar')) {\n                    $('#annotation-toggle').trigger('click');\n                    $('#annotation-sidebar, #annotation-toggle').remove();\n                    $body.removeClass('hassidebar');\n                    $('.iv-sidebar').addClass('hide');\n                }\n\n                viewedAnno = [];\n                lastrun = null;\n                $loader.fadeIn(300);\n                await player.seek(start);\n                replaceProgressBars(0);\n                $endscreen.fadeOut(300);\n                $(this).addClass('d-none');\n                $videoNav.removeClass('d-none');\n                player.play();\n                $loader.fadeOut(300);\n            });\n\n            // Handle video control events:: pause/resume when user click on the video\n            $(document).on('click', '#video-wrapper .video-block', async function(e) {\n                if (!playerReady) {\n                    return;\n                }\n                e.preventDefault();\n                if (player.live) {\n                    firstPlay = true;\n                }\n                if (!firstPlay) {\n                    player.play();\n                    return;\n                }\n                // Pause or resume the video.\n                const playing = await player.isPlaying();\n                if (playing) {\n                    await player.pause();\n                } else {\n                    player.play();\n                }\n            });\n\n            $(document).on('iv:playerStarted', async function() {\n                $('#playpause').find('i').removeClass('bi-play-fill').addClass('bi-pause-fill');\n                $('#playpause').attr('data-original-title', await getString('pausetooltip', 'mod_interactivevideo'));\n            });\n\n            $(document).on('click', '#playpause', async function(e) {\n                if (!playerReady) {\n                    return;\n                }\n                e.preventDefault();\n                $(this).tooltip('hide');\n                // Pause or resume the video.\n                const playing = await player.isPlaying();\n                if (playing) {\n                    await player.pause();\n                } else {\n                    let t = await player.getCurrentTime();\n                    if (t >= end) {\n                        $endscreen.find('#restart').trigger('click');\n                    } else {\n                        player.play();\n                    }\n                }\n            });\n\n            $(document).on('click', 'li.anno', async function(e) {\n                e.preventDefault();\n                const id = $(this).data('id');\n                $(`li.annotation[data-id=${id}]`).trigger('click');\n                if ($(this).closest('#chapter-container-left').length > 0) {\n                    $('#chaptertoggle .btn').trigger('click');\n                }\n            });\n\n            $(document).on('click', '#toolbar #annotation-toggle', function(e) {\n                e.preventDefault();\n                $body.addClass('hassidebar');\n                $('#annotation-sidebar').removeClass('hide');\n                // Get the active annotation.\n                const current = $(`#sidebar-nav .sidebar-nav-item.active`).data('id');\n                if (current) {\n                    // Dispatch the interaction run event.\n                    dispatchEvent('interactionrun', {'annotation': releventAnnotations.find(x => x.id == current)});\n                }\n            });\n\n            // Autohide controls when mouse leaves #video-wrapper after 5 seconds.\n            if (displayoptions.autohidecontrols == 1\n                && !$body.hasClass('embed-mode') && !$body.hasClass('mobileapp') && !$body.hasClass('iframe')) {\n                $videowrapper.on('mouseleave', function() {\n                    setTimeout(function() {\n                        // Check if the mouse is still over #video-wrapper.\n                        if ($videowrapper.is(':hover')) {\n                            return;\n                        }\n                        // Hide the controls.\n                        $controller.addClass('fadeOut');\n                    }, 3000);\n                });\n\n                $videowrapper.on('mouseenter', function() {\n                    setTimeout(function() {\n                        if (!$videowrapper.is(':hover')) {\n                            return;\n                        }\n                        $controller.removeClass('fadeOut');\n                    }, 1000); // To avoid accidental mouseenter event.\n                });\n            }\n\n            // Handle video control events:: mute/unmute\n            $(document).on('click', '#mute', async function(e) {\n                e.preventDefault();\n                $(this).tooltip('hide');\n                $(this).toggleClass('active');\n                if ($(this).hasClass('active')) {\n                    player.mute();\n                    $(this).attr('data-original-title', await getString('unmutetooltip', 'mod_interactivevideo'));\n                } else {\n                    player.unMute();\n                    $(this).attr('data-original-title', await getString('mutetooltip', 'mod_interactivevideo'));\n                }\n                $(this).find('i').toggleClass('bi-volume-mute bi-volume-up');\n                $(this).tooltip('show');\n            });\n\n            // Handle video control events:: playrate change\n            $(document).on('click', '.changerate', function(e) {\n                e.preventDefault();\n                const rate = $(this).data('rate');\n                player.setRate(rate);\n                $('.changerate').find('i').removeClass('bi-check');\n                $(this).find('i').addClass('bi-check');\n            });\n\n            // Handle video control:: Quality change\n            $(\"#changequality\").on('shown.bs.dropdown', async function() {\n                let quality = await player.getQualities();\n                $('#qualitieslist').empty();\n                let currentQuality = quality.currentQuality;\n                if (currentQuality === null) {\n                    currentQuality = $(this).data('current');\n                }\n                let qualities = quality.qualities;\n                let qualitiesLabel = quality.qualitiesLabel;\n                qualities.forEach((q, i) => {\n                    $('#qualitieslist').append(`<a class=\"dropdown-item changequality text-white px-3\" data-quality=\"${q}\"\n                         href=\"#\"><i class=\"bi ${q == currentQuality ? 'bi-check' : ''} fa-fw\"></i>${qualitiesLabel[i]}</a>`);\n                });\n                $(this).find(`[data${bsAffix}-toggle=dropdown]`).dropdown('update');\n            });\n\n            $(document).on('click', '.changequality', function(e) {\n                e.preventDefault();\n                const quality = $(this).data('quality');\n                player.setQuality(quality);\n                $('.changequality').find('i').removeClass('bi-check');\n                $(this).find('i').addClass('bi-check');\n            });\n\n            $(document).on('click', '#changecaption .changecaption', function(e) {\n                e.preventDefault();\n                const lang = $(this).data('lang');\n                player.setCaption(lang);\n                $('#changecaption .changecaption').find('i').removeClass('bi-check');\n                $(this).find('i').addClass('bi-check');\n                if (lang == '') {\n                    $('#changecaption .btn i').removeClass('bi-badge-cc-fill').addClass('bi-badge-cc');\n                } else {\n                    $('#changecaption .btn i').removeClass('bi-badge-cc').addClass('bi-badge-cc-fill');\n                }\n                // Save the caption language to local storage.\n                localStorage.setItem(`caption-${userid}`, lang);\n            });\n\n            if (displayoptions.preventseeking == 0) {\n                $rewindbutton.on('click', async function() {\n                    let t = await player.getCurrentTime() - 5;\n                    if (t < start) {\n                        t = start;\n                    }\n                    await player.seek(t);\n                });\n\n\n                $forwardbutton.on('click', async function() {\n                    let t = await player.getCurrentTime() + 5;\n                    if (t > end) {\n                        t = end;\n                    }\n                    await player.seek(t);\n                });\n            }\n\n            $(document).one('iv:playerReady', function() {\n                onReady();\n            });\n\n            $(document).on('iv:playerDestroyed', function() {\n                playerReady = false;\n            });\n\n            const addPlayerEvents = function() {\n                $(document).on('iv:playerPaused', function() {\n                    // Remove the tooltip.\n                    $('.tooltip').remove();\n                    dispatchEvent('videoPaused');\n                    onPaused();\n                });\n\n                $(document).on('iv:playerPlaying', function() {\n                    onPlaying();\n                });\n\n                $(document).on('iv:playerPlay', function() {\n                    onPlay();\n                    $loader.fadeOut(300);\n                });\n\n                $(document).on('iv:playerEnded', function() {\n                    onEnded();\n                });\n\n                $(document).on('iv:playerSeek', function(e) {\n                    if (player.live) {\n                        return;\n                    }\n                    onSeek(e.detail.time);\n                });\n\n                $(document).on('iv:playerLoaded', function(e) {\n                    const reloaded = e.detail.reloaded || false;\n                    onLoaded(reloaded, e);\n                });\n\n                $(document).on('iv:playerError', async function() {\n                    $annotationcanvas.removeClass('d-none w-0');\n                    $startscreen.addClass('d-none');\n                    $('.video-block').addClass('no-pointer bg-transparent');\n                    $('#spinner').remove();\n                    if ($('#player').is(':empty')) {\n                        $('#player').html(`<div class=\"alert alert-danger d-flex text-center h-100 rounded-0\n                         align-items-center justify-content-center\">\n                        <img src=\"${M.cfg.wwwroot}/mod/interactivevideo/pix/404-error.png\" alt=\"Error\" class=\"w-25\">\n                        </div>`);\n                    } else {\n                        Toast.add(await getString('thereisanissueloadingvideo', 'mod_interactivevideo'), {\n                            type: 'danger'\n                        });\n                    }\n                });\n\n                $(document).on('iv:playerRateChange', function(e) {\n                    $('.changerate').find('i').removeClass('bi-check');\n                    $(`.changerate[data-rate=\"${e.originalEvent.detail.rate}\"]`).find('i').addClass('bi-check');\n                });\n\n                $(document).on('iv:playerQualityChange', function(e) {\n                    $('#changequality').attr('data-current', e.originalEvent.detail.quality);\n                    $('.changequality').find('i').removeClass('bi-check');\n                    $(`.changequality[data-quality=\"${e.originalEvent.detail.quality}\"]`).find('i').addClass('bi-check');\n                });\n            };\n\n            addPlayerEvents();\n\n            $(document).on('annotationitemsrendered', function() {\n                try {\n                    $wrapper.find(`[data${bsAffix}-toggle=\"tooltip\"]`).tooltip({\n                        container: '#wrapper',\n                        boundary: 'window',\n                    });\n                } catch (error) {\n                    // Do nothing.\n                }\n                if (displayoptions.disableinteractionclickuntilcompleted == 1) {\n                    $interactionNav.find('li:not(.completed)').addClass('no-click');\n                }\n                if (displayoptions.disableinteractionclick == 1) {\n                    $interactionNav.find('li').addClass('no-click');\n                }\n                if (displayoptions.preventseeking == 1) {\n                    $interactionNav.find('li').addClass('no-click');\n                    $videoNav.addClass('no-click');\n                }\n                if ($interactionNav.find('li').length > 0) {\n                    $taskinfo.removeClass('border-0');\n                }\n\n                if (!playerReady) {\n                    playerReady = true;\n                }\n\n                // Autoplay if enabled and in right conditions.\n                if (!isPreviewMode && !firstPlay) {\n                    let autoplay = displayoptions.autoplay == 1;\n                    let time = start;\n                    if ($('.intro-content').hasClass('hasintro')) {\n                        autoplay = false;\n                    }\n                    if ((uprogress.lastviewed > start && uprogress.lastviewed < end - 5) || moment) {\n                        autoplay = true;\n                        time = moment ? Number(moment) : uprogress.lastviewed;\n                        time = time >= end || time < start ? start : time;\n                    }\n                    window.resumetime = time;\n                    replaceProgressBars(((time - start) / totaltime) * 100);\n                    if (player.live) {\n                        replaceProgressBars(100);\n                    }\n                    // Get noautoplay from the URL.\n                    const urlParams = new URLSearchParams(window.location.search);\n                    const noautoplay = urlParams.get('da');\n                    if (autoplay && player.allowAutoplay && noautoplay != '1') {\n                        setTimeout(async() => {\n                            // Make sure to unmute.\n                            try {\n                                player.unMute();\n                            } catch (error) {\n                                // Do nothing.\n                            }\n                            if (!moment) {\n                                $('#play').trigger('click');\n                            }\n                        }, 1000);\n                    }\n                    shareMoment();\n                }\n            });\n\n            $(`[data${bsAffix}-toggle=\"tooltip\"]`).on('click', function() {\n                const $this = $(this);\n                $this.tooltip('hide');\n            });\n\n            window.addEventListener('beforeunload', function() {\n                player.pause();\n                onPaused(true);\n                // Remove all event listeners before unload.\n                $(document).off();\n                cancelAnimationFrame(playingInterval);\n            });\n\n            $(document).on('interactionrun', function(e) {\n                const annotation = e.originalEvent.detail.annotation;\n                // Update start time to the window.IVANNO item.\n                let windowAnnos = window.ANNOS;\n                let windowAnno = windowAnnos.find(x => x.id == annotation.id);\n\n                if (windowAnno) {\n                    windowAnno.starttime = windowAnno.starttime ? windowAnno.starttime : new Date().getTime();\n                    windowAnno.newstarttime = new Date().getTime();\n                    windowAnno.completedtime = windowAnno.completedtime ? windowAnno.completedtime : null;\n                    windowAnno.duration = windowAnno.duration > 0 ? windowAnno.duration : 0;\n                }\n                // Put it back in the window.\n                windowAnnos = windowAnnos.filter(x => x.id != annotation.id);\n                windowAnnos.push(windowAnno);\n                window.ANNOS = windowAnnos;\n            });\n\n            $(document).on('interactionclose interactionrefresh', function(e) {\n                const annotation = e.originalEvent.detail.annotation;\n                // Update start time to the window.IVANNO item.\n                let windowAnnos = window.ANNOS;\n                let windowAnno = windowAnnos.find(x => x.id == annotation.id);\n\n                if (windowAnno) {\n                    windowAnno.duration = windowAnno.duration + (new Date().getTime() - windowAnno.newstarttime);\n                }\n                // Put it back in the window.\n                windowAnnos = windowAnnos.filter(x => x.id != annotation.id);\n                windowAnnos.push(windowAnno);\n                window.ANNOS = windowAnnos;\n            });\n\n            $(document).on('completionupdated', async function(e) {\n                let overallcomplete = JSON.parse(e.originalEvent.detail.response).overallcomplete;\n                if (overallcomplete) {\n                    if (JSON.parse(e.originalEvent.detail.response).overallcomplete > 0) {\n                        if (isCompleted) {\n                            return;\n                        }\n                        isCompleted = true;\n                        fireConfetti();\n                        Toast.add(await getString('congratulationsyoucompletethisactivity', 'mod_interactivevideo'), {\n                            type: 'success',\n                        });\n                        $('#completiondropdown').html(`<i class=\"fs-25px bi bi-check-circle-fill text-success\"></i>`);\n                    } else {\n                        isCompleted = false;\n                        $('#completiondropdown').html(`<i class=\"fs-25px bi bi-check-circle text-white\"></i>`);\n                    }\n                }\n                const annotation = e.originalEvent.detail.target;\n                if (!annotation) {\n                    return;\n                }\n                let windowAnnos = window.ANNOS;\n                let windowAnno = windowAnnos.find(x => x.id == annotation.id);\n                if (windowAnno) {\n                    if (e.originalEvent.detail.action == 'mark-done') {\n                        windowAnno.completedtime = new Date().getTime();\n                    } else {\n                        windowAnno.completedtime = null;\n                    }\n                }\n                // Put it back in the window.\n                windowAnnos = windowAnnos.filter(x => x.id != annotation.id);\n                windowAnnos.push(windowAnno);\n                window.ANNOS = windowAnnos;\n\n                // Handle the dismissible setting.\n                $('#message[data-id=' + annotation.id + ']').addClass('active'); // Make sure the message is active.\n                let anno = releventAnnotations.find(x => x.id == annotation.id);\n                let advanced = anno.advanced;\n                advanced = advanced ? JSON.parse(advanced) : {};\n                if (advanced.advdismissible == 0 && anno.completed) {\n                    $('#controller, #video-wrapper, .sidebar-nav-item')\n                        .removeClass('completion-required');\n                } else if (advanced.advdismissible == 0 && !anno.completed) {\n                    $controller.addClass('completion-required');\n                    if ($('#message.active').data('placement') == 'bottom' || $('#message.active').data('placement') == 'side') {\n                        $('#video-wrapper').addClass('completion-required');\n                    }\n                    if ($('#message.active').data('placement') == 'side') {\n                        $('.sidebar-nav-item').addClass('completion-required');\n                    }\n                }\n                if (anno.completed) {\n                    $('.sidebar-nav-item[data-id=' + annotation.id + ']').addClass('completed');\n                } else {\n                    $('.sidebar-nav-item[data-id=' + annotation.id + ']').removeClass('completed');\n                }\n            });\n\n            $(document).on('iv:autoplayBlocked', async function(e) {\n                e.preventDefault();\n                if (e.originalEvent.detail.requireVideoBlock === false) {\n                    $('.video-block').remove();\n                }\n\n                Toast.add(await getString('autoplayblocked', 'mod_interactivevideo'), {\n                    type: 'default',\n                    autohide: true,\n                    delay: 5000,\n                });\n            });\n\n            const updatePlayer = async(newPlayer) => {\n                player = newPlayer;\n                start = newPlayer.start;\n                end = newPlayer.end;\n                vtype = newPlayer.type;\n                loaded = false;\n                // Change player in all content types.\n                let types = Object.keys(ctRenderer);\n                return await Promise.all(types.map(async(type) => {\n                    return ctRenderer[type].setPlayer(newPlayer, start, end, vtype);\n                }));\n            };\n\n            $(document).on('iv:playerReload', async function(e) {\n                playerReady = true;\n                viewedAnno = [];\n                lastrun = null;\n                videoEnded = false;\n                let detail = e.originalEvent.detail;\n                if (detail.behavior == 'series') {\n                    subvideo = !detail.main;\n                } else {\n                    subvideo = false;\n                }\n\n                if (detail.player) {\n                    detail.player.subvideo = subvideo;\n                    await updatePlayer(detail.player, detail.behavior);\n                }\n\n                onReady(true, detail.main); // Main is true if the video is the default video.\n                replaceProgressBars(detail.currentTime / (end - start) * 100);\n            });\n\n            $(document).on('click', '#message[data-placement]:not(.active)', function(e) {\n                e.preventDefault();\n                $(this).addClass('active');\n                // Dispatch the interaction run event.\n                dispatchEvent('interactionrun', {'annotation': releventAnnotations.find(x => x.id == $(this).data('id'))});\n            });\n\n            // Implement keyboard shortcuts.\n            document.addEventListener('keydown', async function(e) {\n                // Ignore spacebar when focus is on an input, textarea, or button\n                const activeTag = document.activeElement.tagName.toLowerCase();\n                if (activeTag !== 'body') {\n                    return;\n                }\n\n                if ($body.hasClass('disablekb')) {\n                    return;\n                }\n\n                if (e.ctrlKey || e.metaKey || e.altKey) {\n                    return; // Ignore if any modifier keys are pressed.\n                }\n\n                switch (e.code) {\n                    case 'Space':\n                        e.preventDefault(); // Prevent page scroll.\n                        if (await player.isPaused()) {\n                            player.play();\n                        } else {\n                            player.pause();\n                        }\n                        break;\n                    case 'KeyC':\n                        e.preventDefault();\n                        $('#chaptertoggle .btn').trigger('click');\n                        break;\n                    case 'KeyM':\n                        e.preventDefault();\n                        if ($('#mute').length > 0) {\n                            $('#mute').trigger('click');\n                        } else {\n                            const isMuted = await player.isMuted();\n                            if (isMuted) {\n                                player.unMute();\n                            } else {\n                                player.mute();\n                            }\n                        }\n                        break;\n                    case 'KeyF':\n                        e.preventDefault();\n                        $('#fullscreen').trigger('click');\n                        break;\n                    case 'KeyR':\n                        e.preventDefault();\n                        $endscreen.find('#restart').trigger('click');\n                        break;\n                    case 'KeyS':\n                        e.preventDefault();\n                        $controller.find('#share').trigger('click');\n                        break;\n                    case 'KeyE':\n                        e.preventDefault();\n                        if ($controller.find('#expand').length > 0) {\n                            $controller.find('#expand').trigger('click');\n                        } else {\n                            $body.toggleClass('limited-width');\n                            localStorage.setItem('limitedwidth', $body.hasClass('limited-width'));\n                        }\n                        break;\n                    case 'ArrowLeft':\n                        e.preventDefault();\n                        $rewindbutton.trigger('click');\n                        break;\n                    case 'ArrowRight':\n                        e.preventDefault();\n                        $forwardbutton.trigger('click');\n                        break;\n                }\n            });\n        }\n    };\n});"],"names":["define","$","str","eventDispatcher","Toast","quickform","getString","get_string","dispatchEvent","ctRenderer","isBS5","hasClass","bsAffix","annotations","totaltime","activityType","contentTypes","displayoptions","releventAnnotations","completionid","player","lastrun","subvideo","viewedAnno","$videoNav","$interactionNav","$loader","$meta","$wrapper","renderAnnotationItems","async","annos","start","empty","find","preventseeking","addClass","length","window","IVANNO","actualduration","skipsegments","filter","x","type","forEach","Number","title","timestamp","completableAnno","hascompletion","actualAnnotationCounts","xp","map","reduce","a","b","completedAnnos","completed","xpEarned","earned","append","seconds","hours","Math","floor","minutes","remainingSeconds","string","formatTime","ceil","hidemainvideocontrols","hideinteractions","renderer","renderItemOnVideoNavigation","chapteritems","sort","advanced","JSON","parse","visiblebeforecompleted","visibleaftercompleted","each","cstart","this","data","cend","id","prop","icon","formattedtitle","hide","show","fireConfetti","confetti","animationEnd","Date","now","defaults","startVelocity","spread","ticks","zIndex","randomInRange","min","max","random","interval","setInterval","timeLeft","clearInterval","particleCount","origin","y","pop","Audio","M","cfg","wwwroot","point","IVAudio","init","url","cmid","interaction","course","userid","end","completionpercentage","gradeiteminstance","grademax","vtype","preventskip","moment","doptions","token","extendedcompletion","isPreviewMode","isCompleted","iseditor","text","$remainingtime","$currenttime","$lightprogressbar","$duration","$taskinfo","$seek","$startscreen","$endscreen","$controller","$videowrapper","$annotationcanvas","$rewindbutton","$forwardbutton","$body","$progressbar","$seekhead","contextid","courseid","require","isNaN","useoriginalvideocontrols","remove","playerReady","uprogress","timeended","localStorage","getItem","removeClass","convertSecondsToHMS","h","m","s","replaceProgressBars","livestring","Promise","resolve","time","percentage","live","css","getAnnotations","annnoitems","ajax","method","dataType","action","sesskey","courseContextId","userprogress","uid","previewmode","getContentTypes","fromview","when","done","progress","ct","completiondetails","Object","values","annotation","some","name","filterAnnotations","completedItems","completeditems","contentTypeMap","Map","completionitem","thisitem","percent","stringify","get","indexOf","e","rerunnable","replaybehavior","processAnnotations","shouldAdd","skipsegment","push","previewMode","getRelevantAnnotations","ANNOS","startChapter","unshift","prependDummyChapter","chapterContentType","includes","all","contentType","amdmodule","Type","error","initializeContentTypeRenderers","runInteraction","force","pause","isPaused","Set","modal","not","fadeOut","theAnnotations","theAnnotation","seek","add","trigger","setTimeout","shareMoment","urlParams","URLSearchParams","location","search","delete","newurl","protocol","host","pathname","toString","history","replaceState","updateTime","duration","toUpdatetime","loaded","lookbacktime","onLoaded","reloaded","$changecaption","captions","detail","tracks","html","menu","caption","i","code","label","lang","passwordprotected","support","password","IVPLAYER","frequency","playbackrate","quality","ratio","usefixedratio","aspectratio","gap","attr","focus","resizeTimeout","vwrapper","document","querySelector","lastExpandVisible","updateExpandVisibility","shouldShow","clientWidth","toggleClass","ResizeObserver","clearTimeout","observe","scrollIntoView","behavior","block","inline","onReady","main","braveEthereum","braveSolana","allowAutoplay","destroy","autohide","audio","next","MAX_SAFE_INTEGER","draggable","event","ui","$position","relX","position","left","width","formattedTime","play","lastSaved","onPaused","savepoint","cancelAnimationFrame","playingInterval","navigator","userAgent","t","getCurrentTime","watchedpoint","round","abs","fetch","headers","body","keepalive","videoEnded","onEnded","isPlaying","fadeIn","interactivevideo","updatestate","watchtillend","success","response","overallcomplete","onSeek","firstPlay","resumetime","visualized","onPlaying","unMute","intervalFunction","isEnded","toFixed","percentagePlayed","tooltip","useAnimationFrame","animate","requestAnimationFrame","onPlay","visualizer","mid","autohidecontrols","is","VideoPlayer","poster","val","load","autoplay","$toast","detach","on","preventDefault","stopImmediatePropagation","handleUnskippable","advskippable","originalEvent","closest","elem","getElementById","exitFullscreen","mozCancelFullScreen","webkitExitFullscreen","msExitFullscreen","requestFullscreen","mozRequestFullScreen","webkitRequestFullscreen","msRequestFullscreen","webkitEnterFullscreen","fullscreenElement","container","boundary","pauseonblur","visibilityState","setItem","href","shareurl","replace","clipboard","writeText","copied","delay","parentOffset","offset","pageX","preceedingAnno","reload","current","mute","rate","setRate","getQualities","currentQuality","qualities","qualitiesLabel","q","dropdown","setQuality","setCaption","one","addPlayerEvents","disableinteractionclickuntilcompleted","disableinteractionclick","lastviewed","noautoplay","addEventListener","off","windowAnnos","windowAnno","starttime","getTime","newstarttime","completedtime","target","anno","advdismissible","requireVideoBlock","updatePlayer","newPlayer","types","keys","setPlayer","currentTime","activeElement","tagName","toLowerCase","ctrlKey","metaKey","altKey","isMuted"],"mappings":"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"}