{"version":3,"file":"launch.min.js","sources":["../src/launch.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n\n/**\n * Launch the interactive video in modal on course page\n *\n * @module     mod_interactivevideo/launch\n * @copyright  2024 Sokunthearith Makara <sokunthearithmakara@gmail.com>\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\n\ndefine(['jquery'], function($) {\n    return {\n        init: function() {\n            // Launch the interactive video in modal\n            $(document).on('click', '.launch-interactivevideo', function(e) {\n                // Save the current document title.\n                let title = document.title;\n                // Get showcontrols from cache.\n                let showcontrols = localStorage.getItem('showcontrols') ? true : false;\n                e.preventDefault();\n                const id = $(this).data('id');\n                const instance = $(this).data('instance');\n                const course = $(this).data('course');\n                const contextid = $(this).data('contextid');\n                const $card = $(this).closest('#interactivevideo-' + instance);\n                $card.find('.image-container').addClass('hovered');\n                const modal = `<div class=\"modal fade p-0 modal-fullscreen rounded-0\" id=\"playermodal\"\n                data-backdrop=\"static\" data-keyboard=\"false\" tabindex=\"-1\" aria-labelledby=\"playermodalLabel\"\n                aria-hidden=\"true\">\n                   <div class=\"rounded-0 modal-dialog modal-dialog-centered modal-dialog-scrollable modal-xl position-relative\">\n                    <div class=\"position-fixed w-100 h-100 no-pointer bg-transparent z-index-1\" id=\"background-loading\">\n                        <div class=\"d-flex h-100 align-items-center justify-content-center\">\n                            <div class=\"spinner-border text-danger\" style=\"width: 3rem; height: 3rem;\" role=\"status\">\n                                <span class=\"sr-only\">Loading...</span>\n                            </div>\n                        </div>\n                    </div>\n                       <div class=\"modal-content ${showcontrols ? 'show-control' : ''} rounded-0 border-0\">\n                       <div class=\"modal-header border-0 text-white align-items-center py-0 h-0\n                        position-absolute w-100 z-index-1 rounded-0\">\n                         <div class=\"modal-background w-100 position-absolute\"></div>\n                               <span class=\"modal-title position-relative z-index-1 d-flex align-items-center overflow-hidden\"\n                                id=\"playermodalLabel\">\n                                <span class=\"h5 mb-0\">\n                                    <button type=\"button\" class=\"btn border-0 m-1 p-1 h5 bg-transparent\" data-dismiss=\"modal\"\n                                     aria-label=\"Close\">\n                                        <i class=\"fa fa-arrow-left text-white m-0 fa-2x\" aria-hidden=\"true\"></i>\n                                    </button>\n                                </span>\n\n                                <div class=\"d-sm-none d-block small ml-2\" data-region=\"activity-completion\">\n                                </div>\n                               </span>\n\n                               <div class=\"modal-action d-flex align-items-center position-relative z-index-1\">\n                               <div class=\"d-none d-sm-block small\" data-region=\"activity-completion\">\n                               </div>\n                               <span type=\"button\" class=\"btn ml-2 border-0 h5 mb-0 open-external-link\"\n                                data-href=\"${M.cfg.wwwroot}/mod/interactivevideo/view.php?id=${id}\">\n                               <i class=\"fa fa-external-link text-white m-0 fa-xl\" aria-hidden=\"true\"></i></span>\n                               </div>\n                           </div>\n                           <div class=\"modal-body p-0 position-relative overflow-hidden \">\n                           <iframe id=\"ivplayer\" src=\"${M.cfg.wwwroot}/mod/interactivevideo/view.php?id=${id}&embed=1\" frameborder=0\n                           class=\"w-100 position-absolute h-100\" allow=\"autoplay\"></iframe>\n                                <button type=\"button\" class=\"btn border-0 m-1 p-1 h5 toggle-controls d-none\">\n                                   <i class=\"fa fa-chevron-up text-white m-0 fa-2x\" aria-hidden=\"true\"></i>\n                                </button></span>\n                           </div>\n                       </div>\n                   </div>\n               </div>`;\n                $('#playermodal').remove(); // Important:: Remove the previous modal ONLY after the new one is created.\n                $('body').append(modal);\n                $('#playermodal').modal('show');\n\n                const headerFunction = function() {\n                    let $header = $('#playermodal .modal-header');\n                    if ($header.hasClass('show')) {\n                        return;\n                    }\n\n                    $header.addClass('show');\n                    $header.fadeIn();\n\n                    setTimeout(function() {\n                        $header.removeClass('show');\n                        $header.fadeOut();\n                    }, 5000);\n                };\n\n                let iframeDoc, iframeAnnos, details, player;\n                $('#playermodal').on('shown.bs.modal', function() {\n                    $('body').addClass('overflow-hidden');\n                    $(this).find('.modal-header').addClass('show');\n                    let $completion = $card.find('[data-region=activity-information]');\n                    $completion = $completion.clone();\n                    $(this).find('[data-region=\"activity-completion\"]').html($completion);\n                    // Listen the player timeupdate event in the iframe.\n                    let checkIframeDoc = function() {\n                        iframeDoc = document.getElementById('ivplayer').contentDocument;\n                        iframeAnnos = document.getElementById('ivplayer').contentWindow.IVANNO;\n                        if (!iframeDoc.getElementById('player')) {\n                            requestAnimationFrame(checkIframeDoc);\n                            return;\n                        }\n                        // Hide the background-loading.\n                        $('#background-loading').hide(0);\n                        if (!iframeAnnos) {\n                            requestAnimationFrame(checkIframeDoc);\n                            return;\n                        }\n\n                        player = document.getElementById('ivplayer').contentWindow.IVPLAYER;\n\n                        if (iframeDoc.getElementById('player')) {\n                            $('#playermodal .modal-header').removeClass('show');\n                            $('#playermodal .toggle-controls').removeClass('d-none');\n\n                            if (!showcontrols) {\n                                setTimeout(function() {\n                                    $('#playermodal .modal-content').removeClass('show-control');\n                                }, 1000);\n                            }\n\n                            $('#playermodal .toggle-controls').on('click', function() {\n                                $('#playermodal .modal-content').toggleClass('show-control');\n                                showcontrols = $('#playermodal .modal-content').hasClass('show-control');\n                                if (showcontrols) {\n                                    localStorage.setItem('showcontrols', '1');\n                                } else {\n                                    localStorage.removeItem('showcontrols');\n                                }\n                            });\n\n                            iframeDoc.addEventListener('annotationitemsrendered', function(e) {\n                                details = e.detail;\n                            });\n\n                            $(iframeDoc).on('mousemove', '#video-wrapper', function() {\n                                let $message = iframeDoc.querySelector('#message:not(.sticky)');\n                                let $activestart = iframeDoc.querySelector('#start-screen:not(.d-none) .hasintro');\n                                if ($message || $activestart) {\n                                    $('#playermodal .modal-header').removeClass('show');\n                                } else {\n                                    headerFunction();\n                                }\n                            });\n\n                            iframeDoc.addEventListener('videoPaused', function() {\n                                let $message = iframeDoc.querySelector('#message:not(.sticky)');\n                                let $activestart = iframeDoc.querySelector('#start-screen:not(.d-none) .hasintro');\n                                if ($message || $activestart) {\n                                    $('#playermodal .modal-header').removeClass('show');\n                                } else {\n                                    headerFunction();\n                                }\n                                $('#playermodal .toggle-controls').fadeOut(300);\n                            });\n\n                            iframeDoc.addEventListener('iv:playerPlaying', function() {\n                                $('#playermodal .toggle-controls').fadeIn(300);\n                            });\n\n                            // Analytics progress bar.\n                            let $progressbar = $card.find('.analytics.progress .progress-bar');\n                            if ($progressbar.length == 0) {\n                                return;\n                            }\n                            let current = $progressbar.data('current');\n                            iframeDoc.addEventListener('analyticsupdated', function(e) {\n                                let percentage = e.detail.percentage;\n                                if (percentage > current) {\n                                    $progressbar.css('width', percentage + '%')\n                                        .data('current', percentage);\n                                    $card.find('.analytics-percentage').text(Math.round(percentage));\n                                }\n                            });\n                        } else {\n                            requestAnimationFrame(checkIframeDoc);\n                        }\n                    };\n                    requestAnimationFrame(checkIframeDoc);\n\n                    $(document).off('click', '#playermodal [data-action=\"toggle-manual-completion\"]')\n                        .on('click', '#playermodal [data-action=\"toggle-manual-completion\"]', function() {\n                            $(this).parent().addClass('updated');\n                            if ($(this).data('withavailability') == 1) {\n                                history.pushState(null, null, M.cfg.wwwroot + '/course/view.php?id=' + course + '#module-' + id);\n                            }\n                        });\n\n                    // Update the browser url to the current activity.\n                    history.pushState(null, null, M.cfg.wwwroot + '/mod/interactivevideo/view.php?id=' + id);\n                    // Update the title of tab to the activity name.\n                    let activitytitle = $card.data('title');\n                    document.title = activitytitle;\n                });\n\n                $('#playermodal').on('hide.bs.modal', async function() {\n                    $('body').removeClass('overflow-hidden');\n                    // Trigger hover on .image-container for 2 seconds.\n                    setTimeout(function() {\n                        $card.find('.image-container').removeClass('hovered');\n                    }, 1000);\n\n                    if (player) { // Must check this in case user close modal before the player is ready.\n                        await player.pause();\n                    } else {\n                        $(this).remove();\n                        return;\n                    }\n                    // If there is automatic completion conditions, we have to update it.\n                    let $autocompletion = $card.find('.automatic-completion-conditions');\n                    if ($autocompletion.length > 0) {\n                        const completion = await $.ajax({\n                            url: M.cfg.wwwroot + '/mod/interactivevideo/ajax.php',\n                            method: 'POST',\n                            dataType: 'text',\n                            data: {\n                                action: 'get_cm_completion',\n                                cmid: id,\n                                sesskey: M.cfg.sesskey,\n                                contextid: contextid,\n                                courseid: course,\n                                userid: M.cfg.userId || 0,\n                            }\n                        });\n\n                        if (completion) {\n                            const completiondata = JSON.parse(completion);\n                            $card.find('[data-region=activity-information]')\n                                .html($(completiondata.completion).html());\n                        }\n                    }\n\n                    // If there is manual completion, we have to copy the button to the course page.\n                    let $manualcompletion = $(this).find('.completion-info.updated');\n                    if ($manualcompletion.length > 0) {\n                        $card.find('.completion-info').html($manualcompletion.html());\n                    }\n\n                    if (details) {\n                        let progressbar = $card.find('.tasks .progress-bar');\n                        if (progressbar.length > 0) {\n                            progressbar.css('width', Math.round(details.completed / details.total * 100) + '%');\n                            if (details.completed == details.total) {\n                                progressbar.addClass('bg-success').removeClass('bg-primary');\n                            } else {\n                                progressbar.removeClass('bg-success').addClass('bg-primary');\n                            }\n                            $card.find('.percentage')\n                                .text(Math.round(details.completed / details.total * 100));\n                            $card.find('.items').text(`(${details.completed}/${details.total})`);\n                            $card.find('.xp').text(details.xp);\n                        }\n                    }\n\n                    // Update the browser url to the current course.\n                    history.pushState(null, null, M.cfg.wwwroot + '/course/view.php?id=' + course);\n                    document.title = title;\n\n                    if (iframeAnnos) {\n                        // Remove the new-bagde from the poster.\n                        $card.find('.new-badge').remove();\n                    }\n\n                    $card.closest('.modtype_interactivevideo')[0]\n                        .scrollIntoView({behavior: \"smooth\", block: \"center\", inline: \"center\"});\n\n                    if (iframeDoc) {\n                       $(iframeDoc).off();\n                    }\n                });\n\n                // Close modal when the browser back button is clicked.\n                window.onpopstate = function(e) {\n                    if (e.target.location.pathname == '/course/view.php') {\n                        $('#playermodal').modal('hide');\n                    }\n                };\n            });\n\n            $(document).on('click', '.open-external-link', function() {\n                $('#playermodal').modal('hide');\n                window.open($(this).data('href'), '_blank');\n            });\n\n            $(document).on('click', '.interactivevideo-card .description-show',\n                function() {\n                    const $description = $(this).closest('.top-section').find('.description');\n                    $description.slideToggle('fast', 'swing');\n                    $(this).toggleClass('rotate');\n                });\n\n            // Get the #hash from the url and scroll to the element and hover it.\n            $(document).ready(function() {\n                let hash = window.location.hash;\n                if (hash) {\n                    let $element = $(hash);\n                    if ($element.length > 0 && $element.hasClass('modtype_interactivevideo')) {\n                        $element.addClass('highlighted');\n                        setTimeout(() => {\n                            $element[0].scrollIntoView({behavior: \"smooth\", block: \"center\", inline: \"center\"});\n                            setTimeout(function() {\n                                $element.removeClass('highlighted');\n                            }, 3000);\n                        }, 1000);\n                    }\n                }\n            });\n        },\n    };\n});"],"names":["define","$","init","document","on","e","title","showcontrols","localStorage","getItem","preventDefault","id","this","data","instance","course","contextid","$card","closest","find","addClass","modal","M","cfg","wwwroot","remove","append","headerFunction","$header","hasClass","fadeIn","setTimeout","removeClass","fadeOut","iframeDoc","iframeAnnos","details","player","$completion","clone","html","checkIframeDoc","getElementById","contentDocument","contentWindow","IVANNO","hide","IVPLAYER","toggleClass","setItem","removeItem","addEventListener","detail","$message","querySelector","$activestart","$progressbar","length","current","percentage","css","text","Math","round","requestAnimationFrame","off","parent","history","pushState","activitytitle","async","pause","completion","ajax","url","method","dataType","action","cmid","sesskey","courseid","userid","userId","completiondata","JSON","parse","$manualcompletion","progressbar","completed","total","xp","scrollIntoView","behavior","block","inline","window","onpopstate","target","location","pathname","open","slideToggle","ready","hash","$element"],"mappings":"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"}