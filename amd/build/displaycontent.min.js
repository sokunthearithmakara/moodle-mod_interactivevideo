define("mod_interactivevideo/displaycontent",["exports","jquery","core/fragment","core/event_dispatcher","core/modal_factory","core/modal_events","core/templates"],(function(_exports,_jquery,_fragment,_event_dispatcher,_modal_factory,_modal_events,_templates){Object.defineProperty(_exports,"__esModule",{value:!0}),_exports.renderContent=_exports.formatText=_exports.defaultDisplayContent=void 0,_jquery=_interopRequireDefault(_jquery),_fragment=_interopRequireDefault(_fragment),_modal_factory=_interopRequireDefault(_modal_factory),_modal_events=_interopRequireDefault(_modal_events),_templates=_interopRequireDefault(_templates);var _systemImportTransformerGlobalIdentifier="undefined"!=typeof window?window:"undefined"!=typeof self?self:"undefined"!=typeof global?global:{};function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj}}_exports.renderContent=async function(annotation){let format=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"html";const annotationArgs={...annotation,contextid:annotation.contextid};let fragment;try{fragment=await _fragment.default.loadFragment("mod_interactivevideo","getcontent",annotation.contextid,annotationArgs)}catch(error){throw new Error(JSON.stringify(error))}return"html"===format?fragment:JSON.parse(fragment)};_exports.formatText=async function(text){let shorttext=arguments.length>1&&void 0!==arguments[1]&&arguments[1];try{return await _jquery.default.ajax({url:M.cfg.wwwroot+"/mod/interactivevideo/ajax.php",type:"POST",dataType:"text",data:{text:text,contextid:M.cfg.contextid,action:"format_text",sesskey:M.cfg.sesskey,shorttext:shorttext}})}catch(error){throw new Error("Failed to format text")}};_exports.defaultDisplayContent=async function(annotation,player){let $body=(0,_jquery.default)("body");const isBS5=$body.hasClass("bs-5"),isPlayerMode="page-mod-interactivevideo-view"==$body.attr("id"),isPreviewMode=annotation.previewMode||!1,advanced=JSON.parse(annotation.advanced),isDarkMode=$body.hasClass("darkmode");new Audio(M.cfg.wwwroot+"/mod/interactivevideo/sounds/pop.mp3").play();let displayoptions=annotation.displayoptions;displayoptions=(displayoptions=>("side"==displayoptions||($body.hasClass("mobiletheme")&&"inline"==displayoptions&&(displayoptions="popup"),$body.hasClass("embed-mode")&&(displayoptions=(0,_jquery.default)(window).width()<1e3||(0,_jquery.default)(window).height()<500||"inline"==displayoptions?"inline":"popup"),(0,_jquery.default)("#wrapper").hasClass("fullscreen")&&(displayoptions="inline")),displayoptions))(displayoptions),0==advanced.advdismissible&&0==annotation.completed&&1==annotation.hascompletion&&isPlayerMode&&!isPreviewMode&&((0,_jquery.default)("#controller").addClass("completion-required"),"side"!=displayoptions&&"bottom"!=displayoptions||(0,_jquery.default)("#video-wrapper").addClass("completion-required"),"side"==displayoptions&&(0,_jquery.default)(".sidebar-nav-item").addClass("completion-required"));let completionbutton="";if(1==annotation.hascompletion&&annotation.xp>0){const earned=annotation.earned==annotation.xp?annotation.earned:annotation.earned+"/"+annotation.xp;completionbutton+='<span class="badge '.concat(annotation.completed?"alert-success":"iv-badge-secondary",' iv-mr-2">\n        ').concat(annotation.completed?earned:Number(annotation.xp)," XP</span>")}completionbutton+=await _templates.default.render("mod_interactivevideo/player/completionbutton",{id:annotation.id,iscompleted:annotation.completed,isPlayerMode:isPlayerMode&&!isPreviewMode,refreshonly:1!=annotation.hascompletion}),isPlayerMode&&!isPreviewMode||(completionbutton="");let toast,prop=JSON.parse(annotation.prop),messageTitle=await _templates.default.render("mod_interactivevideo/player/messagetitle",{icon:prop.icon||"bi bi-info-circle",title:annotation.formattedtitle||"",completionbutton:completionbutton,id:annotation.id});(0,_jquery.default)("#annotation-modal").modal("hide"),(0,_jquery.default)(document).off("click","#close-".concat(annotation.id)).on("click","#close-".concat(annotation.id),(async function(e){e.preventDefault(),(0,_jquery.default)(".tooltip").remove(),document.body.focus();const anno=window.IVANNO?window.IVANNO.find((anno=>anno.id==annotation.id)):null;if(isPlayerMode&&!isPreviewMode){if(0==advanced.advdismissible&&0==anno.completed&&1==anno.hascompletion)return toast||(toast=await("function"==typeof _systemImportTransformerGlobalIdentifier.define&&_systemImportTransformerGlobalIdentifier.define.amd?new Promise((function(resolve,reject){_systemImportTransformerGlobalIdentifier.require(["core/toast"],resolve,reject)})):"undefined"!=typeof module&&module.exports&&"undefined"!=typeof require||"undefined"!=typeof module&&module.component&&_systemImportTransformerGlobalIdentifier.require&&"component"===_systemImportTransformerGlobalIdentifier.require.loader?Promise.resolve(require("core/toast")):Promise.resolve(_systemImportTransformerGlobalIdentifier["core/toast"]))),void toast.add(M.util.get_string("dismissnotallowedbeforecompletion","mod_interactivevideo"),{type:"warning",delay:3e3});const isEnded=await player.isEnded(),currentTime=await player.getCurrentTime();(!isEnded||currentTime<annotation.end)&&(!anno||1!=anno.completed&&0==advanced.advskippable||player.play())}if("side"==displayoptions)return $body.removeClass("hassidebar"),(0,_jquery.default)("#annotation-sidebar").addClass("hide"),void(isPlayerMode&&!isPreviewMode&&((0,_jquery.default)(this).closest("#message").removeClass("active"),(0,_event_dispatcher.dispatchEvent)("interactionclose",{annotation:annotation})));(0,_jquery.default)("#annotation-modal").fadeOut(300,(function(){(0,_jquery.default)(this).trigger(_modal_events.default.hidden)}));(0,_jquery.default)(this).closest("#message").remove(),isPlayerMode&&!isPreviewMode&&setTimeout((function(){(0,_event_dispatcher.dispatchEvent)("interactionclose",{annotation:annotation})}),100)}));const handleSideDisplay=(annotation,messageTitle)=>{const rtl=$body.hasClass("dir-rtl");let $sidebar;if($body.addClass("hassidebar"),(0,_jquery.default)("#wrapper .iv-sidebar").addClass("hide"),0==(0,_jquery.default)("#wrapper #annotation-sidebar").length&&((0,_jquery.default)("#wrapper").append('<div id="annotation-sidebar" class="iv-sidebar p-0 hide">\n                <div id="sidebar-nav" class="d-flex w-100"></div>\n                <div id="sidebar-content" class="p-0"></div>\n                </div>'),$sidebar=(0,_jquery.default)("#annotation-sidebar"),$sidebar.resizable({handles:rtl?"e":"w",minWidth:475,container:"body",start:function(){rtl?((0,_jquery.default)(this).css("right","auto"),(0,_jquery.default)(this).find(".ui-resizable-handle.ui-resizable-e").css({width:"100%",right:"-50%"})):((0,_jquery.default)(this).css("left","auto"),(0,_jquery.default)(this).find(".ui-resizable-handle.ui-resizable-w").css({width:"100%",left:"-50%"})),(0,_jquery.default)(this).addClass("no-pointer-event")},resize:function(event,ui){ui.position.left<0&&(ui.position.left=0,ui.position.width="100%")},stop:function(){rtl?((0,_jquery.default)(this).css("right","auto"),(0,_jquery.default)(this).find(".ui-resizable-handle.ui-resizable-e").css({width:"7px",right:"-3px"})):((0,_jquery.default)(this).css("left","auto"),(0,_jquery.default)(this).find(".ui-resizable-handle.ui-resizable-w").css({width:"7px",left:"-3px"})),(0,_jquery.default)(this).removeClass("no-pointer-event")}}),(0,_jquery.default)(document).on("click","#sidebar-nav .sidebar-nav-item",(async function(){const current=(0,_jquery.default)("#sidebar-nav .sidebar-nav-item.active").data("id"),$sidebarcontent=(0,_jquery.default)("#sidebar-content");current&&($sidebarcontent.find("#message[data-id='".concat(current,"']")).removeClass("active"),(0,_event_dispatcher.dispatchEvent)("interactionclose",{annotation:{id:current}}));const target=(0,_jquery.default)(this).data("id");(0,_jquery.default)(this).addClass("active").siblings().removeClass("active"),$sidebarcontent.find("#message").fadeOut(300),$sidebarcontent.find("#message[data-id='".concat(target,"']")).fadeIn(300).addClass("active");await player.isPaused()&&(0,_event_dispatcher.dispatchEvent)("interactionrun",{annotation:{id:target}})}))),$sidebar=(0,_jquery.default)("#annotation-sidebar"),(isPlayerMode||isPreviewMode)&&0==(0,_jquery.default)("#wrapper #toolbar #annotation-toggle").length&&(0,_jquery.default)("#wrapper #toolbar").append('<button id="annotation-toggle" class="btn btn-sm border-0">\n                    <i class="bi bi-chevron-'.concat(rtl?"right":"left",'"></i></button>')),$sidebar.removeClass("hide"),0==(0,_jquery.default)("#sidebar-nav .sidebar-nav-item[data-id='".concat(annotation.id,"']")).length){let clss="";1==annotation.hascompletion&&1==annotation.completed&&(clss+=" completed"),1!=annotation.hascompletion&&(clss+=" no-completion"),$sidebar.find("#sidebar-nav").append('<div class="sidebar-nav-item active w-100 '.concat(clss,'"\n                 data').concat(isBS5?"-bs":"",'-toggle="tooltip"\n            data').concat(isBS5?"-bs":"",'-html="true" title="<i class=\'').concat(prop.icon," iv-mr-2'></i>").concat(annotation.formattedtitle,'"\n            data-id="').concat(annotation.id,'" data-timestamp="').concat(annotation.timestamp,'"></div>')),(0,_jquery.default)("#sidebar-nav .sidebar-nav-item[data-id='".concat(annotation.id,"']")).tooltip(),$sidebar.find("#sidebar-nav .sidebar-nav-item").sort((function(a,b){return(0,_jquery.default)(a).data("timestamp")-(0,_jquery.default)(b).data("timestamp")})).appendTo("#annotation-sidebar #sidebar-nav")}return $sidebar.find("#message").fadeOut(300),$sidebar.find('#sidebar-nav .sidebar-nav-item:not([data-id="'+annotation.id+'"])').removeClass("active"),$sidebar.find("#message.active").length>0&&(0,_event_dispatcher.dispatchEvent)("interactionclose",{annotation:{id:(0,_jquery.default)("#annotation-sidebar #message.active").data("id")}}),$sidebar.find("#message:not([data-id='".concat(annotation.id,"'])")).removeClass("active"),$sidebar.find("#sidebar-content").append('<div id="message" data-placement="side"\n                    data-id="'.concat(annotation.id,'" class="').concat(annotation.type,' sticky active" tabindex="0">\n                    <div id="title" class="modal-header shadow-sm border-bottom">').concat(messageTitle,'</div>\n                    <div class="modal-body" id="content"></div>\n                    </div>')),new Promise((resolve=>{$sidebar.find("#message.active").fadeIn(300,(function(){resolve()}))}))};switch(displayoptions){case"popup":await((annotation,messageTitle)=>((0,_jquery.default)("#annotation-modal").remove(),new Promise(((resolve,reject)=>{_modal_factory.default.create({body:'<div class="modal-body loader"></div>',large:!0,show:!1,removeOnClose:!0,isVerticallyCentered:!0}).then((modal=>{let root=modal.getRoot();root.attr({id:"annotation-modal","data-id":annotation.id}),$body.hasClass("iframe")&&root.addClass("modal-fullscreen"),root.find(".modal-dialog").attr({"data-id":annotation.id,"data-placement":"popup",id:"message"}).addClass("active "+annotation.type),root.find("#message").html('<div class="modal-content iv-rounded-lg">\n                        <div class="modal-header d-flex align-items-center shadow-sm" id="title">\n                            '.concat(messageTitle,'\n                        </div>\n                        <div class="modal-body" id="content">\n                        </div>\n                        </div>\n                    </div>')),root.off(_modal_events.default.hidden).on(_modal_events.default.hidden,(function(){root.attr("data-region","modal-container"),modal.destroy()})),root.off("click.modal").on("click.modal",(function(e){0===(0,_jquery.default)(e.target).closest(".modal-content").length&&root.addClass("jelly-anim")})),root.off(_modal_events.default.shown).on(_modal_events.default.shown,(function(){root.attr("data-region","popup"),setTimeout((()=>{root.addClass("jelly-anim")}),10),(0,_jquery.default)("#annotation-modal .modal-body").fadeIn(300),(0,_event_dispatcher.dispatchEvent)("shown.bs.modal",{annotation:{id:annotation.id}},document.querySelector("#annotation-modal")),resolve(!0)})),root.on("animationend",(function(){root.removeClass("jelly-anim")})),modal.show()})).catch(reject)}))))(annotation,messageTitle);break;case"inline":await((annotation,messageTitle)=>new Promise((resolve=>{(0,_jquery.default)("#video-wrapper").append('<div id="message" style="z-index:105;top:100%" data-placement="inline"\n         data-id="'.concat(annotation.id,'" class="').concat(annotation.type,' active modal" tabindex="0">\n        <div id="title" class="modal-header shadow-sm iv-rounded-0">\n        ').concat(messageTitle,'</div><div class="modal-body" id="content">\n        </div></div>')),(0,_jquery.default)("#message[data-id='".concat(annotation.id,"']")).animate({top:"0"},300,"linear",(function(){resolve()}))})))(annotation,messageTitle);break;case"bottom":await((annotation,messageTitle,isDarkMode)=>new Promise((resolve=>{(0,_jquery.default)("#annotation-content").html('<div id="message" class="active fade show mt-3 '.concat(isDarkMode?"":"border","\n                 iv-rounded-lg bg-white ").concat(annotation.type,'" data-placement="bottom" data-id="').concat(annotation.id,"\" tabindex=\"0\">\n                 <div id='title' class='modal-header shadow-sm px-2'>").concat(messageTitle,'</div>\n                <div class="modal-body" id="content"></div></div>')),(0,_jquery.default)("html, body, #page.drawers, .modal-body").animate({scrollTop:(0,_jquery.default)("#annotation-content").offset().top},1e3,"swing",(function(){resolve()}))})))(annotation,messageTitle,isDarkMode);break;case"side":await handleSideDisplay(annotation,messageTitle)}return!0}}));

//# sourceMappingURL=displaycontent.min.js.map