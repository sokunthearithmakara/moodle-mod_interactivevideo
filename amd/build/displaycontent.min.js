define("mod_interactivevideo/displaycontent",["exports","jquery","core/fragment","core/event_dispatcher"],(function(_exports,_jquery,_fragment,_event_dispatcher){Object.defineProperty(_exports,"__esModule",{value:!0}),_exports.renderContent=_exports.formatText=_exports.defaultDisplayContent=void 0,_jquery=_interopRequireDefault(_jquery),_fragment=_interopRequireDefault(_fragment);var _systemImportTransformerGlobalIdentifier="undefined"!=typeof window?window:"undefined"!=typeof self?self:"undefined"!=typeof global?global:{};function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj}}_exports.renderContent=async function(annotation){let format=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"html";const annotationArgs={...annotation,contextid:annotation.contextid};let fragment;try{fragment=await _fragment.default.loadFragment("mod_interactivevideo","getcontent",annotation.contextid,annotationArgs)}catch(error){throw new Error(JSON.stringify(error))}return"html"===format?fragment:JSON.parse(fragment)};_exports.formatText=async function(text){let shorttext=arguments.length>1&&void 0!==arguments[1]&&arguments[1];try{return await _jquery.default.ajax({url:M.cfg.wwwroot+"/mod/interactivevideo/ajax.php",type:"POST",dataType:"text",data:{text:text,contextid:M.cfg.contextid,action:"format_text",sesskey:M.cfg.sesskey,shorttext:shorttext}})}catch(error){throw new Error("Failed to format text")}};_exports.defaultDisplayContent=async function(annotation,player){const isPlayerMode="page-mod-interactivevideo-view"==(0,_jquery.default)("body").attr("id"),isPreviewMode=annotation.previewMode,advanced=JSON.parse(annotation.advanced),isDarkMode=(0,_jquery.default)("body").hasClass("darkmode");new Audio(M.cfg.wwwroot+"/mod/interactivevideo/sounds/pop.mp3").play();let displayoptions=annotation.displayoptions;displayoptions=(displayoptions=>("side"==displayoptions||((0,_jquery.default)("body").hasClass("mobiletheme")&&"inline"==displayoptions&&(displayoptions="popup"),(0,_jquery.default)("body").hasClass("embed-mode")&&(displayoptions=(0,_jquery.default)(window).width()<1e3||(0,_jquery.default)(window).height()<500||"inline"==displayoptions?"inline":"popup"),(0,_jquery.default)("#wrapper").hasClass("fullscreen")&&(displayoptions="inline")),displayoptions))(displayoptions),0==advanced.advdismissible&&0==annotation.completed&&1==annotation.hascompletion&&isPlayerMode&&!isPreviewMode&&((0,_jquery.default)("#controller").addClass("completion-required"),"side"!=displayoptions&&"bottom"!=displayoptions||(0,_jquery.default)("#video-wrapper").addClass("completion-required"),"side"==displayoptions&&(0,_jquery.default)(".sidebar-nav-item").addClass("completion-required"));let completionbutton="";if(1==annotation.hascompletion&&annotation.xp>0){const earned=annotation.earned==annotation.xp?annotation.earned:annotation.earned+"/"+annotation.xp;completionbutton+='<span class="badge '.concat(annotation.completed?"alert-success":"badge-secondary",' mr-2">\n        ').concat(annotation.completed?earned:Number(annotation.xp)," XP</span>")}1==annotation.hascompletion&&annotation.completed?completionbutton+='<button id="completiontoggle" class="btn btn-flex text-truncate mark-undone btn-success\n         btn-sm border-0"\n             data-id="'.concat(annotation.id,'"><i class="bi bi-check2"></i>\n             <span class="ml-2 d-none d-sm-block">\n             ').concat(M.util.get_string("completionmarkincomplete","mod_interactivevideo"),"</span></button>"):1==annotation.hascompletion&&0==annotation.completed&&(completionbutton+='<button id="completiontoggle" class="btn btn-flex text-truncate mark-done btn-secondary btn-sm\n         border-0"\n             data-id="'.concat(annotation.id,'"><i class="bi bi-circle"></i>\n             <span class="ml-2 d-none d-sm-block">\n             ').concat(M.util.get_string("completionmarkcomplete","mod_interactivevideo"),"</span></button>")),isPlayerMode&&!isPreviewMode?completionbutton+='<button class="btn btn-flex btn-secondary btn-sm ml-2 rotatez-360 border-0"\n         data-id="'.concat(annotation.id,'" id="refresh">\n        <i class="bi bi-arrow-repeat"></i></button>'):completionbutton="";let toast,prop=JSON.parse(annotation.prop),messageTitle='<h5 class="modal-title text-truncate mb-0">\n    <i class="'.concat(prop.icon,' mr-2 d-none d-md-inline"></i><span>').concat(annotation.formattedtitle,'</span></h5>\n                            <div class="btns d-flex align-items-center">\n                            ').concat(completionbutton,'\n                            <button data-id="').concat(annotation.id,'"\n                             class="btn btn-flex mx-2 p-0 border-0 interaction-dismiss" id="close-').concat(annotation.id,'"\n                             aria-label="Close">\n                            <i class="bi bi-x-lg fa-fw fs-25px"></i>\n                            </button>\n                            </div>');(0,_jquery.default)("#annotation-modal").modal("hide"),(0,_jquery.default)(document).off("click","#close-".concat(annotation.id)).on("click","#close-".concat(annotation.id),(async function(e){e.preventDefault();const anno=window.IVANNO?window.IVANNO.find((anno=>anno.id==annotation.id)):null;if(isPlayerMode&&!isPreviewMode){if(0==advanced.advdismissible&&0==anno.completed&&1==anno.hascompletion)return toast||(toast=await("function"==typeof _systemImportTransformerGlobalIdentifier.define&&_systemImportTransformerGlobalIdentifier.define.amd?new Promise((function(resolve,reject){_systemImportTransformerGlobalIdentifier.require(["core/toast"],resolve,reject)})):"undefined"!=typeof module&&module.exports&&"undefined"!=typeof require||"undefined"!=typeof module&&module.component&&_systemImportTransformerGlobalIdentifier.require&&"component"===_systemImportTransformerGlobalIdentifier.require.loader?Promise.resolve(require("core/toast")):Promise.resolve(_systemImportTransformerGlobalIdentifier["core/toast"]))),void toast.add(M.util.get_string("dismissnotallowedbeforecompletion","mod_interactivevideo"),{type:"warning",delay:3e3});const isEnded=await player.isEnded(),currentTime=await player.getCurrentTime();(!isEnded||currentTime<annotation.end)&&(!anno||1!=anno.completed&&0==advanced.advskippable||player.play())}if("side"==displayoptions)return(0,_jquery.default)("body").removeClass("hassidebar"),(0,_jquery.default)("#annotation-sidebar").addClass("hide"),void(isPlayerMode&&!isPreviewMode&&((0,_jquery.default)(this).closest("#message").removeClass("active"),(0,_event_dispatcher.dispatchEvent)("interactionclose",{annotation:annotation})));(0,_jquery.default)(this).closest("#annotation-modal").modal("hide");const targetMessage=(0,_jquery.default)(this).closest("#message");targetMessage.removeClass("active"),targetMessage.addClass("bottom-0"),targetMessage.remove(),isPlayerMode&&!isPreviewMode&&setTimeout((function(){(0,_event_dispatcher.dispatchEvent)("interactionclose",{annotation:annotation})}),100)}));const handleSideDisplay=(annotation,messageTitle)=>{if((0,_jquery.default)("body").addClass("hassidebar"),(0,_jquery.default)("#wrapper .iv-sidebar").addClass("hide"),0==(0,_jquery.default)("#wrapper #annotation-sidebar").length&&((0,_jquery.default)("#wrapper").append('<div id="annotation-sidebar" class="iv-sidebar p-0 hide">\n                <div id="sidebar-nav" class="d-flex w-100"></div>\n                <div id="sidebar-content" class="p-0"></div>\n                </div>'),(0,_jquery.default)("#annotation-sidebar").resizable({handles:"w",minWidth:475,container:"body",start:function(){(0,_jquery.default)(this).css("left","auto"),(0,_jquery.default)(this).find(".ui-resizable-handle.ui-resizable-w").css({width:"100%",left:"-50%"}),(0,_jquery.default)(this).addClass("no-pointer-event")},resize:function(event,ui){ui.position.left<0&&(ui.position.left=0,ui.position.width="100%")},stop:function(){(0,_jquery.default)(this).css("left","auto"),(0,_jquery.default)(this).find(".ui-resizable-handle.ui-resizable-w").css({width:"7px",left:"-3px"}),(0,_jquery.default)(this).removeClass("no-pointer-event")}}),(0,_jquery.default)(document).on("click","#sidebar-nav .sidebar-nav-item",(async function(){const current=(0,_jquery.default)("#sidebar-nav .sidebar-nav-item.active").data("id");current&&((0,_jquery.default)("#sidebar-content #message[data-id='".concat(current,"']")).removeClass("active"),(0,_event_dispatcher.dispatchEvent)("interactionclose",{annotation:{id:current}}));const target=(0,_jquery.default)(this).data("id");(0,_jquery.default)(this).addClass("active").siblings().removeClass("active"),(0,_jquery.default)("#sidebar-content #message").fadeOut(300),(0,_jquery.default)("#sidebar-content #message[data-id='".concat(target,"']")).fadeIn(300).addClass("active");await player.isPaused()&&(0,_event_dispatcher.dispatchEvent)("interactionrun",{annotation:{id:target}})}))),(isPlayerMode||isPreviewMode)&&0==(0,_jquery.default)("#wrapper #toolbar #annotation-toggle").length&&(0,_jquery.default)("#wrapper #toolbar").append('<button id="annotation-toggle" class="btn btn-sm border-0">\n                    <i class="bi bi-chevron-left"></i></button>'),(0,_jquery.default)("#annotation-sidebar").removeClass("hide"),0==(0,_jquery.default)("#sidebar-nav .sidebar-nav-item[data-id='".concat(annotation.id,"']")).length){let clss="";1==annotation.hascompletion&&1==annotation.completed&&(clss+=" completed"),1!=annotation.hascompletion&&(clss+=" no-completion"),(0,_jquery.default)("#annotation-sidebar #sidebar-nav").append('<div class="sidebar-nav-item active w-100 '.concat(clss,'" data-toggle="tooltip"\n            data-html="true" title="<i class=\'').concat(prop.icon," mr-2'></i>").concat(annotation.formattedtitle,'"\n            data-id="').concat(annotation.id,'" data-timestamp="').concat(annotation.timestamp,'"></div>')),(0,_jquery.default)("#annotation-sidebar #sidebar-nav .sidebar-nav-item").sort((function(a,b){return(0,_jquery.default)(a).data("timestamp")-(0,_jquery.default)(b).data("timestamp")})).appendTo("#annotation-sidebar #sidebar-nav")}(0,_jquery.default)("#annotation-sidebar #message").fadeOut(300),(0,_jquery.default)('#annotation-sidebar #sidebar-nav .sidebar-nav-item:not([data-id="'+annotation.id+'"])').removeClass("active"),(0,_jquery.default)("#annotation-sidebar #message.active").length>0&&(0,_event_dispatcher.dispatchEvent)("interactionclose",{annotation:{id:(0,_jquery.default)("#annotation-sidebar #message.active").data("id")}}),(0,_jquery.default)("#annotation-sidebar #message:not([data-id='".concat(annotation.id,"'])")).removeClass("active"),(0,_jquery.default)("#annotation-sidebar #sidebar-content").append('<div id="message" data-placement="side"\n                    data-id="'.concat(annotation.id,'" class="').concat(annotation.type,' sticky active">\n                    <div id="title" class="modal-header shadow-sm pr-0">').concat(messageTitle,'</div>\n                    <div class="modal-body" id="content"></div>\n                    </div>'))};switch(displayoptions){case"popup":((annotation,messageTitle)=>{let modal='<div class="modal fade '.concat((0,_jquery.default)("body").hasClass("iframe")?"modal-fullscreen":"",'"\n             id="annotation-modal" role="dialog" aria-labelledby="annotation-modal"\n         aria-hidden="true" data-backdrop="static" data-keyboard="false">\n         <div id="message" data-id="').concat(annotation.id,'" data-placement="popup"\n          class="modal-dialog modal-xl modal-dialog-centered modal-dialog-scrollable ').concat(annotation.type,' active" role="document">\n                <div class="modal-content rounded-lg">\n                    <div class="modal-header d-flex align-items-center shadow-sm pr-0" id="title">\n                        ').concat(messageTitle,'\n                    </div>\n                    <div class="modal-body" id="content"></div>\n                    </div>\n                </div>\n        </div>');(0,_jquery.default)("#wrapper").append(modal),(0,_jquery.default)("#annotation-modal").modal("show"),(0,_jquery.default)("#annotation-modal").on("hide.bs.modal",(function(){(0,_jquery.default)("#annotation-modal").remove()})),(0,_jquery.default)("#annotation-modal").on("shown.bs.modal",(function(){return(0,_jquery.default)("#annotation-modal .modal-body").fadeIn(300),Promise.resolve()}))})(annotation,messageTitle);break;case"inline":((annotation,messageTitle)=>{(0,_jquery.default)("#video-wrapper").append('<div id="message" style="z-index:105;top:100%" data-placement="inline"\n         data-id="'.concat(annotation.id,'" class="').concat(annotation.type,' active">\n        <div id="title" class="modal-header shadow-sm pr-0 rounded-0">').concat(messageTitle,'</div><div class="modal-body" id="content">\n        </div></div>')),(0,_jquery.default)("#message[data-id='".concat(annotation.id,"']")).animate({top:"0"},300,"linear",(function(){return Promise.resolve()}))})(annotation,messageTitle);break;case"bottom":((annotation,messageTitle,isDarkMode)=>{(0,_jquery.default)("#annotation-content").empty(),(0,_jquery.default)("#annotation-content").append('<div id="message" class="active fade show mt-3 '.concat(isDarkMode?"":"border","\n                 rounded-lg bg-white ").concat(annotation.type,'" data-placement="bottom" data-id="').concat(annotation.id,"\">\n                 <div id='title' class='modal-header shadow-sm pr-0'>").concat(messageTitle,'</div>\n                <div class="modal-body" id="content"></div></div>')),(0,_jquery.default)("html, body, #page.drawers, .modal-body").animate({scrollTop:(0,_jquery.default)("#annotation-content").offset().top},1e3,"swing",(function(){return Promise.resolve()}))})(annotation,messageTitle,isDarkMode);break;case"side":handleSideDisplay(annotation,messageTitle)}}}));

//# sourceMappingURL=displaycontent.min.js.map