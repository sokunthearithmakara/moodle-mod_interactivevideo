define("mod_interactivevideo/editannotation",["exports","jquery","core/toast","core/notification","core/event_dispatcher","./quickform","core/modal_events","./libraries/jquery-ui"],(function(_exports,_jquery,_toast,_notification,_event_dispatcher,_quickform,_modal_events,_jqueryUi){Object.defineProperty(_exports,"__esModule",{value:!0}),_exports.default=void 0,_jquery=_interopRequireDefault(_jquery),_notification=_interopRequireDefault(_notification),_quickform=_interopRequireDefault(_quickform),_modal_events=_interopRequireDefault(_modal_events);var _systemImportTransformerGlobalIdentifier="undefined"!=typeof window?window:"undefined"!=typeof self?self:"undefined"!=typeof global?global:{};function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj}}let ModalFactory,player,totaltime,currentTime,ctRenderer={},playerReady=!1;const isRTL="rtl"==(0,_jquery.default)("html").attr("dir"),isBS5=(0,_jquery.default)("body").hasClass("bs-5"),bsAffix=isBS5?"-bs":"";let $loader=(0,_jquery.default)("#background-loading"),$progressbar=(0,_jquery.default)("#video-nav #progress"),$scrollbar=(0,_jquery.default)("#scrollbar"),$scrollhead=(0,_jquery.default)("#scrollhead-top"),$videonav=(0,_jquery.default)("#video-nav");const replaceProgressBars=percentage=>{percentage=(percentage=percentage<0?0:percentage)>100?100:percentage,$progressbar.css("width",percentage+"%"),$scrollbar.css("left",percentage+"%"),$scrollhead.css("left",percentage+"%")},renderVideoNav=async function(annos,start,totaltime){if(0==annos.length)return void $videonav.find("ul").empty();$videonav.find("ul").empty(),(0,_jquery.default)("#video-timeline-wrapper .skipsegment").remove(),annos.forEach((async x=>{const render=ctRenderer[x.type];await render.renderItemOnVideoNavigation(x)}));const time=await player.getCurrentTime();replaceProgressBars((time-start)/totaltime*100),(0,_event_dispatcher.dispatchEvent)("annotationitemsrendered",{annotations:annos})};var _default={init:async function(url,coursemodule,interaction,course,start,end,coursecontextid){let type=arguments.length>7&&void 0!==arguments[7]?arguments[7]:"yt",displayoptions=arguments.length>8?arguments[8]:void 0,userid=arguments.length>9?arguments[9]:void 0,posterimage=arguments.length>10?arguments[10]:void 0,extendedcompletion=arguments.length>11?arguments[11]:void 0;if(!ModalFactory)try{ModalFactory=await("function"==typeof _systemImportTransformerGlobalIdentifier.define&&_systemImportTransformerGlobalIdentifier.define.amd?new Promise((function(resolve,reject){_systemImportTransformerGlobalIdentifier.require(["core/modal_factory"],resolve,reject)})):"undefined"!=typeof module&&module.exports&&"undefined"!=typeof require||"undefined"!=typeof module&&module.component&&_systemImportTransformerGlobalIdentifier.require&&"component"===_systemImportTransformerGlobalIdentifier.require.loader?Promise.resolve(require("core/modal_factory")):Promise.resolve(_systemImportTransformerGlobalIdentifier["core/modal_factory"]))}catch(error){ModalFactory=await("function"==typeof _systemImportTransformerGlobalIdentifier.define&&_systemImportTransformerGlobalIdentifier.define.amd?new Promise((function(resolve,reject){_systemImportTransformerGlobalIdentifier.require(["core/modal"],resolve,reject)})):"undefined"!=typeof module&&module.exports&&"undefined"!=typeof require||"undefined"!=typeof module&&module.component&&_systemImportTransformerGlobalIdentifier.require&&"component"===_systemImportTransformerGlobalIdentifier.require.loader?Promise.resolve(require("core/modal")):Promise.resolve(_systemImportTransformerGlobalIdentifier["core/modal"]))}displayoptions=(0,_jquery.default)("#doptions").length>0?JSON.parse((0,_jquery.default)("#doptions").text()):displayoptions;let $videonav=(0,_jquery.default)("#video-nav"),$videotimeline=(0,_jquery.default)("#video-timeline"),$annotationlist=(0,_jquery.default)("#annotation-list"),$annotationcanvas=(0,_jquery.default)("#annotation-canvas"),$timelinewrapper=(0,_jquery.default)("#timeline-wrapper"),$videowrapper=(0,_jquery.default)("#video-wrapper"),$playpause=(0,_jquery.default)("#playpause"),$timelineitemswrapper=(0,_jquery.default)("#timeline-items-wrapper"),$addcontent=(0,_jquery.default)("#addcontent");(0,_quickform.default)(),require(["theme_boost/bootstrap/modal"]),require(["theme_boost/bootstrap/tooltip"]);const addNotification=function(msg){let type=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"info";(0,_toast.add)(msg,{type:type})};start=Number(start),isNaN(start)&&(start=0),end=Number(end),isNaN(end)&&(end=null);let contentTypes,annotations=[];const convertSecondsToHMS=function(s){let dynamic=arguments.length>1&&void 0!==arguments[1]&&arguments[1],rounded=!(arguments.length>2&&void 0!==arguments[2])||arguments[2];rounded&&(s=Math.round(s));let hours=Math.floor(s/3600),minutes=Math.floor((s-3600*hours)/60),seconds=s-3600*hours-60*minutes;return rounded&&seconds>59.5&&(seconds=0,minutes++,minutes>59&&(minutes=0,hours++)),minutes<10&&(minutes="0"+minutes),seconds=rounded?Math.round(seconds):parseFloat(seconds).toFixed(2),seconds<10&&(seconds="0"+seconds),dynamic&&0==hours?minutes+":"+seconds:(hours<10?"0"+hours:hours)+":"+minutes+":"+seconds};let activeid=null;const renderAnnotationItems=annotations=>{if((0,_jquery.default)("#annotationwrapper .loader").remove(),$annotationlist.empty().removeClass("d-flex align-items-center justify-content-center"),player.live)return $timelinewrapper.addClass("no-pointer-events"),void $annotationlist.html("".concat(M.util.get_string("interactionsnotsupportedonlivevideo","mod_interactivevideo"))).addClass("d-flex align-items-center justify-content-center");if(renderVideoNav(annotations,start,totaltime),0==annotations.length)return void $annotationlist.html("".concat(M.util.get_string("clickaddtoaddinteraction","mod_interactivevideo"))).addClass("d-flex align-items-center justify-content-center");annotations.sort((function(a,b){return Number(a.timestamp)===Number(b.timestamp)?String(a.type).localeCompare(String(b.type)):Number(a.timestamp)-Number(b.timestamp)})),annotations.forEach((function(item){let listItem=(0,_jquery.default)("#annotation-template").clone();ctRenderer[item.type].renderEditItem(annotations,listItem,item)}));let xp=annotations.filter((x=>x.xp)).map((x=>Number(x.xp))).reduce(((a,b)=>a+b),0);if((0,_jquery.default)("#xp span").text(xp),activeid){const activeAnno=annotations.find((x=>x.id==activeid));activeAnno&&ctRenderer[activeAnno.type].postEditCallback(activeAnno)}},getAnnotations=()=>{const getItems=_jquery.default.ajax({url:M.cfg.wwwroot+"/mod/interactivevideo/ajax.php",method:"POST",dataType:"text",data:{action:"get_items",sesskey:M.cfg.sesskey,id:interaction,contextid:M.cfg.contextid,coursecontextid:M.cfg.courseContextId}}),getContentTypes=_jquery.default.ajax({url:M.cfg.wwwroot+"/mod/interactivevideo/ajax.php",method:"POST",dataType:"text",data:{action:"get_all_contenttypes",sesskey:M.cfg.sesskey,contextid:M.cfg.contextid,coursecontextid:M.cfg.courseContextId}});_jquery.default.when(getItems,getContentTypes).done((async function(items,contenttypes){annotations=JSON.parse(items[0]),player.live&&(annotations=[]),contentTypes=JSON.parse(contenttypes[0]),annotations=annotations.filter((x=>contentTypes.find((y=>y.name===x.type))));const getRenderers=new Promise((resolve=>{let count=0;contentTypes.forEach((x=>{require([""+x.amdmodule],(function(Type){ctRenderer[x.name]=new Type(player,annotations,interaction,course,0,0,0,0,type,0,totaltime,start,end,x,coursemodule,null,displayoptions,null,extendedcompletion,{isEditMode:!0}),count++,ctRenderer[x.name].init(),count==contentTypes.length&&resolve(ctRenderer)}))}))}));annotations.map((x=>{let prop=contentTypes.find((y=>y.name===x.type));return delete prop.author,delete prop.authorlink,delete prop.description,x.prop=JSON.stringify(prop),x.editMode=!0,x})),ctRenderer=await getRenderers,renderAnnotationItems(annotations)}))},validateTimestampFormat=(timestamp,fld,existing)=>!!/^([0-9]{2}):([0-5][0-9]):([0-5][0-9])(\.\d{2})?$/.test(timestamp)||(addNotification(M.util.get_string("invalidtimestampformat","mod_interactivevideo"),"danger"),existing?(0,_jquery.default)(fld).val(existing):(0,_jquery.default)(fld).val(convertSecondsToHMS(start,!1,!1)),!1),validateTimeStartEnd=(timestamp,fld,existing,seconds,checkduration,checkexisting,checkskipsegment)=>{const parts=timestamp.split(":");if(timestamp=3600*Number(parts[0])+60*Number(parts[1])+Number(parts[2]),checkduration&&(timestamp>end||timestamp<start)){const message=M.util.get_string("timemustbebetweenstartandendtime","mod_interactivevideo",{start:convertSecondsToHMS(start,!0,!1),end:convertSecondsToHMS(end,!0,!1)});return addNotification(message,"danger"),existing?(0,_jquery.default)(fld).val(existing):(0,_jquery.default)(fld).val(convertSecondsToHMS(start,!1,!1)),-1}if(checkexisting&&annotations.find((x=>x.timestamp==timestamp))&&timestamp!=seconds)return addNotification(M.util.get_string("interactionalreadyexists","mod_interactivevideo"),"danger"),existing?(0,_jquery.default)(fld).val(existing):(0,_jquery.default)(fld).val(convertSecondsToHMS(start,!1,!1)),-1;if(checkskipsegment){const skip=annotations.filter((annotation=>"skipsegment"==annotation.type)).find((x=>Number(x.timestamp)<Number(timestamp)&&Number(x.title)>Number(timestamp)));if(skip)return addNotification(M.util.get_string("interactionisbetweentheskipsegment","mod_interactivevideo",{start:convertSecondsToHMS(skip.timestamp,!0,!1),end:convertSecondsToHMS(skip.title,!0,!1)}),"danger"),existing?(0,_jquery.default)(fld).val(existing):(0,_jquery.default)(fld).val(convertSecondsToHMS(start,!1,!1)),-1}return timestamp},runInteraction=annotation=>{(0,_jquery.default)("#annotation-modal").modal("hide"),(0,_jquery.default)("#message").not("[data-placement=bottom]").not(".sticky").remove(),(0,_jquery.default)("#end-screen").remove(),player.pause();ctRenderer[annotation.type].runInteraction(annotation)},updateTime=async duration=>{duration=Number(duration);let toUpdatetime=!1;return end&&0!=end||(toUpdatetime=!0),(!start||start>=duration||start<0||start>=duration)&&(toUpdatetime=!0),start=start>duration?0:start,toUpdatetime&&await _jquery.default.ajax({url:M.cfg.wwwroot+"/mod/interactivevideo/ajax.php",method:"POST",dataType:"text",data:{action:"update_videotime",sesskey:M.cfg.sesskey,cmid:coursemodule,courseid:course,id:interaction,start:start,end:end&&0!=end?end:duration,contextid:M.cfg.contextid}}),{start:start,end:end=!end||0==end||end>duration?duration:end}},onReady=async()=>{player.live&&(end=Number.MAX_SAFE_INTEGER),"yt"!=player.type&&player.pause();if(!await player.isPaused())return player.live||await player.seek(start),player.pause(),void onReady();player.unMute(),player.audio&&$annotationcanvas.addClass("bg-black"),1==displayoptions.passwordprotected&&((0,_jquery.default)("#start-screen").removeClass("d-none"),(0,_jquery.default)("#video-block").removeClass("no-pointer bg-transparent")),"vimeo"!=player.type&&"html5video"!=player.type&&"panopto"!=player.type&&"peertube"!=player.type&&"dyntube"!=player.type&&"rutube"!=player.type&&(0,_jquery.default)("#video-block").addClass("no-pointer"),0==player.support.playbackrate?(0,_jquery.default)("#changerate").remove():(0,_jquery.default)("#changerate").removeClass("d-none"),0==player.support.quality?(0,_jquery.default)("#changequality").remove():(0,_jquery.default)("#changequality").removeClass("d-none");let t=player.totaltime;({start:start,end:end}=await updateTime(t)),totaltime=end-start;let ratio=16/9;displayoptions.usefixedratio&&0!=displayoptions.usefixedratio||(ratio=player.aspectratio),$videowrapper.css("padding-bottom",1/ratio*100+"%"),playerReady=!0,$annotationcanvas.removeClass("d-none w-0"),$videotimeline.css({"background-image":"url("+posterimage+")","background-size":"contain","background-repeat":"no-repeat"}),$timelinewrapper.find("#duration").text(convertSecondsToHMS(end,!0)),$timelinewrapper.find("#currenttime").text(convertSecondsToHMS(start,!0));const minutes=Math.floor(totaltime/60);$timelineitemswrapper.css("width",300*minutes+"px");const relWidth=(0,_jquery.default)("#timeline-items").width();(0,_jquery.default)("#minute-markers, #minute-markers-bg, #vseek").css("width",relWidth+"px");let startPercentage=0,newStart=start;start%60!=0&&(startPercentage=(60-start%60)/totaltime*100,newStart=start+(60-start%60),(0,_jquery.default)("#minute-markers, #minute-markers-bg").append('<div class="minute-marker position-absolute"\n                        style="left: 0%;"><div class="text-white minute-label"></div></div>'));for(let i=newStart;i<=end;i+=60){let percentage=(i-newStart)/totaltime*100+startPercentage,marker="";marker=i>=3600?Math.floor(i/3600)+"h"+Math.floor(i%3600/60)+"m":Math.floor(i/60)+"m",(0,_jquery.default)("#minute-markers").append('<div class="minute-marker position-absolute"\n                         style="left: '.concat(percentage,'%;"><div class="text-white minute-label">').concat(marker,"</div></div>")),(0,_jquery.default)("#minute-markers-bg").append('<div class="minute-marker position-absolute"\n                            style="left: '.concat(percentage,'%;"></div>'))}end%60!=0&&(0,_jquery.default)("#minute-markers, #minute-markers-bg").append('<div class="minute-marker position-absolute"\n                        style="left: 100%;"><div class="text-white minute-label"></div></div>');try{player.setCaption("")}catch(e){}$scrollbar.css("left",0),$scrollhead.css("left",0),getAnnotations()},onEnded=()=>{player.pause(),$playpause.find("i").removeClass("bi-pause-fill").addClass("bi-play-fill").toggleClass("rotate-360"),$videowrapper.append('<div id="end-screen" class="border position-absolute w-100 h-100 bg-white d-flex\n                     justify-content-center align-items-center" style="top: 0; left: 0;">\n                     <button class="btn btn-danger border-0 iv-rounded-circle" style="font-size: 1.5rem;" id="restart">\n                    <i class="bi bi-arrow-repeat" style="font-size: x-large;"></i></button></div>'),$progressbar.css("width","100%"),$scrollbar.css("left","100%"),$scrollhead.css("left","100%"),(0,_jquery.default)("#message #restart").focus();const currentAnnotation=annotations.find((annotation=>annotation.timestamp==end));currentAnnotation&&($annotationlist.find("tr").removeClass("active"),$annotationlist.find('tr[data-id="'+currentAnnotation.id+'"]').addClass("active"),$videonav.find('.annotation[data-id="'+currentAnnotation.id+'"] .item').tooltip("show"),setTimeout((function(){$videonav.find('.annotation[data-id="'+currentAnnotation.id+'"] .item').tooltip("hide")}),2e3))},onSeek=async function(t){if(!playerReady)return;(t=t?Number(t):await player.getCurrentTime())>start&&t<end&&(0,_jquery.default)("#end-screen").remove();const percentage=(t-start)/totaltime*100;$scrollbar.css("left",percentage+"%"),$scrollhead.css("left",percentage+"%"),$timelinewrapper.find("#currenttime").text(convertSecondsToHMS(t,!0)),(0,_event_dispatcher.dispatchEvent)("timeupdate",{time:t})};let onPlayingInterval,visualized=!1;const onPlaying=async()=>{if(player.live)return;const intervalFunction=async function(){let thisTime=await player.getCurrentTime();const isPlaying=await player.isPlaying(),isEnded=await player.isEnded();if(!isPlaying)return void cancelAnimationFrame(onPlayingInterval);if(thisTime<start&&(await player.seek(start),thisTime=start),thisTime>=end||isEnded)return player.stop(end),cancelAnimationFrame(onPlayingInterval),void onEnded();(0,_event_dispatcher.dispatchEvent)("timeupdate",{time:thisTime});let percentage=(thisTime-start)/totaltime*100;const scrollBar=document.getElementById("scrollbar"),rect=scrollBar.getBoundingClientRect();(rect.left<0||rect.right>window.innerWidth)&&scrollBar.scrollIntoView({behavior:"instant",block:"center",inline:"center"});const currentAnnotation=annotations.find((x=>thisTime-player.frequency<=x.timestamp&&thisTime+player.frequency>=x.timestamp));currentAnnotation&&($annotationlist.find('tr:not([data-id="'.concat(currentAnnotation.id,'"])')).removeClass("active"),$annotationlist.find('tr[data-id="'.concat(currentAnnotation.id,'"]')).hasClass("active")||($annotationlist.find('tr[data-id="'.concat(currentAnnotation.id,'"]')).addClass("active").trigger("mouseenter"),setTimeout((function(){$annotationlist.find('tr[data-id="'.concat(currentAnnotation.id,'"]')).trigger("mouseleave")}),2e3)));let skip=annotations.filter((annotation=>"skipsegment"==annotation.type)).find((x=>Number(x.timestamp)<Number(thisTime)&&Number(x.title)>Number(thisTime)));skip&&(await player.seek(Number(skip.title)),percentage=(skip.title-start)/totaltime*100,replaceProgressBars(percentage))};if(player.useAnimationFrame){const animate=async()=>{await player.isPlaying()&&(intervalFunction(),onPlayingInterval=requestAnimationFrame(animate))};onPlayingInterval=requestAnimationFrame(animate)}else{await player.isPlaying()&&intervalFunction()}},onplay=async()=>{(0,_jquery.default)("#message, #end-screen").not(".sticky").remove(),$playpause.find("i").removeClass("bi-play-fill").addClass("bi-pause-fill").removeClass("rotate-360"),player.audio&&!visualized&&(player.visualizer(),visualized=!0)},onPause=()=>{cancelAnimationFrame(onPlayingInterval),$playpause.find("i").removeClass("bi-pause-fill").addClass("bi-play-fill").toggleClass("rotate-360")};require(["mod_interactivevideo/player/"+type],(function(VideoPlayer){1==displayoptions.passwordprotected&&((0,_jquery.default)("#video-block").addClass("no-pointer bg-transparent"),$annotationcanvas.removeClass("d-none w-0")),player=new VideoPlayer,player.load(url,start,end,{customStart:!0,passwordprotected:1==displayoptions.passwordprotected,showControls:!1,keyboard:!0}),window.IVPLAYER=player})),(0,_jquery.default)(document).one("iv:playerReady",(function(){onReady()})),(0,_jquery.default)(document).on("iv:playerPaused",(function(){onPause()})),(0,_jquery.default)(document).on("iv:playerPlaying",(function(){onPlaying()})),(0,_jquery.default)(document).on("iv:playerPlay",(function(){onplay()})),(0,_jquery.default)(document).on("iv:playerEnded",(function(){onEnded()})),(0,_jquery.default)(document).on("iv:playerSeek",(function(e){onSeek(e.detail.time)})),(0,_jquery.default)(document).on("iv:playerError",(function(){$annotationcanvas.removeClass("d-none w-0"),(0,_jquery.default)("#start-screen").addClass("d-none"),(0,_jquery.default)("#video-block").addClass("no-pointer bg-transparent"),(0,_jquery.default)("#spinner").remove(),(0,_jquery.default)(".loader").removeClass("loader"),(0,_jquery.default)("#player").is(":empty")?(0,_jquery.default)("#player").html('<div class="alert alert-danger d-flex text-center h-100 rounded-0\n                         align-items-center justify-content-center">\n                        <img src="'.concat(M.cfg.wwwroot,'/mod/interactivevideo/pix/404-error.png" alt="Error" class="w-25">\n                        </div>')):addNotification(M.util.get_string("thereisanissueloadingvideo","mod_interactivevideo"),"danger")})),(0,_jquery.default)(document).on("timeupdate",(function(e){if(!playerReady)return void player.pause();const thisTime=e.detail.time;$timelinewrapper.find("#currenttime").text(convertSecondsToHMS(thisTime,!0)),replaceProgressBars((thisTime-start)/totaltime*100)})),(0,_jquery.default)(document).on("annotationupdated",(function(e){(0,_jquery.default)(".tooltip").remove(),_jquery.default.ajax({url:M.cfg.wwwroot+"/mod/interactivevideo/ajax.php",method:"POST",dataType:"text",data:{action:"update_ivitems_cache",sesskey:M.cfg.sesskey,contextid:M.cfg.contextid,cmid:interaction}}),(0,_jquery.default)("#annotation-list-bulk-edit").hasClass("active")&&(0,_jquery.default)("#annotation-list-bulk-edit").trigger("click");const action=e.originalEvent.detail.action;if("import"==action)return annotations=e.originalEvent.detail.annotations,renderAnnotationItems(annotations),void addNotification(M.util.get_string("interactionimported","mod_interactivevideo"),"success");let updated=e.originalEvent.detail.annotation;"edit"!=action&&"draft"!=action&&"savedraft"!=action||(annotations=annotations.filter((function(item){return item.id!=updated.id}))),updated.prop=JSON.stringify(contentTypes.find((x=>x.name===updated.type))),annotations.push(updated),activeid="add"==action?updated.id:null,annotations.map((x=>(x.editMode=!0,x))),renderAnnotationItems(annotations),"add"==action||"clone"==action?(addNotification(M.util.get_string("interactionadded","mod_interactivevideo"),"success"),$annotationlist.find('tr[data-id="'.concat(updated.id,'"]')).addClass("active")):"edit"==action&&(addNotification(M.util.get_string("interactionupdated","mod_interactivevideo"),"success"),$annotationlist.find('tr[data-id="'.concat(updated.id,'"]')).addClass("active"),setTimeout((function(){$annotationlist.find('tr[data-id="'.concat(updated.id,'"]')).removeClass("active")}),1500)),annotations.find((x=>"draft"==x.status))?$timelinewrapper.find("#savedraft").removeAttr("disabled").addClass("pulse"):$timelinewrapper.find("#savedraft").attr("disabled","disabled").removeClass("pulse")})),(0,_jquery.default)(document).on("annotationdeleted",(function(e){(0,_jquery.default)(".tooltip").remove();const annotation=e.originalEvent.detail.annotation;activeid=null,$annotationlist.find('tr[data-id="'.concat(annotation.id,'"]')).addClass("deleted"),setTimeout((function(){annotations=annotations.filter((function(item){return item.id!=annotation.id})),renderAnnotationItems(annotations),addNotification(M.util.get_string("interactiondeleted","mod_interactivevideo"),"success")}),1e3),(0,_jquery.default)((0,_jquery.default)("#annotation-list-bulk-edit")).hasClass("active")&&(0,_jquery.default)("#annotation-list-bulk-edit").trigger("click")})),(0,_jquery.default)(document).on("click","#addcontentdropdown .dropdown-item",(async function(e){if(!playerReady)return;if((0,_jquery.default)("#addcontentdropdown .dropdown-item").removeClass("active"),(0,_jquery.default)(e.target).is("a"))return;const ctype=(0,_jquery.default)(this).data("type");player.pause();let timestamp=currentTime||await player.getCurrentTime();timestamp=Number(timestamp.toFixed(2));const contenttype=contentTypes.find((x=>x.name==ctype));if(contenttype.hastimestamp){if(annotations.find((x=>x.timestamp==timestamp)))return void addNotification(M.util.get_string("interactionalreadyexists","mod_interactivevideo"),"danger");if(annotations.filter((x=>"skipsegment"==x.type)).find((x=>Number(x.timestamp)<Number(currentTime)&&Number(x.title)>Number(currentTime))))return void addNotification(M.util.get_string("interactionisbetweentheskipsegment","mod_interactivevideo"),"danger")}contenttype.allowmultiple||!annotations.find((x=>x.type==ctype))?(currentTime=null,ctRenderer[ctype].addAnnotation(annotations,contenttype.hastimestamp?timestamp:-1,coursemodule)):addNotification(M.util.get_string("thisinteractionalreadyexists","mod_interactivevideo",contenttype.title),"danger")})),(0,_jquery.default)(document).on("click","tr.annotation .edit",(async function(e){e.preventDefault();const timestamp=(0,_jquery.default)(this).closest(".annotation").data("timestamp"),id=(0,_jquery.default)(this).closest(".annotation").data("id"),contenttype=(0,_jquery.default)(this).closest(".annotation").data("type");ctRenderer[contenttype].editAnnotation(annotations,id,coursemodule);const t=await player.getCurrentTime();timestamp&&t!=timestamp&&await player.seek(timestamp,!0);await player.isPlaying()&&player.pause()})),(0,_jquery.default)(document).on("click","tr.annotation .copy",(async function(e){e.preventDefault();const id=(0,_jquery.default)(this).closest(".annotation").data("id"),contenttype=(0,_jquery.default)(this).closest(".annotation").data("type"),time=await player.getCurrentTime();ctRenderer[contenttype].cloneAnnotation(id,time)})),(0,_jquery.default)(document).on("click","tr.annotation .delete",(async function(e){e.preventDefault();await player.isPaused()||player.pause();const id=(0,_jquery.default)(this).closest(".annotation").data("id"),annotation=annotations.find((annotation=>annotation.id==id));try{_notification.default.deleteCancelPromise(M.util.get_string("deleteinteraction","mod_interactivevideo"),M.util.get_string("deleteinteractionconfirm","mod_interactivevideo"),M.util.get_string("delete","mod_interactivevideo")).then((()=>ctRenderer[annotation.type].deleteAnnotation(annotations,id))).catch((()=>{}))}catch{_notification.default.saveCancel(M.util.get_string("deleteinteraction","mod_interactivevideo"),M.util.get_string("deleteinteractionconfirm","mod_interactivevideo"),M.util.get_string("delete","mod_interactivevideo"),(function(){return ctRenderer[annotation.type].deleteAnnotation(annotations,id)}))}})),(0,_jquery.default)(document).on("click","tr.annotation .title",(async function(e){e.preventDefault();const timestamp=(0,_jquery.default)(this).closest(".annotation").data("timestamp");replaceProgressBars((timestamp-start)/totaltime*100),await player.getCurrentTime()!=timestamp&&await player.seek(timestamp,!0),player.pause();const id=(0,_jquery.default)(this).closest(".annotation").data("id"),theAnnotation=annotations.find((annotation=>annotation.id==id));setTimeout((()=>{runInteraction(theAnnotation)}),500)})),(0,_jquery.default)(document).on("click","tr.annotation .timestamp",(async function(e){e.preventDefault();const timestamp=(0,_jquery.default)(this).data("timestamp");await player.seek(timestamp),player.play()})),(0,_jquery.default)(document).on("contextmenu","#vseek, #video-timeline",(async function(e){if(!playerReady)return;e.preventDefault(),e.stopImmediatePropagation();const percentage=e.offsetX/(0,_jquery.default)(this).width();replaceProgressBars(100*percentage),currentTime=percentage*totaltime+start,await player.getCurrentTime()!=currentTime&&await player.seek(currentTime),player.pause(),$addcontent.trigger("click")})),(0,_jquery.default)(document).on("contextmenu","#scrollbar, #scrollhead-top",(async function(e){playerReady&&(e.preventDefault(),e.stopImmediatePropagation(),currentTime=await player.getCurrentTime(),$addcontent.trigger("click"))})),(0,_jquery.default)(document).on("click","#playpause",(async function(e){if(!playerReady)return;if(e.preventDefault(),await player.isPlaying())player.pause();else{await player.getCurrentTime()>=end?(0,_jquery.default)("#end-screen #restart").trigger("click"):player.play()}})),(0,_jquery.default)(document).on("click","#video-block",(function(e){playerReady&&(e.preventDefault(),$playpause.trigger("click"))})),(0,_jquery.default)(document).on("contextmenu","#video-nav .annotation",(function(e){e.preventDefault(),e.stopImmediatePropagation();const id=(0,_jquery.default)(this).data("id");$annotationlist.find('tr.annotation[data-id="'.concat(id,'"] .edit')).trigger("click")})),(0,_jquery.default)(document).on("contextmenu","[data-editable]",(function(e){if(e.preventDefault(),e.stopImmediatePropagation(),(0,_jquery.default)("[data-field].editing").length>0)return;const fld=(0,_jquery.default)(this).data("editable");(0,_jquery.default)(this).hide(),(0,_jquery.default)(this).siblings('[data-field="'+fld+'"]').removeClass("d-none").focus().addClass("editing"),"timestamp"==fld&&(0,_jquery.default)(this).closest("tr").append('<div class="timestamp-info position-absolute">\n                        '.concat(M.util.get_string("rightclicktosetcurrenttime","mod_interactivevideo"),"</div>"))})),(0,_jquery.default)(document).on("contextmenu",'[data-field="timestamp"]',(async function(e){e.preventDefault(),e.stopImmediatePropagation();const time=await player.getCurrentTime();(0,_jquery.default)(this).val(convertSecondsToHMS(time,!1,!1))})),(0,_jquery.default)(document).on("keyup","[data-field].editing",(function(e){(0,_jquery.default)(this).removeClass("is-invalid");const initialValue=(0,_jquery.default)(this).data("initial-value"),val=(0,_jquery.default)(this).val(),fld=(0,_jquery.default)(this).data("field");if(""==val&&(0,_jquery.default)(this).addClass("is-invalid"),"Escape"==e.key)return(0,_jquery.default)(this).val(initialValue),(0,_jquery.default)(this).removeClass("editing"),(0,_jquery.default)(this).addClass("d-none"),(0,_jquery.default)(this).siblings("[data-editable]").show(),void(0,_jquery.default)(".timestamp-info").remove();if("Enter"!=e.key);else{let seconds;if("timestamp"==fld){const parts=initialValue.split(":");if(seconds=3600*Number(parts[0])+60*Number(parts[1])+Number(parts[2]),!validateTimestampFormat(val,"[data-field].editing",initialValue))return void(0,_jquery.default)(this).addClass("is-invalid");const timestamp=validateTimeStartEnd(val,"[data-field].editing",initialValue,seconds,!0,!0,!0);if(-1==timestamp)return void(0,_jquery.default)(this).addClass("is-invalid");seconds=timestamp}if((0,_jquery.default)(this).hasClass("is-invalid"))return;if(val==initialValue)return(0,_jquery.default)(this).removeClass("editing"),(0,_jquery.default)(this).addClass("d-none"),void(0,_jquery.default)(this).siblings("[data-editable]").show();const id=(0,_jquery.default)(this).data("id");_jquery.default.ajax({url:M.cfg.wwwroot+"/mod/interactivevideo/ajax.php",method:"POST",dataType:"text",data:{action:"quick_edit_field",sesskey:M.cfg.sesskey,id:id,field:fld,contextid:M.cfg.contextid,value:"timestamp"==fld?seconds:val},success:function(data){(0,_jquery.default)(".timestamp-info").remove();const updated=JSON.parse(data);(0,_event_dispatcher.dispatchEvent)("annotationupdated",{annotation:updated,action:"edit"})}})}})),(0,_jquery.default)(document).on("blur","[data-field].editing",(function(){const initialValue=(0,_jquery.default)(this).data("initial-value");(0,_jquery.default)(this).val(initialValue),(0,_jquery.default)(this).removeClass("editing"),(0,_jquery.default)(this).addClass("d-none"),(0,_jquery.default)(this).siblings("[data-editable]").show(),(0,_jquery.default)(".timestamp-info").remove()})),(0,_jquery.default)(document).on("click","#end-screen #restart",(async function(e){e.preventDefault(),(0,_jquery.default)("#end-screen").remove(),await player.seek(start),player.play()})),(0,_jquery.default)(document).on("mouseenter","tr.annotation",(function(){const id=(0,_jquery.default)(this).data("id");$videonav.find('ul li[data-id="'.concat(id,'"] .item')).tooltip("show")})),(0,_jquery.default)(document).on("mouseleave","tr.annotation",(function(){const id=(0,_jquery.default)(this).data("id");$videonav.find('ul li[data-id="'.concat(id,'"] .item')).tooltip("hide"),isBS5||(0,_jquery.default)(".tooltip").remove()})),(0,_jquery.default)(document).on("mouseover","#video-nav ul li",(function(){const id=(0,_jquery.default)(this).data("id");$annotationlist.find('tr.annotation[data-id="'.concat(id,'"]')).addClass("active")})),(0,_jquery.default)(document).on("mouseout","#video-nav ul li",(function(){const id=(0,_jquery.default)(this).data("id");$annotationlist.find('tr.annotation[data-id="'.concat(id,'"]')).removeClass("active")})),(0,_jquery.default)(document).on("change",".timestamp-input, .timestamp-field input",(function(){(0,_jquery.default)(this).removeClass("is-invalid");const parts=(0,_jquery.default)(this).val().split(":"),seconds=3600*Number(parts[0])+60*Number(parts[1])+Number(parts[2]);if(!validateTimestampFormat((0,_jquery.default)(this).val(),this))return void(0,_jquery.default)(this).addClass("is-invalid");-1!=validateTimeStartEnd((0,_jquery.default)(this).val(),this,"00:00:00",seconds,!0,!1,!0)||(0,_jquery.default)(this).addClass("is-invalid")}));let $vseekbar=(0,_jquery.default)("#vseek #bar");const appendTimestampMarker=(seconds,rounded)=>{const formattedTime=convertSecondsToHMS(seconds,!0,rounded);$vseekbar.append('<div id="position-marker">\n                    <div id="position" class="py-0 px-1" style="top:-25px;">'.concat(formattedTime,"</div></div>"))};(0,_jquery.default)(document).on("annotationitemsrendered",(function(){$timelinewrapper.find("[data".concat(bsAffix,'-toggle="tooltip"]')).tooltip({boundary:"window",container:"#timeline"});let targetAnnotation=null;try{(0,_jquery.default)("#timeline-items .annotation, #video-timeline-wrapper .skipsegment").draggable("destroy"),(0,_jquery.default)("#timeline-items .annotation, #video-timeline-wrapper .skipsegment").resizable("destroy")}catch(e){}(0,_jquery.default)("#timeline-items .annotation.li-draggable").draggable({axis:"x",start:async function(){await player.isPaused()||player.pause(),appendTimestampMarker((0,_jquery.default)(this).data("timestamp")),(0,_jquery.default)(".tooltip, #message").remove(),(0,_jquery.default)("#timeline-items").addClass("no-pointer-events")},drag:async function(event,ui){(0,_jquery.default)(".tooltip").remove();let timestamp=(ui.position.left+5)/(0,_jquery.default)("#timeline-items").width()*totaltime+start;timestamp<start&&(timestamp=start,ui.position.left=-5),timestamp>end&&(timestamp=end,ui.position.left=(0,_jquery.default)("#timeline-items").width()-5);let percentage=(timestamp-start)/totaltime*100;percentage<0&&(percentage=0),(0,_jquery.default)("#scrollbar, #position-marker, #scrollhead-top").css("left",percentage+"%"),(0,_jquery.default)(this).css("left",percentage+"%"),await player.seek(timestamp),(0,_jquery.default)("#vseek #position").text(convertSecondsToHMS(timestamp,!0,!1))},stop:async function(event,ui){(0,_jquery.default)(".tooltip").remove(),(0,_jquery.default)("#vseek #position-marker").remove(),setTimeout((function(){(0,_jquery.default)("#timeline-items").removeClass("no-pointer-events")}),200);let timestamp=(ui.position.left+5)/(0,_jquery.default)("#timeline-items").width()*totaltime+start;timestamp<start&&(timestamp=start,(0,_jquery.default)(this).css("left","-5px")),timestamp>end&&(timestamp=end,(0,_jquery.default)(this).css("left","calc(100% - 5px)"));let percentage=(timestamp-start)/totaltime*100;percentage<0&&(percentage=0),(0,_jquery.default)("#scrollbar, #position-marker, #scrollhead-top").css("left",percentage+"%");const id=(0,_jquery.default)(this).data("id");targetAnnotation=annotations.find((x=>x.id==id));if(annotations.find((x=>x.timestamp==timestamp&&x.id!=id)))return addNotification(M.util.get_string("interactionalreadyexists","mod_interactivevideo"),"danger"),void renderAnnotationItems(annotations);targetAnnotation.timestamp!=timestamp&&(targetAnnotation.timestamp=timestamp,targetAnnotation.status="draft",(0,_event_dispatcher.dispatchEvent)("annotationupdated",{annotation:targetAnnotation,action:"draft"}),(0,_jquery.default)("#scrollbar, #position-marker, #scrollhead-top").css("left",percentage+"%"))}}),(0,_jquery.default)("#video-timeline-wrapper .skipsegment").draggable({axis:"x",start:async function(){await player.isPaused()||player.pause(),(0,_jquery.default)("#message").remove(),appendTimestampMarker((0,_jquery.default)(this).data("timestamp")),(0,_jquery.default)("#timeline-items").addClass("no-pointer-events")},drag:async function(event,ui){const id=(0,_jquery.default)(this).data("id");targetAnnotation=annotations.find((x=>x.id==id));let timestamp=ui.position.left/(0,_jquery.default)("#video-timeline").width()*totaltime+start;timestamp<start&&(timestamp=start),timestamp>end&&(timestamp=end);let percentage=(timestamp-start)/totaltime*100;percentage<0&&(percentage=0),(0,_jquery.default)("#scrollbar, #position-marker, #scrollhead-top").css("left",percentage+"%"),await player.seek(timestamp),(0,_jquery.default)("#vseek #position").text(convertSecondsToHMS(timestamp,!0,!1))},stop:async function(event,ui){(0,_jquery.default)("#vseek #position-marker").remove(),setTimeout((function(){(0,_jquery.default)("#timeline-items").removeClass("no-pointer-events")}),200);let timestamp=ui.position.left/(0,_jquery.default)("#video-timeline").width()*totaltime+start;const id=(0,_jquery.default)(this).data("id");targetAnnotation=annotations.find((x=>x.id==id));let skipduration=Number(targetAnnotation.title)-Number(targetAnnotation.timestamp);if(timestamp<0&&timestamp+skipduration<start)return void renderAnnotationItems(annotations);if(timestamp>end)return void renderAnnotationItems(annotations);if(timestamp<start&&(skipduration-=Math.abs(start-timestamp),timestamp=start),timestamp+skipduration>end&&(skipduration=Math.abs(end-timestamp),timestamp=end-skipduration),skipduration<=0)return void renderAnnotationItems(annotations);if(annotations.find((x=>x.timestamp==timestamp&&x.id!=id)))return addNotification(M.util.get_string("interactionalreadyexists","mod_interactivevideo"),"danger"),void renderAnnotationItems(annotations);if(targetAnnotation.timestamp==timestamp)return void renderAnnotationItems(annotations);targetAnnotation.timestamp=timestamp,targetAnnotation.title=timestamp+skipduration,targetAnnotation.title>end&&(targetAnnotation.title=end),targetAnnotation.status="draft",(0,_event_dispatcher.dispatchEvent)("annotationupdated",{annotation:targetAnnotation,action:"draft"});let percentage=(timestamp-start)/totaltime*100;percentage<0&&(percentage=0),(0,_jquery.default)("#scrollbar, #position-marker, #scrollhead-top").css("left",percentage+"%")}}),(0,_jquery.default)("#video-timeline-wrapper .skipsegment").resizable({containment:"#video-timeline-wrapper",handles:"e, w",start:async function(){await player.isPaused()||player.pause(),(0,_jquery.default)("#message").remove(),appendTimestampMarker((0,_jquery.default)(this).data("timestamp")),(0,_jquery.default)("#timeline-items").addClass("no-pointer-events")},resize:async function(event,ui){let timestamp;ui.originalPosition.left!=ui.position.left||ui.originalSize.width==ui.size.width?(ui.position.left<0&&(ui.position.left=0),timestamp=ui.position.left/(0,_jquery.default)("#video-timeline").width()*totaltime+start):timestamp=(ui.position.left+ui.size.width)/(0,_jquery.default)("#video-timeline").width()*totaltime+start;let percentage=(timestamp-start)/totaltime*100;(isNaN(percentage)||percentage<0)&&(percentage=0),percentage>100&&(percentage=100),(0,_jquery.default)("#scrollbar, #position-marker, #scrollhead-top").css("left",percentage+"%"),await player.seek(timestamp),(0,_jquery.default)("#vseek #position").text(convertSecondsToHMS(timestamp,!0,!1))},stop:async function(event,ui){(0,_jquery.default)("#vseek #position-marker").remove(),setTimeout((function(){(0,_jquery.default)("#timeline-items").removeClass("no-pointer-events")}),200);const id=(0,_jquery.default)(this).data("id");let timestamp,direction;targetAnnotation=annotations.find((x=>x.id==id)),ui.originalPosition.left!=ui.position.left?(ui.position.left<0&&(ui.position.left=0),timestamp=ui.position.left/(0,_jquery.default)("#video-timeline").width()*totaltime+start,direction="left"):(timestamp=(ui.position.left+ui.size.width)/(0,_jquery.default)("#video-timeline").width()*totaltime+start,direction="right");if(annotations.find((x=>x.timestamp==timestamp&&x.id!=id)))return addNotification(M.util.get_string("interactionalreadyexists","mod_interactivevideo"),"danger"),void renderAnnotationItems(annotations);if(targetAnnotation.timestamp==timestamp)return;"left"==direction?targetAnnotation.timestamp=timestamp:(targetAnnotation.title=timestamp,targetAnnotation.title>end&&(targetAnnotation.title=end)),targetAnnotation.status="draft",(0,_event_dispatcher.dispatchEvent)("annotationupdated",{annotation:targetAnnotation,action:"draft"});let percentage=(timestamp-start)/totaltime*100;(isNaN(percentage)||percentage<0)&&(percentage=0),percentage>100&&(percentage=100),(0,_jquery.default)("#scrollbar, #position-marker, #scrollhead-top").css("left",percentage+"%")}}),(0,_jquery.default)("#video-timeline-wrapper .skipsegment").off("contextmenu").on("contextmenu",(function(e){e.preventDefault(),e.stopImmediatePropagation();const id=(0,_jquery.default)(this).data("id");(0,_jquery.default)('tr.annotation[data-id="'.concat(id,'"] .edit')).trigger("click")})),(0,_jquery.default)("#video-timeline-wrapper .skipsegment").off("click").on("click",(async function(e){e.preventDefault();const timestamp=(0,_jquery.default)(this).data("timestamp");await player.seek(timestamp);await player.isPaused()||player.pause()})),(0,_jquery.default)("#video-timeline-wrapper .skipsegment .delete-skipsegment").off("click").on("click",(function(e){e.preventDefault();const id=(0,_jquery.default)(this).closest(".skipsegment").data("id");(0,_jquery.default)('tr.annotation[data-id="'.concat(id,'"] .delete')).trigger("click")}))})),(0,_jquery.default)("#scrollbar").draggable({containment:"#timeline-items",axis:"x",cursor:"col-resize",start:async function(event,ui){await player.isPaused()||player.pause(),(0,_jquery.default)("#timeline-items").addClass("no-pointer-events"),(0,_jquery.default)("#message").remove(),appendTimestampMarker(ui.position.left/(0,_jquery.default)("#timeline-items").width()*totaltime+start,!1)},drag:async function(event,ui){let timestamp=ui.position.left/(0,_jquery.default)("#timeline-items").width()*totaltime+start,percentage=(timestamp-start)/totaltime*100;(0,_jquery.default)("#vseek #position").text(convertSecondsToHMS(timestamp,!0,!1)),(0,_jquery.default)("#vseek #position-marker, #scrollhead-top, #scrollbar").css("left",percentage+"%"),await player.seek(timestamp)},stop:async function(event,ui){(0,_jquery.default)("#vseek #position-marker").remove(),setTimeout((function(){(0,_jquery.default)("#timeline-items").removeClass("no-pointer-events")}),200);let percentage=(ui.position.left/(0,_jquery.default)("#timeline-items").width()*totaltime+start-start)/totaltime*100;(isNaN(percentage)||percentage<0)&&(percentage=0),percentage>100&&(percentage=100),(0,_jquery.default)("#scrollbar, #scrollhead-top").css("left",percentage+"%");await player.isPaused()||player.pause()}}),(0,_jquery.default)("#scrollhead-top").draggable({axis:"x",cursor:"col-resize",start:async function(event,ui){await player.isPaused()||player.pause(),(0,_jquery.default)("#vseek").addClass("no-pointer-events"),(0,_jquery.default)("#message").remove(),appendTimestampMarker(ui.position.left/(0,_jquery.default)("#vseek").width()*totaltime+start,!1)},drag:async function(event,ui){let timestamp=ui.position.left/(0,_jquery.default)("#vseek").width()*totaltime+start,percentage=(timestamp-start)/totaltime*100;(isNaN(percentage)||percentage<0)&&(percentage=0),percentage>100&&(percentage=100),timestamp<start&&(timestamp=start),(0,_jquery.default)("#vseek #position").text(convertSecondsToHMS(timestamp,!0,!1)),(0,_jquery.default)("#vseek #position-marker, #scrollhead-top, #scrollbar").css("left",percentage+"%"),await player.seek(timestamp)},stop:async function(event,ui){(0,_jquery.default)("#vseek #position-marker").remove(),setTimeout((function(){(0,_jquery.default)("#vseek").removeClass("no-pointer-events")}),200);let timestamp=ui.position.left/(0,_jquery.default)("#vseek").width()*totaltime+start;timestamp<start&&(timestamp=start);let percentage=(timestamp-start)/totaltime*100;if((isNaN(percentage)||percentage<0)&&(percentage=0),percentage>100&&(percentage=100),(0,_jquery.default)("#scrollbar, #scrollhead-top").css("left",percentage+"%"),await player.getCurrentTime()===timestamp)return;await player.isPaused()||player.pause()}}),(0,_jquery.default)("#timeline-wrapper").resizable({handles:"n",minHeight:125,maxHeight:500,start:function(){(0,_jquery.default)("#top-region, #timeline-wrapper").addClass("no-pointer-events")},resize:function(event,ui){(0,_jquery.default)("#top-region").css("height","calc(100dvh - ".concat(ui.size.height+70,"px)"))},stop:function(){(0,_jquery.default)("#top-region, #timeline-wrapper").removeClass("no-pointer-events"),localStorage.setItem("timeline-height",(0,_jquery.default)("#timeline-wrapper").height())}}),(0,_jquery.default)("#separator").draggable({axis:"x",containment:"#wrapper",grid:[1,0],start:function(){(0,_jquery.default)("#wrapper").addClass("no-pointer-events")},drag:function(){const width=(0,_jquery.default)(this).offset().left;isRTL?((0,_jquery.default)("#player-region").css("width","calc(100% - "+width+"px)"),(0,_jquery.default)("#content-region").css("width",width+"px")):((0,_jquery.default)("#player-region").css("width",width+"px"),(0,_jquery.default)("#content-region").css("width","calc(100% - "+width+"px)"))},stop:function(){const width=(0,_jquery.default)(this).offset().left;localStorage.setItem("player-width",width),(0,_jquery.default)("#wrapper").removeClass("no-pointer-events")}});const playerWidth=localStorage.getItem("player-width");playerWidth>0&&window.innerWidth>992?((0,_jquery.default)("#separator").css("left",playerWidth+"px"),isRTL?((0,_jquery.default)("#player-region").css("width","calc(100% - "+playerWidth+"px)"),(0,_jquery.default)("#content-region").css("width",playerWidth+"px")):((0,_jquery.default)("#player-region").css("width",playerWidth+"px"),(0,_jquery.default)("#content-region").css("width","calc(100% - "+playerWidth+"px)"))):((0,_jquery.default)("#separator").css("left","50%"),(0,_jquery.default)("#player-region").css("width","50%"),(0,_jquery.default)("#content-region").css("width","50%"));const timelineHeight=localStorage.getItem("timeline-height");let contentTypeModal;timelineHeight&&((0,_jquery.default)("#timeline-wrapper").css("height",timelineHeight+"px"),(0,_jquery.default)("#top-region").css("height","calc(100dvh - ".concat(Number(timelineHeight)+70,"px)"))),(0,_jquery.default)("#vseek #bar, #video-timeline").on("mouseenter",(function(e){(0,_jquery.default)("#cursorbar, #position-marker").remove(),e.preventDefault(),e.stopImmediatePropagation();let $scrollbar=(0,_jquery.default)("#scrollbar").clone();$scrollbar.attr("id","cursorbar"),$scrollbar.addClass("no-pointer-events");const parentOffset=(0,_jquery.default)(this).offset(),relX=e.pageX-parentOffset.left;$scrollbar.css("left",relX+5+"px"),$scrollbar.find("#scrollhead").remove();const percentage=relX/(0,_jquery.default)(this).width(),formattedTime=convertSecondsToHMS(percentage*totaltime+start,!0,!1);(0,_jquery.default)("#vseek #bar").append('<div id="position-marker">\n                    <div id="position" class="py-0 px-1" style="top:-25px;">'.concat(formattedTime,"</div></div>")),(0,_jquery.default)("#vseek #position-marker").css("left",relX+"px"),(0,_jquery.default)("#timeline-items").append($scrollbar)})),(0,_jquery.default)("#vseek #bar, #video-timeline").on("mouseleave",(function(e){e.stopImmediatePropagation(),(0,_jquery.default)("#vseek #position-marker, #cursorbar").remove(),(0,_jquery.default)("tr.annotation.active").removeClass("active")})),(0,_jquery.default)("#vseek #bar, #video-timeline").on("mousemove",(function(e){e.stopImmediatePropagation();const parentOffset=(0,_jquery.default)(this).offset(),relX=e.pageX-parentOffset.left;let time=relX/(0,_jquery.default)(this).width()*totaltime+start;time<start&&(time=start);const formattedTime=convertSecondsToHMS(time,!0,!1);(0,_jquery.default)("#cursorbar").css("left",relX+5+"px"),(0,_jquery.default)("#vseek #position").text(formattedTime),(0,_jquery.default)("#vseek #position-marker").css("left",relX+"px")})),(0,_jquery.default)(document).on("click","#video-nav .annotation",(async function(e){e.preventDefault(),e.stopImmediatePropagation();const id=(0,_jquery.default)(this).data("id"),annotation=annotations.find((x=>x.id==id));$loader.fadeIn(300),await player.getCurrentTime()!=annotation.timestamp&&await player.seek(annotation.timestamp),$loader.fadeOut(300),runInteraction(annotation)})),(0,_jquery.default)(document).on("click","#vseek #bar, #video-timeline",(async function(e){e.preventDefault(),e.stopImmediatePropagation();const percentage=e.offsetX/(0,_jquery.default)(this).width(),time=percentage*totaltime+start;if(await player.getCurrentTime()===time)return;replaceProgressBars(100*percentage),$loader.fadeIn(300);await player.isPaused()||player.pause(),await player.seek(time),$loader.fadeOut(300),(0,_jquery.default)("#message, #end-screen").remove()})),(0,_jquery.default)("#zoomout").on("click",(function(){const currentLevel=$timelineitemswrapper.css("width"),newLevel=parseInt(currentLevel)-300;$timelineitemswrapper.css("width",newLevel+"px");const relWidth=(0,_jquery.default)("#timeline-items").width();(0,_jquery.default)("#minute-markers, #minute-markers-bg, #vseek").css("width",relWidth+"px");let timelineElement=document.getElementById("timeline");timelineElement.scrollWidth<=timelineElement.clientWidth&&(0,_jquery.default)(this).attr("disabled","disabled"),(0,_event_dispatcher.dispatchEvent)("annotationitemsrendered",{annotations:annotations})})),(0,_jquery.default)("#zoomin").on("click",(function(){const currentLevel=$timelineitemswrapper.css("width"),newLevel=parseInt(currentLevel)+300;$timelineitemswrapper.css("width",newLevel+"px");const relWidth=(0,_jquery.default)("#timeline-items").width();(0,_jquery.default)("#minute-markers, #minute-markers-bg, #vseek").css("width",relWidth+"px"),(0,_jquery.default)("#zoomout").removeAttr("disabled"),(0,_event_dispatcher.dispatchEvent)("annotationitemsrendered",{annotations:annotations})})),(0,_jquery.default)("#timeline").on("wheel",(function(e){(e.ctrlKey||e.metaKey)&&(e.preventDefault(),e.originalEvent.deltaY<0?(0,_jquery.default)("#zoomin").trigger("click"):(0,_jquery.default)("#zoomout").trigger("click"))})),document.getElementById("timeline").addEventListener("scroll",(function(){document.getElementById("minute-markers-wrapper").scrollLeft=this.scrollLeft,document.getElementById("vseek").style.left=-this.scrollLeft+"px",document.getElementById("minute-markers-bg-wrapper").style.left=-this.scrollLeft+"px",document.getElementById("scrollbar").scrollHeight=this.scrollHeight})),(0,_jquery.default)("#savedraft").on("click",(function(e){e.stopImmediatePropagation();let draftAnnotations=annotations.filter((x=>"draft"==x.status)),count=0;draftAnnotations.forEach((function(a){_jquery.default.ajax({url:M.cfg.wwwroot+"/mod/interactivevideo/ajax.php",method:"POST",dataType:"text",data:{action:"quick_edit_field",sesskey:M.cfg.sesskey,id:a.id,field:"timestamp",contextid:M.cfg.contextid,value:a.timestamp},success:function(data){const updated=JSON.parse(data);(0,_event_dispatcher.dispatchEvent)("annotationupdated",{annotation:updated,action:"savedraft"})}}),"skipsegment"==a.type&&_jquery.default.ajax({url:M.cfg.wwwroot+"/mod/interactivevideo/ajax.php",method:"POST",dataType:"text",data:{action:"quick_edit_field",sesskey:M.cfg.sesskey,id:a.id,field:"title",contextid:M.cfg.contextid,value:a.title},success:function(data){const updated=JSON.parse(data);(0,_event_dispatcher.dispatchEvent)("annotationupdated",{annotation:updated,action:"savedraft"})}}),count++,count==draftAnnotations.length&&addNotification(M.util.get_string("draftsaved","mod_interactivevideo"),"success")}))})),$addcontent.on("click",(async function(e){if(e.preventDefault(),!playerReady)return;if(contentTypeModal)return void contentTypeModal.show();contentTypeModal=await ModalFactory.create({title:"",body:"",backdrop:"static",removeOnHide:!1});let root=contentTypeModal.getRoot(),$body=(0,_jquery.default)("#contentmodal-original .modal-content").html();root.attr("id","contentmodal"),root.find(".modal-dialog .modal-content").html($body),contentTypeModal.show(),root.on(_modal_events.default.hidden,(function(){(0,_jquery.default)("#addcontentdropdown .dropdown-item").removeClass("active")})),root.on(_modal_events.default.shown,(function(){player.pause(),setTimeout((()=>{root.addClass("jelly-anim")}),10),root.find(".modal-dialog").draggable({handle:".modal-header"})})),root.on("click",'.modal-header [type="button"]',(function(){contentTypeModal.hide()})),root.on("click",".dropdown-item",(function(){root.removeClass("jelly-anim"),contentTypeModal.hide()}))})),window.addEventListener("beforeunload",(e=>{if(annotations.find((x=>"draft"==x.status))){const confirmationMessage=M.util.get_string("unsavedchanges","mod_interactivevideo");return e.returnValue=confirmationMessage,confirmationMessage}return!0})),(0,_jquery.default)(document).on("click",".changerate",(function(e){e.preventDefault();const rate=(0,_jquery.default)(this).data("rate");player.setRate(rate),(0,_jquery.default)(".changerate").find("i").removeClass("bi-check"),(0,_jquery.default)(this).find("i").addClass("bi-check")})),(0,_jquery.default)(document).on("iv:playerRateChange",(function(e){(0,_jquery.default)(".changerate").find("i").removeClass("bi-check"),(0,_jquery.default)('.changerate[data-rate="'.concat(e.originalEvent.detail.rate,'"]')).find("i").addClass("bi-check")})),(0,_jquery.default)("#changequality").on("shown.bs.dropdown",(async function(){let quality=await player.getQualities();(0,_jquery.default)("#qualitieslist").empty();let currentQuality=quality.currentQuality;null===currentQuality&&(currentQuality=(0,_jquery.default)(this).data("current"));let qualities=quality.qualities,qualitiesLabel=quality.qualitiesLabel;qualities.forEach(((q,i)=>{(0,_jquery.default)("#qualitieslist").append('<a class="dropdown-item changequality px-3" data-quality="'.concat(q,'"\n                         href="#"><i class="bi ').concat(q==currentQuality?"bi-check":"",' fa-fw"></i>').concat(qualitiesLabel[i],"</a>"))})),(0,_jquery.default)(this).find("[data".concat(bsAffix,"-toggle=dropdown]")).dropdown("update")})),(0,_jquery.default)(document).on("click",".changequality",(function(e){e.preventDefault();const quality=(0,_jquery.default)(this).data("quality");player.setQuality(quality),(0,_jquery.default)(".changequality").find("i").removeClass("bi-check"),(0,_jquery.default)(this).find("i").addClass("bi-check")}));let resizeTimeout,timelineWrapper=document.getElementById("timeline-wrapper"),resizeObserver=new ResizeObserver((()=>{clearTimeout(resizeTimeout),resizeTimeout=setTimeout((()=>{const relWidth=(0,_jquery.default)("#timeline-items").width();(0,_jquery.default)("#minute-markers, #minute-markers-bg, #vseek").css("width",relWidth+"px")}),100)}));resizeObserver.observe(timelineWrapper),(0,_jquery.default)(document).on("click","#importcontent",(async function(e){e.preventDefault();const importmodal=await ModalFactory.create({body:"",title:M.util.get_string("importcontent","mod_interactivevideo"),footer:'<button type="button" class="btn btn-secondary border-0" data'.concat(bsAffix,'-dismiss="modal">\n                        ').concat(M.util.get_string("cancel","mod_interactivevideo"),'</button>\n                        <button type="button" class="btn btn-primary border-0" id="importcontentbutton">\n                        ').concat(M.util.get_string("import","mod_interactivevideo"),"</button>"),show:!1,large:!0,removeOnClose:!0,isVerticallyCentered:!0});let root=importmodal.getRoot();root.attr("id","importmodal"),importmodal.show(),root.off(_modal_events.default.shown),root.on(_modal_events.default.shown,(async function(){root.find(".modal-dialog").draggable({handle:".modal-header"}),_jquery.default.ajax({url:M.cfg.wwwroot+"/mod/interactivevideo/ajax.php",method:"POST",dataType:"text",data:{action:"get_taught_courses",sesskey:M.cfg.sesskey,contextid:M.cfg.contextid,userid:userid},success:function(data){let courses=JSON.parse(data);courses.sort(((a,b)=>a.fullname.localeCompare(b.fullname)));let courseSelect='<select class="'.concat(isBS5?"form":"custom",'-select w-100" id="importcourse">');courses.forEach((course=>{courseSelect+='<option value="'.concat(course.id,'">').concat(course.fullname," (").concat(course.shortname,")</option>")})),courseSelect+="</select>";let selectfield='<div class="iv-form-group selectcourse">\n                            <label class="iv-font-weight-bold form-label" for="importcourse">\n                            '.concat(M.util.get_string("selectcourse","mod_interactivevideo"),"</label>\n                            ").concat(courseSelect,"</div>");root.find(".modal-body").empty(),root.find(".modal-body").append(selectfield),root.find("#importcourse").val(course),root.find("#importcourse").trigger("change")}})})),root.on(_modal_events.default.hidden,(function(){importmodal.destroy()})),root.off("change","#importcourse"),root.on("change","#importcourse",(function(){root.find(".selectcm, .select-interaction").remove(),_jquery.default.ajax({url:M.cfg.wwwroot+"/mod/interactivevideo/ajax.php",method:"POST",dataType:"text",data:{action:"get_cm_by_courseid",sesskey:M.cfg.sesskey,contextid:M.cfg.contextid,courseid:(0,_jquery.default)(this).val()},success:function(data){let cms=JSON.parse(data);cms.sort(((a,b)=>a.name.localeCompare(b.name)));let cmSelect='<select class="'.concat(isBS5?"form":"custom",'-select w-100" id="importcm">\n                        <option value="">').concat(M.util.get_string("select","mod_interactivevideo"),"</option>");cms.forEach((cm=>{cmSelect+='<option value="'.concat(cm.id,'"\n                                 ').concat(cm.id==interaction?"disabled":"",">").concat(cm.name,"</option>")})),cmSelect+="</select>";let selectfield='<div class="iv-form-group selectcm">\n                        <label for="importcm" class="iv-font-weight-bold form-label">\n                        '.concat(M.util.get_string("selectactivity","mod_interactivevideo"),"</label>\n                        ").concat(cmSelect,"</div>");root.find(".selectcourse").after(selectfield)}})})),root.off("change","#importcm"),root.on("change","#importcm",(async function(){root.find(".select-interaction").remove(),root.find("#importcm").after('<div class="select-interaction py-3">\n                    <iframe src="'.concat(M.cfg.wwwroot+"/mod/interactivevideo/view.php?i="+(0,_jquery.default)(this).val(),'&embed=1&preview=1"\n                    frameborder=0 width="100%" height="500" class="loader"></iframe></div>'));let interactions=await _jquery.default.ajax({url:M.cfg.wwwroot+"/mod/interactivevideo/ajax.php",method:"POST",dataType:"text",data:{action:"get_items",sesskey:M.cfg.sesskey,id:(0,_jquery.default)(this).val(),contextid:M.cfg.contextid,coursecontextid:M.cfg.courseContextId}});if(interactions=JSON.parse(interactions),interactions=interactions.filter((x=>"skipsegment"!=x.type)),0==interactions.length)return void root.find(".select-interaction").append('<div class="alert alert-warning mt-3">\n                        '.concat(M.util.get_string("nocontent","mod_interactivevideo"),"</div>"));root.find(".select-interaction").append('<div class="input-group mb-1 w-100 flex-nowrap align-items-center\n                     no-pointer">\n                     <div class="input-group-prepend border-0 invisible">\n                            <label class="input-group-text bg-white">\n                                <input type="checkbox"/>\n                                <i class="bi bi-plus iv-ml-3 fs-unset"></i>\n                            </label>\n                        </div>\n                        <input type="text" class="form-control border-0 iv-font-weight-bold"\n                        value="'.concat(M.util.get_string("title","mod_interactivevideo"),'">\n                        <input type="text" class="form-control border-0 iv-font-weight-bold" style="max-width: 50px;"\n                        value="XP">\n                        <input type="text" style="max-width: 150px;"\n                         value="').concat(M.util.get_string("timestamp","mod_interactivevideo"),'"\n                        class="form-control border-0 iv-font-weight-bold"></div>')),interactions=interactions.map((int=>{const ctype=contentTypes.find((y=>y.name===int.type));return int.prop=JSON.stringify(ctype),int.icon=ctype.icon,(int.timestamp>end||int.timestamp<start)&&int.timestamp>0?int.outside=!0:int.outside=!1,!ctype.allowmultiple&&annotations.find((x=>x.type==int.type))&&(int.disabled=!0),int})),interactions.sort(((a,b)=>a.timestamp-b.timestamp));let inputs="";interactions.forEach((int=>{const inputgroup='<div class="input-group mb-1 w-100 flex-nowrap align-items-center"\n                        data-id="'.concat(int.id,'">\n                        <div class="input-group-prepend">\n                            <label class="input-group-text">\n                                <input type="checkbox" ').concat(int.disabled?"disabled":"",'/>\n                                <i class="').concat(int.icon,' iv-ml-3 fs-unset"></i>\n                            </label>\n                        </div>\n                        <input type="text" class="form-control name" ').concat(int.timestamp<0?"readonly":"",'\n                        value="').concat(int.title,'">\n                        <input type="text" style="max-width: 50px;" ').concat(int.timestamp<0||0==int.hascompletion?"readonly":"",'\n                        class="form-control xp" value="').concat(int.xp,'">\n                        <input type="text" placeholder="00:00:00" style="max-width: 150px;" ').concat(int.timestamp<0?"readonly":"",'\n                        class="form-control timestamp-input ').concat(int.outside?"is-invalid":"",'"\n                        value="').concat(int.timestamp<0?int.timestamp:convertSecondsToHMS(int.timestamp,!1,!1),'"></div>');inputs+=inputgroup})),root.find(".select-interaction").append(inputs),root.off("click","#importcontentbutton").on("click","#importcontentbutton",(async function(e){e.preventDefault();let $selected=root.find('.select-interaction input[type="checkbox"]:checked'),selectedInt=[];if($selected.each((function(){let $row=(0,_jquery.default)(this).closest(".input-group");const name=$row.find(".name").val();if(""==name.trim())return;let timestamp=$row.find(".timestamp-input").val();if(""==timestamp)return;if(Number(timestamp)<0)timestamp=Number(timestamp);else{const parts=timestamp.split(":");if(timestamp=3600*Number(parts[0])+60*Number(parts[1])+Number(parts[2]),annotations.find((x=>x.timestamp==timestamp)))return}let id=$row.data("id"),int=interactions.find((x=>x.id==id));int.title=name,int.timestamp=timestamp;let xp=Number($row.find(".xp").val());(isNaN(xp)||""==xp)&&(xp=0),int.xp=xp,selectedInt.push(int)})),0!=selectedInt.length){let interactions=await _jquery.default.ajax({url:M.cfg.wwwroot+"/mod/interactivevideo/ajax.php",method:"POST",dataType:"text",data:{action:"import_annotations",sesskey:M.cfg.sesskey,contextid:M.cfg.contextid,annotations:JSON.stringify(selectedInt),tocourse:M.cfg.courseId,fromcourse:(0,_jquery.default)("#importcourse").val(),tocm:interaction,fromcm:(0,_jquery.default)("#importcm").val(),module:coursemodule}});interactions=JSON.parse(interactions),importmodal.hide(),annotations=annotations.concat(interactions),(0,_event_dispatcher.dispatchEvent)("annotationupdated",{annotations:annotations,action:"import"}),interactions.forEach((int=>{int.allowmultiple||ctRenderer[int.type].init()}))}else addNotification(M.util.get_string("selectinteraction","mod_interactivevideo"),"danger")}))}))})),(0,_jquery.default)(document).on("keyup","#contentmodal #contentsearch",(function(){let search=(0,_jquery.default)(this).val().toLowerCase();(0,_jquery.default)("#addcontentdropdown .dropdown-item").removeClass("d-none").addClass("d-flex"),""!=search&&(0,_jquery.default)("#contentmodal #addcontentdropdown .dropdown-item").each((function(){(0,_jquery.default)(this).find(".contenttype-title").text().toLowerCase().includes(search)?(0,_jquery.default)(this).addClass("d-flex").removeClass("d-none"):(0,_jquery.default)(this).addClass("d-none").removeClass("d-flex")}))}));const fastforward=async e=>{let time=await player.getCurrentTime();time>=end||(e.ctrlKey||e.metaKey?time+=1:time+=.2,time>end&&(time=end),await player.seek(time))};let fastForwardInterval;(0,_jquery.default)(document).on("click","#fast-forward",(async function(e){e.preventDefault(),fastforward(e)})),(0,_jquery.default)(document).on("mousedown","#fast-forward",(async function(e){e.preventDefault(),fastForwardInterval=setInterval((async()=>{fastforward(e),await player.getCurrentTime()>=end&&clearInterval(fastForwardInterval)}),200)})),(0,_jquery.default)(document).on("mouseup mouseleave","#fast-forward",(function(){clearInterval(fastForwardInterval)}));const rewind=async e=>{let time=await player.getCurrentTime();time<=start||(e.ctrlKey||e.metaKey?time-=1:time-=.2,time<start&&(time=start),await player.seek(time))};let rewindInterval,ModalForm;(0,_jquery.default)(document).on("click","#rewind",(async function(e){e.preventDefault(),rewind(e)})),(0,_jquery.default)(document).on("mousedown","#rewind",(async function(e){e.preventDefault(),rewindInterval=setInterval((async()=>{rewind(e),await player.getCurrentTime()<=start&&clearInterval(rewindInterval)}),200)})),(0,_jquery.default)(document).on("mouseup mouseleave","#rewind",(function(){clearInterval(rewindInterval)})),window.addEventListener("beforeunload",(function(){(0,_jquery.default)(document).off(),cancelAnimationFrame(onPlayingInterval)})),(0,_jquery.default)(document).on("click","#annotation-list-bulk-edit",(async function(e){if(e.preventDefault(),document.body.focus(),(0,_jquery.default)(this).hasClass("active"))return(0,_jquery.default)("#annotation-list").find(".form-check").remove(),(0,_jquery.default)(this).removeClass("active"),(0,_jquery.default)("#annotation-list").find("tr").each((function(){(0,_jquery.default)(this).removeClass("b-active")})),(0,_jquery.default)("body").removeClass("iv-bulk-edit"),void(0,_jquery.default)("#annotation-list-bulk-checkall").addClass("d-none");(0,_jquery.default)(this).addClass("active"),(0,_jquery.default)("#annotation-list-bulk-checkall").removeClass("d-none active"),(0,_jquery.default)("body").addClass("iv-bulk-edit"),(0,_jquery.default)("#annotation-list").find("tr").each((function(){let id=(0,_jquery.default)(this).data("id"),type=(0,_jquery.default)(this).data("type");(0,_jquery.default)(this).find("td").first().find("div").prepend('<div class="form-check form-check-inline iv-mr-0">\n                        <input class="form-check-input" type="checkbox" data-type="'.concat(type,'" id="annotation-').concat(id,'" value="').concat(id,'">\n                        <label class="form-check-label" for="annotation-').concat(id,'"></label></div>'))}))})),(0,_jquery.default)(document).on("click","#annotation-list-bulk-checkall",(function(e){e.preventDefault();let check=!(0,_jquery.default)(this).hasClass("active");(0,_jquery.default)("tr.annotation .form-check-input").each((function(){(!(0,_jquery.default)(this).is(":checked")&&check||(0,_jquery.default)(this).is(":checked")&&!check)&&(0,_jquery.default)(this).trigger("click")})),(0,_jquery.default)(this).toggleClass("active")})),(0,_jquery.default)(document).on("click","tr.annotation .form-check-input",(function(e){e.stopImmediatePropagation(),(0,_jquery.default)(this).is(":checked")?(0,_jquery.default)(this).closest("tr").addClass("b-active"):(0,_jquery.default)(this).closest("tr").removeClass("b-active"),0==(0,_jquery.default)("#annotation-list").find("tr .form-check-input:checked").length?(0,_jquery.default)("#annotation-list-bulk .bulk-actions").hide():(0,_jquery.default)("#annotation-list-bulk .bulk-actions").show()})),(0,_jquery.default)(document).on("click","#annotation-list-bulk-delete",(async function(e){e.preventDefault();let ids=[],types=[];if((0,_jquery.default)("#annotation-list").find("tr .form-check-input:checked").each((function(){ids.push((0,_jquery.default)(this).val()),types.push((0,_jquery.default)(this).data("type"))})),0==ids.length)return;const promises=ids.map(((id,index)=>new Promise((resolve=>{let type=types[index];ctRenderer[type].deleteAnnotation(annotations,id,!0),resolve()}))));await Promise.all(promises),(0,_event_dispatcher.dispatchEvent)("annotationsdeleted",{annotations:this.annotations,ids:ids})})),(0,_jquery.default)(document).on("click","#annotation-list-bulk-copy",(async function(e){e.preventDefault();let copiedIds=(0,_jquery.default)("#annotation-list").find("tr .form-check-input:checked").map((function(){return(0,_jquery.default)(this).val()})).get();if(0==copiedIds.length)return;let copiedAnnotations=annotations.filter((x=>copiedIds.includes(x.id)));copiedAnnotations=copiedAnnotations.map((function(item){return item.wwwroot=M.cfg.wwwroot,item})),copiedAnnotations=JSON.stringify(copiedAnnotations),window.localStorage.setItem("copiedAnnotations",copiedAnnotations),(0,_jquery.default)("#annotation-list-bulk-paste").removeAttr("disabled"),(0,_jquery.default)("#annotation-list-bulk-paste").addClass("btn-primary"),(0,_jquery.default)("#annotation-list-bulk-paste").find("i").removeClass("bi-clipboard").addClass("bi-clipboard-fill"),addNotification(M.util.get_string("annotationscopied","mod_interactivevideo"),"success")})),(0,_jquery.default)(document).on("click","#annotation-list-bulk-download",(async function(e){e.preventDefault(),(0,_jquery.default)(this).attr("disabled","disabled"),(0,_jquery.default)(this).find("i").addClass("fa-spin fa-circle-o-notch fa").removeClass("bi bi-download");let downloadIds=(0,_jquery.default)("#annotation-list").find("tr .form-check-input:checked").map((function(){return(0,_jquery.default)(this).val()})).get();if(0==downloadIds.length)return;let copiedAnnotations=annotations.filter((x=>downloadIds.includes(x.id)));copiedAnnotations=copiedAnnotations.map((function(item){return item.wwwroot=M.cfg.wwwroot,item}));const downloadTask=await _jquery.default.ajax({url:M.cfg.wwwroot+"/mod/interactivevideo/ajax.php",method:"POST",dataType:"text",data:{action:"download_annotations",sesskey:M.cfg.sesskey,contextid:M.cfg.contextid,courseid:course,annotations:JSON.stringify(copiedAnnotations).replace(/</g,"&lt;").replace(/>/g,"&gt;"),cmid:coursemodule}});window.open(downloadTask,"_blank"),(0,_jquery.default)(this).removeAttr("disabled"),(0,_jquery.default)(this).find("i").removeClass("fa-spin fa-circle-o-notch fa").addClass("bi bi-download")})),(0,_jquery.default)(document).on("click","#annotation-list-bulk-setdefault",(async function(e){e.preventDefault();let selectedIds=(0,_jquery.default)("#annotation-list").find("tr .form-check-input:checked").map((function(){return(0,_jquery.default)(this).val()})).get();if(0==selectedIds.length)return;let selectedAnnotations=annotations.filter((x=>selectedIds.includes(x.id)));selectedAnnotations=selectedAnnotations.filter(((item,index,self)=>index===self.findIndex((t=>t.type===item.type)))),await _jquery.default.ajax({url:M.cfg.wwwroot+"/mod/interactivevideo/ajax.php",method:"POST",dataType:"text",data:{action:"set_defaults",sesskey:M.cfg.sesskey,contextid:M.cfg.contextid,courseid:course,defaults:JSON.stringify(selectedAnnotations)}}),(0,_jquery.default)("#annotation-list-bulk-edit").trigger("click"),addNotification(M.util.get_string("annotationssavedasdefaults","mod_interactivevideo"),"success")})),(0,_jquery.default)(document).on("click","#annotation-list-bulk-upload",(async function(e){e.preventDefault(),ModalForm||(ModalForm=await("function"==typeof _systemImportTransformerGlobalIdentifier.define&&_systemImportTransformerGlobalIdentifier.define.amd?new Promise((function(resolve,reject){_systemImportTransformerGlobalIdentifier.require(["core_form/modalform"],resolve,reject)})):"undefined"!=typeof module&&module.exports&&"undefined"!=typeof require||"undefined"!=typeof module&&module.component&&_systemImportTransformerGlobalIdentifier.require&&"component"===_systemImportTransformerGlobalIdentifier.require.loader?Promise.resolve(require("core_form/modalform")):Promise.resolve(_systemImportTransformerGlobalIdentifier["core_form/modalform"])));const data={contextid:M.cfg.contextid,id:coursemodule,courseid:course,annotationid:interaction,prevent:annotations.filter((x=>0==JSON.parse(x.prop).allowmultiple)).map((x=>x.type)).join(",")};let title=M.util.get_string("uploadannotations","mod_interactivevideo");const form=new ModalForm({modalConfig:{title:title},formClass:"mod_interactivevideo\\form\\bulk_upload_form",args:data});form.show(),form.addEventListener(form.events.FORM_SUBMITTED,(async e=>{let imported=e.detail.new;imported=imported.filter((x=>contentTypes.find((y=>y.name===x.type)))),annotations=annotations.concat(imported),(0,_event_dispatcher.dispatchEvent)("annotationupdated",{annotations:annotations,action:"import"})}))})),window.addEventListener("storage",(function(e){e.stopImmediatePropagation(),"copiedAnnotations"===e.key&&((0,_jquery.default)("#annotation-list-bulk-paste").removeAttr("disabled"),(0,_jquery.default)("#annotation-list-bulk-paste").addClass("btn-primary"),(0,_jquery.default)("#annotation-list-bulk-paste").find("i").removeClass("bi-clipboard").addClass("bi-clipboard-fill"))}));let copiedAnnotations=window.localStorage.getItem("copiedAnnotations");if(null!==copiedAnnotations){if(copiedAnnotations=JSON.parse(copiedAnnotations),copiedAnnotations[0].cmid==coursemodule)return;(0,_jquery.default)("#annotation-list-bulk-paste").removeAttr("disabled"),(0,_jquery.default)("#annotation-list-bulk-paste").addClass("btn-primary"),(0,_jquery.default)("#annotation-list-bulk-paste").find("i").removeClass("bi-clipboard").addClass("bi-clipboard-fill")}(0,_jquery.default)(document).on("click","#annotation-list-bulk-paste",(async function(e){e.preventDefault();let copiedAnnotations=window.localStorage.getItem("copiedAnnotations");if(null===copiedAnnotations)return;if(copiedAnnotations=JSON.parse(copiedAnnotations),copiedAnnotations=copiedAnnotations.filter((x=>{let allowmultiple=JSON.parse(x.prop).allowmultiple;return allowmultiple||!allowmultiple&&!annotations.find((y=>y.type==x.type))})),0==copiedAnnotations.length)return void addNotification(M.util.get_string("annotationscopied","mod_interactivevideo"),"danger");const fromCourse=copiedAnnotations[0].courseid,fromCm=copiedAnnotations[0].cmid,toCourse=course;fromCm==coursemodule&&(copiedAnnotations=copiedAnnotations.filter((a=>"skipsegment"!=a.type)).map((function(item){return item.timestamp>=0&&(item.timestamp=Number(item.timestamp)+.1,item.title=item.title+" ("+M.util.get_string("copynoun","mod_interactivevideo")+")"),item})));let interactions=await _jquery.default.ajax({url:M.cfg.wwwroot+"/mod/interactivevideo/ajax.php",method:"POST",dataType:"text",data:{action:"import_annotations",sesskey:M.cfg.sesskey,contextid:M.cfg.contextid,annotations:JSON.stringify(copiedAnnotations),tocourse:toCourse,fromcourse:fromCourse,tocm:interaction,fromcm:fromCm,module:coursemodule}});interactions=JSON.parse(interactions),annotations=annotations.concat(interactions),(0,_event_dispatcher.dispatchEvent)("annotationupdated",{annotations:annotations,action:"import"}),interactions.forEach((int=>{int.allowmultiple||ctRenderer[int.type].init()}))})),(0,_jquery.default)(document).on("annotationsdeleted",(function(e){const ids=e.originalEvent.detail.ids;ids.forEach((function(id){(0,_jquery.default)('tr[data-id="'.concat(id,'"]')).addClass("deleted")})),(0,_jquery.default)("#annotation-list-bulk-edit").trigger("click"),setTimeout((function(){annotations=annotations.filter((function(item){return!ids.includes(item.id)})),renderAnnotationItems(annotations),addNotification(M.util.get_string("interactionsdeleted","mod_interactivevideo",ids.length),"success")}),1e3)})),document.addEventListener("keydown",(async function(e){if("body"===document.activeElement.tagName.toLowerCase()&&!(0,_jquery.default)("body").hasClass("disablekb"))if("Space"===e.code)e.preventDefault(),await player.isPaused()?player.play():player.pause();else if("KeyA"!==e.code||e.ctrlKey||e.metaKey)if("ArrowRight"===e.code){e.preventDefault();let time=await player.getCurrentTime();if(time>=end||time+1>end)return;player.seek(time+1)}else if("ArrowLeft"===e.code){e.preventDefault();let time=await player.getCurrentTime();if(time<=start||time-1<start)return;player.seek(time-1)}else"KeyI"===e.code?(e.preventDefault(),(0,_jquery.default)("#importcontent").trigger("click")):"KeyX"===e.code?(e.preventDefault(),(0,_jquery.default)("#annotation-list-bulk-delete").trigger("click")):"KeyD"===e.code?(e.preventDefault(),(0,_jquery.default)("#annotation-list-bulk-download").trigger("click")):"KeyC"===e.code?(e.preventDefault(),(0,_jquery.default)("#annotation-list-bulk-copy").trigger("click")):"KeyP"===e.code?(e.preventDefault(),(0,_jquery.default)("#annotation-list-bulk-paste").trigger("click")):"KeyE"===e.code?(e.preventDefault(),(0,_jquery.default)("#annotation-list-bulk-edit").trigger("click")):"KeyA"===e.code&&(e.ctrlKey||e.metaKey)&&(0,_jquery.default)("#annotation-list-bulk-edit").hasClass("active")?(e.preventDefault(),(0,_jquery.default)("#annotation-list-bulk-checkall").trigger("click")):"KeyU"===e.code?(e.preventDefault(),(0,_jquery.default)("#annotation-list-bulk-upload").trigger("click")):"Equal"===e.code?(e.preventDefault(),(0,_jquery.default)("#zoomin").trigger("click")):"Minus"===e.code?(e.preventDefault(),(0,_jquery.default)("#zoomout").trigger("click")):"KeyS"===e.code&&(e.ctrlKey||e.metaKey)&&(e.preventDefault(),(0,_jquery.default)("#savedraft").trigger("click"));else e.preventDefault(),$addcontent.trigger("click")}))}};return _exports.default=_default,_exports.default}));

//# sourceMappingURL=editannotation.min.js.map